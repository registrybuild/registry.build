<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">UNMAINTAINED</h1><a id="user-content-unmaintained" class="anchor-element" aria-label="Permalink: UNMAINTAINED" href="#unmaintained"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Unfortunately we decided not to use Bazel, so these rules are effectively unmaintained. If someone would like to take ownership, please push a copy of the code somewhere, and I will be happy to link to it from here. Thanks for the interest!</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Bazel Python Zip Rules</h1><a id="user-content-bazel-python-zip-rules" class="anchor-element" aria-label="Permalink: Bazel Python Zip Rules" href="#bazel-python-zip-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This package is an alternative to Bazel's built-in Python rules that work with existing Python packages from PyPI. Eventually the built-in rules or <a href="https://github.com/bazelbuild/rules_python"><code>rules_python</code></a> should replace this, once Google improves them to work with external packages. Until then, these rules work for us.</p>
<p dir="auto">See the <a href="https://github.com/TriggerMail/rules_pyz_example">example project</a> for a tiny demonstration.</p>
<p dir="auto">We named this rules_pyz because originally it built a zip for every <code>pyz_binary</code> and <code>pyz_test</code>. We have since changed it so it only optionally builds a zip.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Using the rules</h2><a id="user-content-using-the-rules" class="anchor-element" aria-label="Permalink: Using the rules" href="#using-the-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Add the following lines to your <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# Load the dependencies required for the rules
git_repository(
    name = &quot;com_bluecore_rules_pyz&quot;,
    commit = &quot;eb2527d42664bc2dc4834ee54cb1bb94a1d08216&quot;,
    remote = &quot;https://github.com/TriggerMail/rules_pyz.git&quot;,
)

load(&quot;@com_bluecore_rules_pyz//rules_python_zip:rules_python_zip.bzl&quot;, &quot;pyz_repositories&quot;)

pyz_repositories()"><pre><span class="pl-c"># Load the dependencies required for the rules</span>
<span class="pl-en">git_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"com_bluecore_rules_pyz"</span>,
    <span class="pl-s1">commit</span> <span class="pl-c1">=</span> <span class="pl-s">"eb2527d42664bc2dc4834ee54cb1bb94a1d08216"</span>,
    <span class="pl-s1">remote</span> <span class="pl-c1">=</span> <span class="pl-s">"https://github.com/TriggerMail/rules_pyz.git"</span>,
)

<span class="pl-en">load</span>(<span class="pl-s">"@com_bluecore_rules_pyz//rules_python_zip:rules_python_zip.bzl"</span>, <span class="pl-s">"pyz_repositories"</span>)

<span class="pl-en">pyz_repositories</span>()</pre></div>
<p dir="auto">To each BUILD file where you want to use the rules, add:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@com_bluecore_rules_pyz//rules_python_zip:rules_python_zip.bzl&quot;,
    &quot;pyz_binary&quot;,
    &quot;pyz_library&quot;,
    &quot;pyz_test&quot;,
)"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@com_bluecore_rules_pyz//rules_python_zip:rules_python_zip.bzl"</span>,
    <span class="pl-s">"pyz_binary"</span>,
    <span class="pl-s">"pyz_library"</span>,
    <span class="pl-s">"pyz_test"</span>,
)</pre></div>
<p dir="auto">Instead of <code>py_*</code> rules, use <code>pyz_*</code>. They should work the same way. One notable difference is instead of <code>imports</code> to change the import path, you need to use the <code>pythonroot</code> attribute, which only applies to the <code>srcs</code> and <code>data</code> of that rule, and not all transitive dependencies.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">PyPI dependencies</h3><a id="user-content-pypi-dependencies" class="anchor-element" aria-label="Permalink: PyPI dependencies" href="#pypi-dependencies"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you want to import packages from PyPI, write a pip <code>requirements.txt</code> file, then:</p>
<ol dir="auto">
<li><code>mkdir -p third_party/pypi</code></li>
<li><code>mkdir wheels</code></li>
<li>Add the following lines to <code>third_party/pypi/BUILD</code>:
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;:pypi_rules.bzl&quot;, &quot;pypi_libraries&quot;)
pypi_libraries()"><pre><span class="pl-en">load</span>(<span class="pl-s">":pypi_rules.bzl"</span>, <span class="pl-s">"pypi_libraries"</span>)
<span class="pl-en">pypi_libraries</span>()</pre></div>
</li>
<li>Add the following lines to <code>WORKSPACE</code>:
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@com_bluecore_rules_pyz//pypi:pip.bzl&quot;, &quot;pip_repositories&quot;)
pip_repositories()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@com_bluecore_rules_pyz//pypi:pip.bzl"</span>, <span class="pl-s">"pip_repositories"</span>)
<span class="pl-en">pip_repositories</span>()</pre></div>
</li>
<li>Generate the dependencies using the tool:
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel build @com_bluecore_rules_pyz//pypi:pip_generate_wrapper
bazel-bin/external/com_bluecore_rules_pyz/pypi/pip_generate_wrapper \
    -requirements requirements.txt \
    -outputDir third_party/pypi \
    -wheelURLPrefix http://example.com/ \
    -wheelDir wheels"><pre>bazel build @com_bluecore_rules_pyz//pypi:pip_generate_wrapper
bazel-bin/external/com_bluecore_rules_pyz/pypi/pip_generate_wrapper \
    -requirements requirements.txt \
    -outputDir third_party/pypi \
    -wheelURLPrefix http://example.com/ \
    -wheelDir wheels</pre></div>
</li>
<li>If this depends on any Python packages that don't publish wheels, you will need to copy the <code>wheels</code> directory to some server where they are publicly accessible, and set the <code>-wheelURLPrefix</code> argument to that URL. We use a [Google Cloud Storage bucket](<a href="https://cloud.google.com/storage/docs/" rel="nofollow">https://cloud.google.com/storage/docs/</a>
access-public-data) and copy the wheels with: <code>gsutil -m rsync -a public-read wheels gs://public-bucket</code></li>
<li>Add the following lines to <code>WORKSPACE</code> to load the generate requirements:
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;//third_party/pypi:pypi_rules.bzl&quot;, &quot;pypi_repositories&quot;)
pypi_repositories()"><pre><span class="pl-en">load</span>(<span class="pl-s">"//third_party/pypi:pypi_rules.bzl"</span>, <span class="pl-s">"pypi_repositories"</span>)
<span class="pl-en">pypi_repositories</span>()</pre></div>
</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Local Wheels</h3><a id="user-content-local-wheels" class="anchor-element" aria-label="Permalink: Local Wheels" href="#local-wheels"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">As an alternative to publishing built wheels, you can check them in to your repository. If you omit the <code>wheelURLPrefix</code> flag, <code>pip_generate</code> will generate references relative to your WORKSPACE.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Motivation and problems with existing rules</h2><a id="user-content-motivation-and-problems-with-existing-rules" class="anchor-element" aria-label="Permalink: Motivation and problems with existing rules" href="#motivation-and-problems-with-existing-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Bluecore is experimenting with using Bazel because it offers two potential advantages over our existing environment:</p>
<ol dir="auto">
<li><em>Reproducible builds and tests between machines</em>: Today, we use a set of virtualenvs. When someone adds or removes an external dependency, or moves code between "packages", we need to manually run some scripts to build the virtualenvs. This is error prone, and a frequent cause of developer support issues.</li>
<li><em>Faster tests and CI by caching results</em>.</li>
<li><em>One tool for all languages</em>: Today our code is primarily Python and JavaScript, with a small amount of Go. As we grow the team, the code base, and add more tools, it would be nice if there was a single way to build and test everything.</li>
</ol>
<p dir="auto">The existing rules have a number of issues which interfere with these goals. In particular, we need to be able to consume packages published on PyPI. The existing rules have the following problems:</p>
<ul dir="auto">
<li>Namespace packages don't work correctly: <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="259574929" data-permission-text="Title is private" data-url="https://github.com/bazelbuild/rules_python/issues/14" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_python/issues/14/hovercard" href="https://github.com/bazelbuild/rules_python/issues/14">bazelbuild/rules_python#14</a></li>
<li>System-installed packages can be imported, causing dependency problems: <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="264797215" data-permission-text="Title is private" data-url="https://github.com/bazelbuild/rules_python/issues/27" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_python/issues/27/hovercard" href="https://github.com/bazelbuild/rules_python/issues/27">bazelbuild/rules_python#27</a></li>
</ul>
<p dir="auto">The <a href="https://github.com/benley/bazel_rules_pex">bazel_rules_pex rules</a> work pretty well for these cases. However, <code>pex</code> is very slow when packaging targets that have large third-party dependencies, since it unzips and rezips everything. These rules started as an exploration to understand why Pex is so slow, and eventually morphed into the rules as they are today.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Implementation overview</h2><a id="user-content-implementation-overview" class="anchor-element" aria-label="Permalink: Implementation overview" href="#implementation-overview"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">A Python "executable" is a directory tree of Python files, with an "entry point" module that is invoked as <code>__main__</code>. We want to be able to define executables with different sets of dependencies that possibly conflict (e.g. executable <code>foo</code> may want <code>example_module</code> to be imported, but executable <code>bar</code> may need <code>example_module</code> to not exist, or be a different version). To do this, we build a directory tree containing all dependencies, and generate a <code>__main__.py</code>. This makes the directory executable by either running <code>python executable_exedir</code> or <code>python executable_exedir/__main__.py</code>. To make this more convenient, we also generate a shell script to invoke python with the correct arguments.</p>
<p dir="auto">For example, if we have an executable named <code>executable</code>, which runs a script called <code>executable.py</code> that depends on <code>somepackage.module</code>, it will generate the following files:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="executable          (generated shell script: runs executable_exedir)
executable_exedir
├── executable.py
├── __main__.py     (generated main script: runs executable.py)
└── somepackage
    ├── __init__.py
    └── module.py"><pre class="notranslate"><code>executable          (generated shell script: runs executable_exedir)
executable_exedir
├── executable.py
├── __main__.py     (generated main script: runs executable.py)
└── somepackage
    ├── __init__.py
    └── module.py
</code></pre></div>
<p dir="auto">The <code>executable_exedir</code> can be zipped into a zip file with a <code>#!</code> interpreter line, so it can be directly executed. This may introduce incompatibilities: many Python programs depend on reading resource files relative to their source files which fails when loaded from a zip. By default for maximum compatibility, the <code>__main__.py</code> will unzip everything into a temporary directory, execute that, then delete it at execute. You can set <code>zip_safe=True</code> on the <code>pyz_binary</code> to override this behaviour. At build time, if any native code libraries are detected, the rules write a manifest (<code>_zip_info_.json</code>) that instructs <code>__main__.py</code> to unpack these files because they cannot be loaded from a zip.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Creating an "isolated" Python environment</h3><a id="user-content-creating-an-isolated-python-environment" class="anchor-element" aria-label="Permalink: Creating an &quot;isolated&quot; Python environment" href="#creating-an-isolated-python-environment"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">We want executables generated by these rules to be "isolated": They should only rely on the system Python interpreter and the standard library. Any custom packages or environment variables should be ignored, so running the program always works. It turns out this is tricky: If the default <code>python</code> binary is part of a virtual environment for example, in behaves slightly differently than a "normal" Python interpreter. Users may have added <code>.pth</code> files to their <code>site-packages</code> directory to customize their environment. To resolve this, <code>__main__.py</code> tries very hard to establish a "clean" environment, which complicates the startup code.</p>
<p dir="auto">To do it, we execute <code>__main__.py</code> with the Python flags <code>-E -S -s</code> which ignores <code>PYTHON*</code> environment variables, and does not load <code>site-packages</code>. Unfortunately, to execute a zip, Python needs the <code>runpy</code> module which is in <code>site-packages</code>. Additionally, people might explicitly execute <code>python ..._exedir</code> or <code>python ..._exedir/__main__.py</code>. In those cases, if we find the <code>site</code> module, we re-execute Python with the correct flags, to ensure the program sees a clean environment.</p>
<p dir="auto">TODO: pex has code to clean the <code>sys.modules</code> which we should borrow at some point, since it avoids re-executing Python which decreases startup overhead.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Bazel implementation: Runfiles</h3><a id="user-content-bazel-implementation-runfiles" class="anchor-element" aria-label="Permalink: Bazel implementation: Runfiles" href="#bazel-implementation-runfiles"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To make tests run quickly in Bazel, it is best to not copy files into an <code>_exedir</code>. Instead, we build the <code>_exedir</code> in the Bazel <code>.runfiles</code> directory using symlinks. This makes incremental changes much faster. As a disadvantage, it causes some slightly different paths than when things are packaged directly into a zip.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Unscientific comparison</h2><a id="user-content-unscientific-comparison" class="anchor-element" aria-label="Permalink: Unscientific comparison" href="#unscientific-comparison"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>Modify a Python test file:
<ul dir="auto">
<li><code>bazel_rules_pex</code>: 5.252s total: 2.686s to package the pex; 2.533s to run the test</li>
<li><code>rules_pyz</code>: ~2.278s to run the test (no rebuild needed: test srcs not packaged)</li>
</ul>
</li>
<li>Modify a lib file dependeded on by a Python test:
<ul dir="auto">
<li><code>bazel_rules_pex</code>: 5.276s total: 2.621s to package the pex; 2.624s to run the test</li>
<li><code>rules_pyz</code>: 0.112s to pack the dependencies; 2.180s to run the test</li>
</ul>
</li>
<li>Package numpy and scipy with a main that imports scipy
<ul dir="auto">
<li><code>pex</code>: 9.5s ; time to run: first time: 1.3s; next times: 0.4s</li>
<li><code>simplepack</code>: 0.6s; time to run: 0.5s</li>
</ul>
</li>
</ol>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Notes</h2><a id="user-content-notes" class="anchor-element" aria-label="Permalink: Notes" href="#notes"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="http://python-notes.curiousefficiency.org/en/latest/python_concepts/import_traps.html" rel="nofollow">http://python-notes.curiousefficiency.org/en/latest/python_concepts/import_traps.html</a></li>
</ul>
</article></div>