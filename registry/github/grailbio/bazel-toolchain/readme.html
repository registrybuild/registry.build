<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">LLVM toolchain for Bazel <a href="https://github.com/bazel-contrib/toolchains_llvm/actions/workflows/tests.yml"><img src="https://github.com/bazel-contrib/toolchains_llvm/actions/workflows/tests.yml/badge.svg" alt="Tests" style="max-width: 100%;"></a></h1><a id="user-content-llvm-toolchain-for-bazel-" class="anchor" aria-label="Permalink: LLVM toolchain for Bazel " href="#llvm-toolchain-for-bazel-"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Quickstart</h2><a id="user-content-quickstart" class="anchor" aria-label="Permalink: Quickstart" href="#quickstart"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See notes on the <a href="https://github.com/bazel-contrib/toolchains_llvm/releases">release</a>
for how to get started.</p>
<p dir="auto">NOTE: For releases prior to 0.10.1, please also see <a href="REPO_RENAME.md">these notes</a>.</p>

<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Basic Usage</h2><a id="user-content-basic-usage" class="anchor" aria-label="Permalink: Basic Usage" href="#basic-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The toolchain can automatically detect your OS and arch type, and use the right
pre-built binary LLVM distribution. See the section on "Bring Your Own LLVM"
below for more options.</p>
<p dir="auto">See in-code documentation in <a href="toolchain/rules.bzl">rules.bzl</a> for available
attributes to <code>llvm_toolchain</code>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Advanced Usage</h2><a id="user-content-advanced-usage" class="anchor" aria-label="Permalink: Advanced Usage" href="#advanced-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Per host architecture LLVM version</h3><a id="user-content-per-host-architecture-llvm-version" class="anchor" aria-label="Permalink: Per host architecture LLVM version" href="#per-host-architecture-llvm-version"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">LLVM does not come with distributions for all host architectures in each
version. In particular patch versions often come with few prebuilt packages.
This means that a single version probably is not enough to address all hosts
one wants to support.</p>
<p dir="auto">This can be solved by providing a target/version map with a default version.
The example below selects <code>15.0.6</code> as the default version for all targets not
specified explicitly. This is like providing <code>llvm_version = "15.0.6"</code>, just
like in the example on the top. However, here we provide two more entries that
map their respective target to a distinct version:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="llvm_toolchain(
    name = &quot;llvm_toolchain&quot;,
    llvm_versions = {
        &quot;&quot;: &quot;15.0.6&quot;,
        &quot;darwin-aarch64&quot;: &quot;15.0.7&quot;,
        &quot;darwin-x86_64&quot;: &quot;15.0.7&quot;,
    },
)"><pre lang="starlark" class="notranslate"><code>llvm_toolchain(
    name = "llvm_toolchain",
    llvm_versions = {
        "": "15.0.6",
        "darwin-aarch64": "15.0.7",
        "darwin-x86_64": "15.0.7",
    },
)
</code></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Customizations</h3><a id="user-content-customizations" class="anchor" aria-label="Permalink: Customizations" href="#customizations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">We currently offer limited customizability through attributes of the
<a href="toolchain/rules.bzl">llvm_toolchain_* rules</a>. You can send us a PR to add
more configuration attributes.</p>
<p dir="auto">The <code>MODULE.bazel</code> example below demonstrates how to add new LLVM distributions before the toolchain has
been updated. They can easily be computed using the provided checksum tool (see <code>llvm_checksums.sh -h</code>).</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="llvm = use_extension(&quot;@toolchains_llvm//toolchain/extensions:llvm.bzl&quot;, &quot;llvm&quot;, dev_dependency = True)
llvm.toolchain(
    name = &quot;llvm_toolchain&quot;,
    llvm_version = &quot;20.1.4&quot;,
    extra_llvm_distributions = {
        &quot;LLVM-20.1.4-Linux-ARM64.tar.xz&quot;: &quot;4de80a332eecb06bf55097fd3280e1c69ed80f222e5bdd556221a6ceee02721a&quot;,
        &quot;LLVM-20.1.4-Linux-X64.tar.xz&quot;: &quot;113b54c397adb2039fa45e38dc8107b9ec5a0baead3a3bac8ccfbb65b2340caa&quot;,
        &quot;LLVM-20.1.4-macOS-ARM64.tar.xz&quot;: &quot;debb43b7b364c5cf864260d84ba1b201d49b6460fe84b76eaa65688dfadf19d2&quot;,
        &quot;clang+llvm-20.1.4-x86_64-pc-windows-msvc.tar.xz&quot;: &quot;2b12ac1a0689e29a38a7c98c409cbfa83f390aea30c60b7a06e4ed73f82d2457&quot;,
    },
)"><pre lang="starlark" class="notranslate"><code>llvm = use_extension("@toolchains_llvm//toolchain/extensions:llvm.bzl", "llvm", dev_dependency = True)
llvm.toolchain(
    name = "llvm_toolchain",
    llvm_version = "20.1.4",
    extra_llvm_distributions = {
        "LLVM-20.1.4-Linux-ARM64.tar.xz": "4de80a332eecb06bf55097fd3280e1c69ed80f222e5bdd556221a6ceee02721a",
        "LLVM-20.1.4-Linux-X64.tar.xz": "113b54c397adb2039fa45e38dc8107b9ec5a0baead3a3bac8ccfbb65b2340caa",
        "LLVM-20.1.4-macOS-ARM64.tar.xz": "debb43b7b364c5cf864260d84ba1b201d49b6460fe84b76eaa65688dfadf19d2",
        "clang+llvm-20.1.4-x86_64-pc-windows-msvc.tar.xz": "2b12ac1a0689e29a38a7c98c409cbfa83f390aea30c60b7a06e4ed73f82d2457",
    },
)
</code></pre></div>
<p dir="auto">The following <code>WORKSPACE</code> snippet shows how to add a specific version for a specific target before
the version was added to <a href="toolchain/internal/llvm_distributions.bzl">llvm_distributions.bzl</a>.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="llvm_toolchain(
    name = &quot;llvm_toolchain&quot;,
    llvm_version = &quot;19.1.6&quot;,
    sha256 = {&quot;linux-x86_64&quot;: &quot;d55dcbb309de7ade4e3073ec3ac3fac4d3ff236d54df3c4de04464fe68bec531&quot;},
    strip_prefix = {
        &quot;linux-x86_64&quot;: &quot;LLVM-19.1.6-Linux-X64&quot;,
    },
    urls = {
        &quot;linux-x86_64&quot;: [
            &quot;https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.6/LLVM-19.1.6-Linux-X64.tar.xz&quot;,
        ],
    },
)"><pre lang="starlark" class="notranslate"><code>llvm_toolchain(
    name = "llvm_toolchain",
    llvm_version = "19.1.6",
    sha256 = {"linux-x86_64": "d55dcbb309de7ade4e3073ec3ac3fac4d3ff236d54df3c4de04464fe68bec531"},
    strip_prefix = {
        "linux-x86_64": "LLVM-19.1.6-Linux-X64",
    },
    urls = {
        "linux-x86_64": [
            "https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.6/LLVM-19.1.6-Linux-X64.tar.xz",
        ],
    },
)
</code></pre></div>
<p dir="auto">A majority of the complexity of this project is to make it generic for multiple
use cases. For one-off experiments with new architectures, cross-compilations,
new compiler features, etc., my advice would be to look at the toolchain
configurations generated by this repo, and copy-paste/edit to make your own in
any package in your own workspace.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel query --output=build @llvm_toolchain//:all | grep -v -e '^#' -e '^  generator'"><pre lang="sh" class="notranslate"><code>bazel query --output=build @llvm_toolchain//:all | grep -v -e '^#' -e '^  generator'
</code></pre></div>
<p dir="auto">Besides defining your toolchain in your package BUILD file, and until this
<a href="https://github.com/bazelbuild/bazel/issues/7746" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/bazel/issues/7746/hovercard">issue</a> is resolved, you would
also need a way for bazel to access the tools in LLVM distribution as relative
paths from your package without using <code>..</code> up-references. For this, you can
create a symlink that uses up-references to point to the LLVM distribution
directory, and also create a wrapper script for clang such that the actual
clang invocation is not through the symlinked path. See the files in the
<code>@llvm_toolchain//:</code> package as a reference.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# See generated files for reference.
ls -lR &quot;$(bazel info output_base)/external/llvm_toolchain&quot;

# Create symlink to LLVM distribution.
cd _your_package_directory_
ln -s ../....../external/llvm_toolchain_llvm llvm

# Create CC wrapper script.
mkdir bin
cp &quot;$(bazel info output_base)/external/llvm_toolchain/bin/cc_wrapper.sh&quot; bin/cc_wrapper.sh
vim bin/cc_wrapper.sh # Review to ensure relative paths, etc. are good."><pre lang="sh" class="notranslate"><code># See generated files for reference.
ls -lR "$(bazel info output_base)/external/llvm_toolchain"

# Create symlink to LLVM distribution.
cd _your_package_directory_
ln -s ../....../external/llvm_toolchain_llvm llvm

# Create CC wrapper script.
mkdir bin
cp "$(bazel info output_base)/external/llvm_toolchain/bin/cc_wrapper.sh" bin/cc_wrapper.sh
vim bin/cc_wrapper.sh # Review to ensure relative paths, etc. are good.
</code></pre></div>
<p dir="auto">See <a href="https://docs.bazel.build/versions/main/tutorial/cc-toolchain-config.html" rel="nofollow">bazel
tutorial</a>
for how CC toolchains work in general.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Requirements</h3><a id="user-content-requirements" class="anchor" aria-label="Permalink: Requirements" href="#requirements"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Version attributes can be requirements of the form <code>first</code>, <code>first:&lt;condition&gt;</code>,
<code>latest</code> or <code>latest:&lt;condition&gt;</code>.</p>
<p dir="auto">In case of <code>latest</code>, the latest distribution matching the optional <code>condition</code>
will be selected.</p>
<p dir="auto">In case of <code>first</code>, the first distribution matching the optional <code>condition</code>
will be selected.</p>
<p dir="auto">The condition consists of a comma separated list of semver version comparisons
supporting <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>==</code>, <code>!=</code>. Examples:</p>
<ul dir="auto">
<li><code>latest</code></li>
<li><code>latest:&gt;=20.1.0</code></li>
<li><code>latest:&gt;17.0.4,!=19.1.7,&lt;=20.1.0</code></li>
<li><code>first:&gt;=15.0.6,&lt;16</code></li>
</ul>
<p dir="auto">It is further possible to provide the version or requirement from an environment
variable with a fallback version or requirement. In this case it is important to
also use the bazel flag <code>--repo_env=LLVM_VERSION=version_or_requirement</code>. It is
important to use both correctly because otherwise the resulting builds are not
reproducible. The main purpose of using an environment variable to encode the
version for integration or batch testing on multiple platforms where multiple
LLVM versions should be tested.</p>
<ul dir="auto">
<li><code>getenv(ENVIRONMENT_VARIABLE_NAME,fallback)</code></li>
</ul>
<p dir="auto">Example <code>MODULE.bazel</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="llvm.toolchain(
    name = &quot;llvm_toolchain&quot;,
    llvm_versions = {
        &quot;&quot;: &quot;getenv(LLVM_VERSION,latest:&gt;=17.0.0,&lt;20)&quot;,
        &quot;darwin-x86_64&quot;: &quot;15.0.7&quot;,  # Verify this works as opposed to using one version.
    },
)"><pre lang="starlark" class="notranslate"><code>llvm.toolchain(
    name = "llvm_toolchain",
    llvm_versions = {
        "": "getenv(LLVM_VERSION,latest:&gt;=17.0.0,&lt;20)",
        "darwin-x86_64": "15.0.7",  # Verify this works as opposed to using one version.
    },
)
</code></pre></div>
<p dir="auto">In this example, MacOS x86 machines have their LLVM version hard-coded to
<code>15.0.7</code>. For all other targets the LLVM version is read from the environment
variable <code>LLVM_VERSION</code> which must be referenced on the Bazel command line as
explained above. If the variable is not present, then the LLVM version defaults
to the requirement expression <code>latest:&gt;=17.0.0,&lt;20</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Selecting Toolchains</h3><a id="user-content-selecting-toolchains" class="anchor" aria-label="Permalink: Selecting Toolchains" href="#selecting-toolchains"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If toolchains are registered (see Quickstart section above), you do not need to
do anything special for bazel to find the toolchain. You may want to check once
with the <code>--toolchain_resolution_debug</code> flag to see which toolchains were
selected by bazel for your target platform.</p>
<p dir="auto">For specifying unregistered toolchains on the command line, please use the
<code>--extra_toolchains</code> flag. For example,
<code>--extra_toolchains=@llvm_toolchain//:cc-toolchain-x86_64-linux</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Bring Your Own LLVM</h3><a id="user-content-bring-your-own-llvm" class="anchor" aria-label="Permalink: Bring Your Own LLVM" href="#bring-your-own-llvm"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The following mechanisms are available for using an LLVM toolchain:</p>
<ol dir="auto">
<li>Host OS information is used to find the right pre-built binary distribution
from llvm.org, given the <code>llvm_version</code> or <code>llvm_versions</code> attribute. The
LLVM toolchain archive is downloaded and extracted as a separate repository
with the suffix <code>_llvm</code>. The detection logic for <code>llvm_version</code> is not
perfect, so you may have to use <code>llvm_versions</code> for some host OS type and
versions. We expect the detection logic to grow through community
contributions. We welcome PRs.</li>
<li>You can use the <code>urls</code> attribute to specify your own URLs for each OS type,
version and architecture. For example, you can specify a different URL for
Arch Linux and a different one for Ubuntu. Just as with the option above,
the archive is downloaded and extracted as a separate repository with the
suffix <code>_llvm</code>.</li>
<li>You can also specify your own bazel package paths or local absolute paths
for each host os-arch pair through the <code>toolchain_roots</code> attribute (without
bzlmod) or the <code>toolchain_root</code> module extension tags (with bzlmod). Note
that the keys here are different and less granular than the keys in the <code>urls</code>
attribute. When using a bazel package path, each of the values is typically
a package in the user's workspace or configured through <code>local_repository</code> or
<code>http_archive</code>; the BUILD file of the package should be similar to
<code>@toolchains_llvm//toolchain:BUILD.llvm_repo</code>. If using only
<code>http_archive</code>, maybe consider using the <code>urls</code> attribute instead to get more
flexibility if you need.</li>
<li>All the above options rely on host OS information, and are not suited for
docker based sandboxed builds or remote execution builds. Such builds will
need a single distribution version specified through the <code>distribution</code>
attribute, or URLs specified through the <code>urls</code> attribute with an empty key, or
a toolchain root specified through the <code>toolchain_roots</code> attribute with an
empty key.</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Sysroots</h3><a id="user-content-sysroots" class="anchor" aria-label="Permalink: Sysroots" href="#sysroots"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">A sysroot can be specified through the <code>sysroot</code> attribute (without bzlmod) or
the <code>sysroot</code> module extension tag (with bzlmod). This can be either a path on
the user's system, or a bazel <code>filegroup</code> like label. One way to create a
sysroot is to use <code>docker export</code> to get a single archive of the entire
filesystem for the image you want. Another way is to use the build scripts
provided by the <a href="https://chromium.googlesource.com/chromium/src/+/HEAD/docs/linux/sysroot.md" rel="nofollow">Chromium
project</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Cross-compilation</h3><a id="user-content-cross-compilation" class="anchor" aria-label="Permalink: Cross-compilation" href="#cross-compilation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The toolchain supports cross-compilation if you bring your own sysroot. When
cross-compiling, we link against the libstdc++ from the sysroot
(single-platform build behavior is to link against libc++ bundled with LLVM).
The following pairs have been tested to work for some hello-world binaries:</p>
<ul dir="auto">
<li>{linux, x86_64} -&gt; {linux, aarch64}</li>
<li>{linux, aarch64} -&gt; {linux, x86_64}</li>
<li>{darwin, x86_64} -&gt; {linux, x86_64}</li>
<li>{darwin, x86_64} -&gt; {linux, aarch64}</li>
</ul>
<p dir="auto">A recommended approach would be to define two toolchains, one without sysroot
for single-platform builds, and one with sysroot for cross-compilation builds.
Then, when cross-compiling, explicitly specify the toolchain with the sysroot
and the target platform. For example, see the <a href="tests/MODULE.bazel">MODULE.bazel</a>
file for <code>llvm_toolchain_with_sysroot</code> and the <a href="tests/scripts/run_xcompile_tests.sh">test
script</a> for cross-compilation.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel build \
  --platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_toolchains=@llvm_toolchain_with_sysroot//:cc-toolchain-x86_64-linux \
  //..."><pre lang="sh" class="notranslate"><code>bazel build \
  --platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_toolchains=@llvm_toolchain_with_sysroot//:cc-toolchain-x86_64-linux \
  //...
</code></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Multi-platform builds</h3><a id="user-content-multi-platform-builds" class="anchor" aria-label="Permalink: Multi-platform builds" href="#multi-platform-builds"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The toolchain supports multi-platform builds through the combination of the
<code>exec_os</code>, <code>exec_arch</code> attribute pair, and either the <code>distribution</code> attribute,
or the <code>urls</code> attribute. This allows one to run their builds on one platform
(e.g. macOS) and their build actions to run on another (e.g. Linux), enabling
remote build execution (RBE). For example, see the <a href="tests/MODULE.bazel">MODULE.bazel</a>
file for <code>llvm_toolchain_linux_exec</code> and the <a href="tests/scripts/run_docker_exec_test.sh">test
script</a> for running the build actions on
Linux even if the build is being run from macOS.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel build \
  --platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_execution_platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_toolchains=@llvm_toolchain_linux_exec//:cc-toolchain-x86_64-linux \
  //..."><pre lang="sh" class="notranslate"><code>bazel build \
  --platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_execution_platforms=@toolchains_llvm//platforms:linux-x86_64 \
  --extra_toolchains=@llvm_toolchain_linux_exec//:cc-toolchain-x86_64-linux \
  //...
</code></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Supporting New Target Platforms</h3><a id="user-content-supporting-new-target-platforms" class="anchor" aria-label="Permalink: Supporting New Target Platforms" href="#supporting-new-target-platforms"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The following is a rough (untested) list of steps:</p>
<ol dir="auto">
<li>To help us detect if you are cross-compiling or not, note the arch string as
given by <code>python3 -c 'import platform; print(platform.machine())</code>.</li>
<li>Edit <code>SUPPORTED_TARGETS</code> in
<a href="toolchain/internal/common.bzl">toolchain/internal/common.bzl</a> with the os
and the arch string from above.</li>
<li>Add <code>target_system_name</code>, etc. in
<a href="toolchain/cc_toolchain_config.bzl">toolchain/cc_toolchain_config.bzl</a>.</li>
<li>For cross-compiling, add a <code>platform</code> bazel type for your target platform in
<a href="platforms/BUILD.bazel">platforms/BUILD.bazel</a>, and add an appropriate
sysroot entry to your <code>llvm_toolchain</code> repository definition.</li>
<li>If not cross-compiling, bring your own LLVM (see section above) through the
<code>toolchain_roots</code> or <code>urls</code> attribute.</li>
<li>Test your build.</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Sandbox</h3><a id="user-content-sandbox" class="anchor" aria-label="Permalink: Sandbox" href="#sandbox"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Sandboxing the toolchain introduces a significant overhead (100ms per action,
as of mid 2018). To overcome this, one can use
<code>--experimental_sandbox_base=/dev/shm</code>. However, not all environments might
have enough shared memory available to load all the files in memory. If this is
a concern, you may set the attribute for using absolute paths, which will
substitute templated paths to the toolchain as absolute paths. When running
bazel actions, these paths will be available from inside the sandbox as part of
the / read-only mount. Note that this will make your builds non-hermetic.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Compatibility</h3><a id="user-content-compatibility" class="anchor" aria-label="Permalink: Compatibility" href="#compatibility"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The toolchain is tested to work with <code>rules_go</code>, <code>rules_rust</code>, and
<code>rules_foreign_cc</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Accessing tools</h3><a id="user-content-accessing-tools" class="anchor" aria-label="Permalink: Accessing tools" href="#accessing-tools"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The LLVM distribution also provides several tools like <code>clang-format</code>. You can
depend on these tools directly in the bin directory of the distribution. When
not using the <code>toolchain_roots</code> attribute, the distribution is available in the
repo with the suffix <code>_llvm</code> appended to the name you used for the
<code>llvm_toolchain</code> rule. For example, <code>@llvm_toolchain_llvm//:bin/clang-format</code>
is a valid and visible target in the quickstart example above.</p>
<p dir="auto">When using the <code>toolchain_roots</code> attribute, there is currently no single target
that you can reference, and you may have to alias the tools you want with a
<code>select</code> clause in your workspace.</p>
<p dir="auto">As a convenience, some targets are aliased appropriately in the configuration
repo (as opposed to the LLVM distribution repo) for you to use and will work
even when using <code>toolchain_roots</code>. The complete list is in the file
<a href="toolchain/aliases.bzl">aliases.bzl</a>. If your repo is named <code>llvm_toolchain</code>,
then they can be referenced as:</p>
<ul dir="auto">
<li><code>@llvm_toolchain//:omp</code></li>
<li><code>@llvm_toolchain//:clang-format</code></li>
<li><code>@llvm_toolchain//:llvm-cov</code></li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Strict header deps (Linux only)</h3><a id="user-content-strict-header-deps-linux-only" class="anchor" aria-label="Permalink: Strict header deps (Linux only)" href="#strict-header-deps-linux-only"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The toolchain supports Bazel's <code>layering_check</code> feature, which relies on
<a href="https://clang.llvm.org/docs/Modules.html" rel="nofollow">Clang modules</a> to implement strict
deps (also known as "depend on what you use") for <code>cc_*</code> rules. This feature
can be enabled by enabling the <code>layering_check</code> feature on a per-target,
per-package or global basis.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Prior Art</h2><a id="user-content-prior-art" class="anchor" aria-label="Permalink: Prior Art" href="#prior-art"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Other examples of toolchain configuration:</p>
<p dir="auto"><a href="https://bazel.build/tutorials/ccp-toolchain-config" rel="nofollow">https://bazel.build/tutorials/ccp-toolchain-config</a></p>
<p dir="auto"><a href="https://github.com/vsco/bazel-toolchains">https://github.com/vsco/bazel-toolchains</a></p>
</article></div>