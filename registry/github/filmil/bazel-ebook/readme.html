<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/filmil/bazel-ebook/workflows/Build/badge.svg"><img src="https://github.com/filmil/bazel-ebook/workflows/Build/badge.svg" alt="Build Status" style="max-width: 100%;"></a></p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Introduction</h1><a id="user-content-introduction" class="anchor" aria-label="Permalink: Introduction" href="#introduction"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This repository is a set of <a href="https://bazel.io" rel="nofollow">bazel</a> build rules that allow you to write
a moderately complex book in the Markdown text format, and produce EPUB and
Kindle's MOBI formats from them.  You can also produce a PDF format book, which
allows you to preview the results slightly more convenient than by reading the
resulting books.</p>
<p dir="auto">The build rules currently support pure Markdown formatting, LaTeX-style
equations (though not cross-referencing, and in general the amount of
LaTeX supported is somewhat limited).</p>
<blockquote>
<p dir="auto">This is not an officially supported Google product.  Even though Google owns
the copyright. I just happened to work there while I worked on this tool.</p>
</blockquote>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Prerequisites</h1><a id="user-content-prerequisites" class="anchor" aria-label="Permalink: Prerequisites" href="#prerequisites"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="https://bazel.io" rel="nofollow">bazel</a>, for building.</li>
<li><a href="https://docker.io" rel="nofollow">docker</a>, because part of the bazel build process needs
docker</li>
</ul>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Quick start</h1><a id="user-content-quick-start" class="anchor" aria-label="Permalink: Quick start" href="#quick-start"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you are impatient to see the rules in action, check out an example book in a
separate <a href="https://www.github.com/filmil/ebook-example">ebook example github repository</a>.</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Defined build rules</h1><a id="user-content-defined-build-rules" class="anchor" aria-label="Permalink: Defined build rules" href="#defined-build-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The build rules are defined in the file <a href="build/rules.bzl">build/rules.bzl</a>.  A
quick list is here:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Rule</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>asymptote(name, srcs, deps)</code></td>
<td>This build rule converts <a href="https://asymptote.sourceforge.io" rel="nofollow">Asymptote</a> source files into images that can be included in the book. This rule can take any <code>*.asy</code> file in <code>srcs</code> and can depend on any <code>asymptote</code> rule in <code>deps</code>.</td>
</tr>
<tr>
<td><code>markdown_lib(name, srcs, deps)</code></td>
<td>This build rule makes a library out of <code>*/md</code> files.  <code>deps</code> may be any <code>markdown_lib</code> or <code>asymptote</code> or other such rule, and those will be used correctly.</td>
</tr>
<tr>
<td><code>ebook_epub(name, deps, metadata_xml, title_yaml)</code></td>
<td>This build rule assembles all <code>markdown_lib</code> rules in sequece and produces a book named <code>[name].epub</code></td>
</tr>
<tr>
<td><code>ebook_kindle(name, deps, metadata_xmp, title_yaml)</code></td>
<td>This build rule assembles all <code>markdown_lib</code> rules in sequence and produces a book named <code>[name].mobi</code></td>
</tr>
<tr>
<td><code>ebook_pdf(name, deps, metadata_xmp, title_yaml)</code></td>
<td>This build rule assembles all <code>markdown_lib</code> rules in sequence and produces a book named <code>[name].pdf</code></td>
</tr>
<tr>
<td>dot_png(name, srcs, deps)</td>
<td>This build rule converts a <a href="https://graphviz.org" rel="nofollow">Graphviz</a> source files into PNG images that can be included in the book.  This rule can take any <code>*.dot</code> file in <code>srcs</code> and can depend on any rule in <code>deps</code>. The <code>.dot</code> file is laid out using the graphviz program <code>dot</code>.</td>
</tr>
<tr>
<td>neato_png(name, srcs, deps)</td>
<td>This build rule converts a <a href="https://graphviz.org" rel="nofollow">Graphviz</a> source files into PNG images that can be included in the book.  This rule can take any <code>*.dot</code> file in <code>srcs</code> and can depend on any rule in <code>deps</code>. The <code>.dot</code> file is laid out using the graphviz program <code>neato</code>.</td>
</tr>
<tr>
<td>plantuml_png(name, srcs, deps)</td>
<td>This build rule converts a <a href="https://plantuml.com" rel="nofollow">PlantUML</a> source files into PNG images that can be included in the book.  This rule can take any PlantUML-formatted <code>*.txt</code> file in <code>srcs</code> and can depend on any rule in <code>deps</code>.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Underlying software</h1><a id="user-content-underlying-software" class="anchor" aria-label="Permalink: Underlying software" href="#underlying-software"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">These build rules, of course, only explain to bazel how the ebook is to be
built.  The actual workhorses for building are, in order, <a href="https://www.docker.io" rel="nofollow">Docker</a>,
<a href="https://www.pandoc.org" rel="nofollow">pandoc</a>, <a href="https://calibre-ebook.com" rel="nofollow">calibre</a>, <a href="https://www.latex-project.org" rel="nofollow">LaTeX</a>, <a href="https://graphviz.org" rel="nofollow">Graphviz</a>,
<a href="https://asymptote.sourceforge.io" rel="nofollow">Asymptote</a>, and <a href="https://plantuml.com" rel="nofollow">PlantUML</a>.</p>
<p dir="auto">These software packages are quite complex, and their installation can also be
quite challenging.  As I wanted to work around that complication, I devised a
way to package all this software into a <a href="https://hub.docker.com/repository/docker/filipfilmar/ebook-buildenv" rel="nofollow">buildenv container</a> and then
invoke each in a special command for each action inside a custom docker
container.</p>
<p dir="auto">This means, if you can ensure that your computer has <code>docker</code> and <code>bazel</code>
installed, you don't need to worry about installing any other additional
software!  Everything else, <code>bazel</code> will pull for you from the Internet.</p>
<p dir="auto">I am kind of proud of the way this was done, and you can see some more detail
in the script <a href="build/docker_run.sh">docker_run.sh</a>.</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Limitations</h1><a id="user-content-limitations" class="anchor" aria-label="Permalink: Limitations" href="#limitations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">There are a few constraints to note however:</p>
<ol dir="auto">
<li>
<p dir="auto">Sadly, the way bazel sandboxes things puts some limitations on what rules
can be included where.  The general rule is, if you have a build rule in a
directory <code>X</code> you can mention only rules that are in <code>X</code> itself, or a
subdirectory of <code>X</code>, like <code>X/dir</code>, or <code>X/dir1/dir2</code>.  It is not possible to
refer to <code>X/dir1:rule</code> from <code>X/dir2:rule</code>.</p>
</li>
<li>
<p dir="auto">The build rules pull the container <a href="https://hub.docker.com/repository/docker/filipfilmar/ebook-buildenv" rel="nofollow">filipfilmar/ebook-buildenv</a>
from the Internet.  While I know what is inside (and you can check the
intended contents in <a href="docker/">docker/</a>), it's still your build system
downloading random stuff from the Internet and running on your machine.  This
may be OK for you to the extent that you trust me to provide you with the
software that I tell you I'm providing.</p>
<p dir="auto">In case this doesn't fulfill your trust criteria, you are of course free to
fork this repository, and use your own buildenv, since all the recipes are
there.</p>
<p dir="auto">Another possibility, which has been left for some future, is to add the
container build and upload recipes to these rules, so that you can choose to
build and use your own container easily.</p>
</li>
<li>
<p dir="auto">As currently written, the rules probably only work on Linux, which is the
same platform as my dev box.  It should in principle be possible to rig the
build rules so that they do the correct thing cross-platform, but I don't
have an immediate plan to do so, as long as the rules satisfy my own needs.</p>
</li>
</ol>
</article></div>