<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">bazel_jar_jar</h1><a id="user-content-bazel_jar_jar" class="anchor" aria-label="Permalink: bazel_jar_jar" href="#bazel_jar_jar"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">JarJar rules for <a href="https://bazel.build/" rel="nofollow">Bazel</a> (rename packages and classes in existing jars)</p>
<p dir="auto">This rule uses <a href="https://github.com/eed3si9n/jarjar-abrams">Jar Jar Abrams</a>, whose repo also maintains a forked/vendored Jar Jar Links.
The main use case is to use more than one version of a jar at a time with different versions mapped to a different package. It can also be used to do <a href="https://softwareengineering.stackexchange.com/questions/297276/what-is-a-shaded-java-dependency" rel="nofollow"><em>dependency shading</em></a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">How to add to Bazel via <code>MODULE.bazel</code></h2><a id="user-content-how-to-add-to-bazel-via-modulebazel" class="anchor" aria-label="Permalink: How to add to Bazel via MODULE.bazel" href="#how-to-add-to-bazel-via-modulebazel"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;bazel_jar_jar&quot;, version = &quot;0.1.0&quot;) # Latest version as of 2023/10/31"><pre><span class="pl-en">bazel_dep</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"bazel_jar_jar"</span>, <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"0.1.0"</span>) <span class="pl-c"># Latest version as of 2023/10/31</span></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">How to add to Bazel via <code>WORKSPACE</code></h2><a id="user-content-how-to-add-to-bazel-via-workspace" class="anchor" aria-label="Permalink: How to add to Bazel via WORKSPACE" href="#how-to-add-to-bazel-via-workspace"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:git.bzl&quot;, &quot;git_repository&quot;)

git_repository(
    name = &quot;com_github_johnynek_bazel_jar_jar&quot;,
    commit = &quot;4e7bf26da8bc8c955578fd8c8a2c763757d344df&quot;, # Latest commit SHA as of 2023/10/31
    remote = &quot;https://github.com/johnynek/bazel_jar_jar.git&quot;,
)

load(
    &quot;@com_github_johnynek_bazel_jar_jar//:jar_jar.bzl&quot;,
    &quot;jar_jar_repositories&quot;,
)
jar_jar_repositories()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:git.bzl"</span>, <span class="pl-s">"git_repository"</span>)

<span class="pl-en">git_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"com_github_johnynek_bazel_jar_jar"</span>,
    <span class="pl-s1">commit</span> <span class="pl-c1">=</span> <span class="pl-s">"4e7bf26da8bc8c955578fd8c8a2c763757d344df"</span>, <span class="pl-c"># Latest commit SHA as of 2023/10/31</span>
    <span class="pl-s1">remote</span> <span class="pl-c1">=</span> <span class="pl-s">"https://github.com/johnynek/bazel_jar_jar.git"</span>,
)

<span class="pl-en">load</span>(
    <span class="pl-s">"@com_github_johnynek_bazel_jar_jar//:jar_jar.bzl"</span>,
    <span class="pl-s">"jar_jar_repositories"</span>,
)
<span class="pl-en">jar_jar_repositories</span>()</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage for a single jar</h2><a id="user-content-usage-for-a-single-jar" class="anchor" aria-label="Permalink: Usage for a single jar" href="#usage-for-a-single-jar"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<blockquote>
<p dir="auto"><em>Note</em>: Example code exists in <a href="/test/example"><code>test/example</code></a></p>
</blockquote>
<p dir="auto">Specify a rule in a file that will remap one package path into another. For example:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="rule com.twitter.scalding.** foo.@1"><pre class="notranslate"><code>rule com.twitter.scalding.** foo.@1
</code></pre></div>
<blockquote>
<p dir="auto"><em>Note</em>: See <a href="#rules-file-formatting">Rules File Formatting</a> for formatting details</p>
</blockquote>
<p dir="auto">Put that file in the same directory as the Bazel <code>BUILD</code> file that will specify the <code>jar_jar</code> rules. Reference that file in the <code>rules</code> field of the <code>jar_jar</code> rule.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="jar_jar(
    name = &quot;shaded_args&quot;,
    input_jar = &quot;@com_twitter_scalding_args//jar&quot;,
    rules = &quot;&lt;FILENAME&gt;&quot;
)"><pre class="notranslate"><code>jar_jar(
    name = "shaded_args",
    input_jar = "@com_twitter_scalding_args//jar",
    rules = "&lt;FILENAME&gt;"
)
</code></pre></div>
<p dir="auto">The <code>input_jar</code> specifies the package that will be relocated. <code>name</code> is the target label to be used in place of the original package target label.
The optional <code>output_jar</code> field specifies the name of the output jar. If not specified, the output jar will be named <code>&lt;name&gt;.jar</code>.</p>
<p dir="auto">Alternately, if you don't want to put the rules in a file, you can put the shading rules inline directly in the rule.  These follow the same
<a href="#rules-file-formatting">rules file formatting</a> as below, with each entry in the array acting as a line in the file.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="jar_jar(
    name = &quot;shaded_args&quot;,
    input_jar = &quot;@com_twitter_scalding_args//jar&quot;,
    inline_rules = [&quot;rule com.twitter.scalding.** foo.@1&quot;]"><pre class="notranslate"><code>jar_jar(
    name = "shaded_args",
    input_jar = "@com_twitter_scalding_args//jar",
    inline_rules = ["rule com.twitter.scalding.** foo.@1"]
</code></pre></div>
<p dir="auto"><code>inline_rules</code> and <code>rules</code> referring to a file are exclusive options; you can only have one or the other in your rule.  You must have one of them.</p>
<p dir="auto">Make sure to change any references in your code from the original package path to the new shaded package path. For example: <code>import com.twitter.scalding.Args</code> becomes <code>import foo.Args</code>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Aspect usage</h2><a id="user-content-aspect-usage" class="anchor" aria-label="Permalink: Aspect usage" href="#aspect-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In addition to building a single output jar, there is also an aspect that can be used in your own custom rules to
transform a large graph, or the thin_jar_jar rule. This has the added benefit of per-rule caching, which can be considerably more efficient in large repos.
See the <code>thin_jar_jar.bzl</code> rule and the <code>test/jar_jar_apect</code> for an example of setting this up.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Rules File Formatting</h2><a id="user-content-rules-file-formatting" class="anchor" aria-label="Permalink: Rules File Formatting" href="#rules-file-formatting"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Rules file format
The rules file is a text file, one rule per line. Leading and trailing whitespace is ignored. There are three types of rules:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="rule &lt;pattern&gt; &lt;result&gt;
zap &lt;pattern&gt;
keep &lt;pattern&gt;"><pre class="notranslate"><code>rule &lt;pattern&gt; &lt;result&gt;
zap &lt;pattern&gt;
keep &lt;pattern&gt;
</code></pre></div>
<p dir="auto">The standard rule (rule) is used to rename classes. All references to the renamed classes will also be updated. If a class name is matched by more than one rule, only the first one will apply.</p>
<p dir="auto"><code>&lt;pattern&gt;</code> is a class name with optional wildcards. <code>**</code> will match against any valid class name substring. To match a single package component (by excluding . from the match), a single * may be used instead.</p>
<p dir="auto"><code>&lt;result&gt;</code> is a class name which can optionally reference the substrings matched by the wildcards. A numbered reference is available for every <code>*</code> or <code>**</code> in the <code>&lt;pattern&gt;</code>, starting from left to right: <code>@1</code>, <code>@2</code>, etc. A special <code>@0</code> reference contains the entire matched class name.</p>
<p dir="auto">The zap rule causes any matched class to be removed from the resulting jar file. All zap rules are processed before renaming rules.</p>
<p dir="auto">The keep rule marks all matched classes as "roots". If any keep rules are defined all classes which are not reachable from the roots via dependency analysis are discarded when writing the output jar. This is the last step in the process, after renaming and zapping.</p>
</article></div>