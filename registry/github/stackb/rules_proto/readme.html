<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto"><code>rules_proto (v3)</code></h1><a id="user-content-rules_proto-v3" class="anchor" aria-label="Permalink: rules_proto (v3)" href="#rules_proto-v3"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/stackb/rules_proto/actions/workflows/ci.yaml/badge.svg"><img src="https://github.com/stackb/rules_proto/actions/workflows/ci.yaml/badge.svg" alt="build-status" style="max-width: 100%;"></a>
<a href="https://pkg.go.dev/github.com/stackb/rules_proto" rel="nofollow"><img src="https://camo.githubusercontent.com/ccff158950464f67b22f43ea72a2ad1cadaf9440f050e965755d11d761307514/68747470733a2f2f706b672e676f2e6465762f62616467652f6769746875622e636f6d2f737461636b622f72756c65735f70726f746f2e737667" alt="Go Reference" data-canonical-src="https://pkg.go.dev/badge/github.com/stackb/rules_proto.svg" style="max-width: 100%;"></a></p>
<p dir="auto">Bazel starlark rules for building protocol buffers +/- gRPC âœ¨.</p>
<markdown-accessiblity-table><table border="0">
  <tbody><tr>
    <td><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/0a765666d48172e853b837a64f537ccf584720f0e24db87bcf0747ec33242639/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f656e2f7468756d622f372f37642f42617a656c5f6c6f676f2e7376672f3139323070782d42617a656c5f6c6f676f2e7376672e706e67"><img src="https://camo.githubusercontent.com/0a765666d48172e853b837a64f537ccf584720f0e24db87bcf0747ec33242639/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f656e2f7468756d622f372f37642f42617a656c5f6c6f676f2e7376672f3139323070782d42617a656c5f6c6f676f2e7376672e706e67" height="120" data-canonical-src="https://upload.wikimedia.org/wikipedia/en/thumb/7/7d/Bazel_logo.svg/1920px-Bazel_logo.svg.png" style="max-width: 100%; height: auto; max-height: 120px;"></a></td>
    <td><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/50580/141892423-5205bbfd-8487-442b-81c7-f56fa3d1f69e.jpeg"><img src="https://user-images.githubusercontent.com/50580/141892423-5205bbfd-8487-442b-81c7-f56fa3d1f69e.jpeg" height="120" style="max-width: 100%; height: auto; max-height: 120px;"></a></td>
    <td><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/50580/141900696-bfb2d42d-5d2c-46f8-bd9f-06515969f6a2.png"><img src="https://user-images.githubusercontent.com/50580/141900696-bfb2d42d-5d2c-46f8-bd9f-06515969f6a2.png" height="120" style="max-width: 100%; height: auto; max-height: 120px;"></a></td>
    <td><a target="_blank" rel="noopener noreferrer nofollow" href="https://avatars2.githubusercontent.com/u/7802525?v=4&amp;s=400"><img src="https://avatars2.githubusercontent.com/u/7802525?v=4&amp;s=400" height="120" style="max-width: 100%; height: auto; max-height: 120px;"></a></td>
  </tr>
  <tr>
    <td>bazel</td>
    <td>gazelle</td>
    <td>protobuf</td>
    <td>grpc</td>
  </tr>
</tbody></table></markdown-accessiblity-table>
<p dir="auto"><code>@build_stack_rules_proto</code> provides:</p>
<ol dir="auto">
<li>Rules for driving the <code>protoc</code> tool within a bazel workspace.</li>
<li>A <a href="https://github.com/bazelbuild/bazel-gazelle/">gazelle</a> extension that
generates rules based on the content of your <code>.proto</code> files.</li>
<li>A repository rule that runs gazelle in an external workspace.</li>
<li>Example setups for a variety of languages.</li>
</ol>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Table of Contents</h1><a id="user-content-table-of-contents" class="anchor" aria-label="Permalink: Table of Contents" href="#table-of-contents"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="#rules_proto-v3"><code>rules_proto (v3)</code></a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#getting-started">Getting Started</a>
<ul dir="auto">
<li><a href="#workspace-boilerplate"><code>WORKSPACE</code> Boilerplate</a></li>
<li><a href="#gazelle-setup">Gazelle Setup</a></li>
<li><a href="#gazelle-configuration">Gazelle Configuration</a>
<ul dir="auto">
<li><a href="#build-directives">Build Directives</a></li>
<li><a href="#yaml-configuration">YAML Configuration</a></li>
</ul>
</li>
<li><a href="#running-gazelle">Running Gazelle</a></li>
<li><a href="#build-rules">Build Rules</a>
<ul dir="auto">
<li><a href="#proto_compile">proto_compile</a></li>
<li><a href="#proto_plugin">proto_plugin</a></li>
<li><a href="#proto_compiled_sources">proto_compiled_sources</a></li>
<li><a href="#proto_compile_assets">proto_compile_assets</a></li>
<li><a href="#the-output_mappings-attribute">The <code>output_mappings</code> attribute</a></li>
</ul>
</li>
<li><a href="#repository-rules">Repository Rules</a></li>
<li><a href="#proto_repository">proto_repository</a></li>
<li><a href="#proto_gazelle">proto_gazelle</a></li>
<li><a href="#golden_filegroup">golden_filegroup</a></li>
<li><a href="#plugin-implementations">Plugin Implementations</a></li>
<li><a href="#rule-implementations">Rule Implementations</a></li>
</ul>
</li>
<li><a href="#writing-custom-plugins-and-rules">Writing Custom Plugins and Rules</a>
<ul dir="auto">
<li><a href="#--of-golang-implementations">+/- of golang implementations</a></li>
<li><a href="#--of-starlark-implementations">+/- of starlark implementations</a></li>
</ul>
</li>
<li><a href="#history">History</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Getting Started</h1><a id="user-content-getting-started" class="anchor" aria-label="Permalink: Getting Started" href="#getting-started"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>WORKSPACE</code> Boilerplate</h2><a id="user-content-workspace-boilerplate" class="anchor" aria-label="Permalink: WORKSPACE Boilerplate" href="#workspace-boilerplate"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

# Release: v3.1.0
# TargetCommitish: master
# Date: 2024-02-13 05:53:39 +0000 UTC
# URL: https://github.com/stackb/rules_proto/releases/tag/v3.1.0
# Size: 1995581 (2.0 MB)
http_archive(
    name = &quot;build_stack_rules_proto&quot;,
    sha256 = &quot;ee7a11d66e7bbc5b0f7a35ca3e960cb9a5f8a314b22252e19912dfbc6e22782d&quot;,
    strip_prefix = &quot;rules_proto-3.1.0&quot;,
    urls = [&quot;https://github.com/stackb/rules_proto/archive/v3.1.0.tar.gz&quot;],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c"># Release: v3.1.0</span>
<span class="pl-c"># TargetCommitish: master</span>
<span class="pl-c"># Date: 2024-02-13 05:53:39 +0000 UTC</span>
<span class="pl-c"># URL: https://github.com/stackb/rules_proto/releases/tag/v3.1.0</span>
<span class="pl-c"># Size: 1995581 (2.0 MB)</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"build_stack_rules_proto"</span>,
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"ee7a11d66e7bbc5b0f7a35ca3e960cb9a5f8a314b22252e19912dfbc6e22782d"</span>,
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_proto-3.1.0"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/stackb/rules_proto/archive/v3.1.0.tar.gz"</span>],
)</pre></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="register_toolchains(&quot;@build_stack_rules_proto//toolchain:standard&quot;)"><pre><span class="pl-en">register_toolchains</span>(<span class="pl-s">"@build_stack_rules_proto//toolchain:standard"</span>)</pre></div>
<blockquote>
<p dir="auto">This prepares <code>protoc</code> for the <code>proto_compile</code> rule. For simple setups,
consider <code>@build_stack_rules_proto//toolchain:prebuilt</code> to skip compilation of
the tool.</p>
</blockquote>
<blockquote>
<p dir="auto"><strong>NOTE</strong>: if you are planning on hand-writing your <code>BUILD.bazel</code> rules
yourself (not using the gazelle build file generator), <strong>STOP HERE</strong>. You'll
need to provide typical proto dependencies such as <code>@rules_proto</code> and
<code>@com_google_protobuf</code> (use macros below if desired), but no additional core
dependencies are needed at this point.</p>
</blockquote>
<hr>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//deps:core_deps.bzl&quot;, &quot;core_deps&quot;)

core_deps()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//deps:core_deps.bzl"</span>, <span class="pl-s">"core_deps"</span>)

<span class="pl-en">core_deps</span>()</pre></div>
<blockquote>
<p dir="auto">This brings in <code>@io_bazel_rules_go</code>, <code>@bazel_gazelle</code>, and <code>@rules_proto</code> if
you don't already have them.</p>
</blockquote>
<blockquote>
<p dir="auto">The gazelle extension and associated golang dependencies are optional; you can
write <code>proto_compile</code> and other derived rules by hand. For gazelle support,
carry on.</p>
</blockquote>
<hr>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@io_bazel_rules_go//go:deps.bzl&quot;,
    &quot;go_register_toolchains&quot;,
    &quot;go_rules_dependencies&quot;,
)

go_rules_dependencies()

go_register_toolchains(version = &quot;1.18.2&quot;)"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_go//go:deps.bzl"</span>,
    <span class="pl-s">"go_register_toolchains"</span>,
    <span class="pl-s">"go_rules_dependencies"</span>,
)

<span class="pl-en">go_rules_dependencies</span>()

<span class="pl-en">go_register_toolchains</span>(<span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"1.18.2"</span>)</pre></div>
<blockquote>
<p dir="auto">Standard biolerplate for <code>@io_bazel_rules_go</code>.</p>
</blockquote>
<hr>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load( &quot;@bazel_gazelle//:deps.bzl&quot;, &quot;gazelle_dependencies&quot;)

gazelle_dependencies()"><pre><span class="pl-en">load</span>( <span class="pl-s">"@bazel_gazelle//:deps.bzl"</span>, <span class="pl-s">"gazelle_dependencies"</span>)

<span class="pl-en">gazelle_dependencies</span>()</pre></div>
<blockquote>
<p dir="auto">Standard boilerplate for <code>@bazel_gazelle</code>.</p>
</blockquote>
<hr>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//:go_deps.bzl&quot;, &quot;gazelle_protobuf_extension_go_deps&quot;)

gazelle_protobuf_extension_go_deps()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//:go_deps.bzl"</span>, <span class="pl-s">"gazelle_protobuf_extension_go_deps"</span>)

<span class="pl-en">gazelle_protobuf_extension_go_deps</span>()</pre></div>
<blockquote>
<p dir="auto">This brings in <code>@com_github_emicklei_proto</code>.
<a href="https://github.com/emicklei/proto">github.com/emicklei/proto</a> is used by the
gazelle extension to parse proto files.</p>
</blockquote>
<hr>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//deps:protobuf_core_deps.bzl&quot;, &quot;protobuf_core_deps&quot;)

protobuf_core_deps()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//deps:protobuf_core_deps.bzl"</span>, <span class="pl-s">"protobuf_core_deps"</span>)

<span class="pl-en">protobuf_core_deps</span>()</pre></div>
<blockquote>
<p dir="auto">This brings in <code>@com_google_protobuf</code> and friends if you don't already have
them.</p>
</blockquote>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Gazelle Setup</h2><a id="user-content-gazelle-setup" class="anchor" aria-label="Permalink: Gazelle Setup" href="#gazelle-setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_gazelle//:def.bzl&quot;, &quot;gazelle&quot;, &quot;gazelle_binary&quot;)

gazelle_binary(
    name = &quot;gazelle-protobuf&quot;,
    languages = [
        &quot;@bazel_gazelle//language/go&quot;,
        &quot;@bazel_gazelle//language/proto&quot;,
        # must be after the proto extension (order matters)
        &quot;@build_stack_rules_proto//language/protobuf&quot;,
    ],
)

gazelle(
    name = &quot;gazelle&quot;,
    gazelle = &quot;:gazelle-protobuf&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_gazelle//:def.bzl"</span>, <span class="pl-s">"gazelle"</span>, <span class="pl-s">"gazelle_binary"</span>)

<span class="pl-en">gazelle_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gazelle-protobuf"</span>,
    <span class="pl-s1">languages</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"@bazel_gazelle//language/go"</span>,
        <span class="pl-s">"@bazel_gazelle//language/proto"</span>,
        <span class="pl-c"># must be after the proto extension (order matters)</span>
        <span class="pl-s">"@build_stack_rules_proto//language/protobuf"</span>,
    ],
)

<span class="pl-en">gazelle</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gazelle"</span>,
    <span class="pl-s1">gazelle</span> <span class="pl-c1">=</span> <span class="pl-s">":gazelle-protobuf"</span>,
)</pre></div>
<blockquote>
<p dir="auto">The gazelle setup is typically placed in the root <code>BUILD.bazel</code> file.</p>
</blockquote>
<hr>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Gazelle Configuration</h2><a id="user-content-gazelle-configuration" class="anchor" aria-label="Permalink: Gazelle Configuration" href="#gazelle-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The gazelle extension can be configured using "build directives" and/or a YAML
file.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Build Directives</h3><a id="user-content-build-directives" class="anchor" aria-label="Permalink: Build Directives" href="#build-directives"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Gazelle is configured by special comments in BUILD files called <em>directives</em>.</p>
<blockquote>
<p dir="auto">Gazelle works by visiting each package in your workspace; configuration is
done "on the way in" whereas actual rule generation is done "on the way out".
Gazelle configuration of a subdirectory inherits that from its parents. As
such, directives placed in the root <code>BUILD.bazel</code> file apply to the entire
workspace.</p>
</blockquote>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# gazelle:proto_rule proto_compile implementation stackb:rules_proto:proto_compile

# gazelle:proto_plugin cpp implementation builtin:cpp
# gazelle:proto_plugin protoc-gen-grpc-cpp implementation grpc:grpc:cpp

# gazelle:proto_rule proto_cc_library implementation stackb:rules_proto:proto_cc_library
# gazelle:proto_rule proto_cc_library deps @com_google_protobuf//:protobuf
# gazelle:proto_rule proto_cc_library visibility //visibility:public
# gazelle:proto_rule grpc_cc_library implementation stackb:rules_proto:grpc_cc_library
# gazelle:proto_rule grpc_cc_library deps @com_github_grpc_grpc//:grpc++
# gazelle:proto_rule grpc_cc_library deps @com_github_grpc_grpc//:grpc++_reflection
# gazelle:proto_rule grpc_cc_library visibility //visibility:public

# gazelle:proto_language cpp plugin cpp
# gazelle:proto_language cpp plugin protoc-gen-grpc-cpp
# gazelle:proto_language cpp rule proto_compile
# gazelle:proto_language cpp rule proto_cc_library
# gazelle:proto_language cpp rule grpc_cc_library"><pre><span class="pl-c"># gazelle:proto_rule proto_compile implementation stackb:rules_proto:proto_compile</span>

<span class="pl-c"># gazelle:proto_plugin cpp implementation builtin:cpp</span>
<span class="pl-c"># gazelle:proto_plugin protoc-gen-grpc-cpp implementation grpc:grpc:cpp</span>

<span class="pl-c"># gazelle:proto_rule proto_cc_library implementation stackb:rules_proto:proto_cc_library</span>
<span class="pl-c"># gazelle:proto_rule proto_cc_library deps @com_google_protobuf//:protobuf</span>
<span class="pl-c"># gazelle:proto_rule proto_cc_library visibility //visibility:public</span>
<span class="pl-c"># gazelle:proto_rule grpc_cc_library implementation stackb:rules_proto:grpc_cc_library</span>
<span class="pl-c"># gazelle:proto_rule grpc_cc_library deps @com_github_grpc_grpc//:grpc++</span>
<span class="pl-c"># gazelle:proto_rule grpc_cc_library deps @com_github_grpc_grpc//:grpc++_reflection</span>
<span class="pl-c"># gazelle:proto_rule grpc_cc_library visibility //visibility:public</span>

<span class="pl-c"># gazelle:proto_language cpp plugin cpp</span>
<span class="pl-c"># gazelle:proto_language cpp plugin protoc-gen-grpc-cpp</span>
<span class="pl-c"># gazelle:proto_language cpp rule proto_compile</span>
<span class="pl-c"># gazelle:proto_language cpp rule proto_cc_library</span>
<span class="pl-c"># gazelle:proto_language cpp rule grpc_cc_library</span></pre></div>
<p dir="auto">Let's unpack this a bit:</p>
<ul dir="auto">
<li><code>gazelle:proto_plugin cpp implementation builtin:cpp</code> associates the name
<code>cpp</code> with a piece of golang code that implements the <code>protoc.Plugin</code>
interface. The extension maintains a registry of these actors (the gazelle
extension ships with a number of them out of the box, but you can also write
your own). The core responsibility a <code>protoc.Plugin</code> implementation is to to
<em>predict</em> the files that a protoc plugin tool will generate for an individual
<code>proto_library</code> rule. The implemention has full read access to the
<code>protoc.File</code>s in the <code>proto_library</code> to be able to predict <em>if</em> a file will
be generated and <em>where</em> it will appear in the filesystem (specifically,
relative to the bazel execution root during a <code>proto_compile</code> action).</li>
<li><code>gazelle:proto_rule proto_compile implementation stackb:rules_proto:proto_compile</code>
associates the name <code>proto_compile</code> with a piece of golang code that
implements the <code>protoc.LanguageRule</code> interface. The extension maintains a
registry of rule implementations. Similarly, the extension ships with a bunch
of them out of the box, but you can write your own custom rules as well. The
core responsibility a <code>protoc.LanguageRule</code> implementation is construct a
gazelle <code>rule.Rule</code> based upon a <code>proto_library</code> rule and the set of plugins
that are configured with it.</li>
<li><code>gazelle:proto_language cpp plugin cpp</code> instantiates a <code>protoc.LanguageConfig</code>
having the name <code>cpp</code> and adds the <code>cpp</code> plugin to it. The language
configuration bundles bundles plugins and rules together.</li>
<li><code>gazelle:proto_rule grpc_cc_library deps @com_github_grpc_grpc//:grpc++</code>
configures the rule such that all generated rules will have that dependency.</li>
</ul>
<blockquote>
<p dir="auto"><strong>+/- intent modifiers</strong>. Although not pictured in this example, many of the
directives take an <em>intent modifier</em> to turn configuration on/off. For
example, if you wanted to suppress the grpc c++ plugin in the package
<code>//proto/javaapi</code>, put a directive like
<code>gazelle:proto_language cpp rule -grpc_cc_library</code> in
<code>proto/javaapi/BUILD.bazel</code> (note the <code>-</code> symbol preceding the name). To
suppress the language entirely, use
<code>gazelle:proto_language cpp enabled false</code>.</p>
</blockquote>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">YAML Configuration</h3><a id="user-content-yaml-configuration" class="anchor" aria-label="Permalink: YAML Configuration" href="#yaml-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You can also configure the extension using a YAML file. This is semantically
similar to adding gazelle directives to the root <code>BUILD</code> file; the YAML
configuration applies to all downstream packages. The equivalent YAML config for
the above directives looks like:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="plugins:
  - name: cpp
    implementation: builtin:cpp
  - name: protoc-gen-grpc-cpp
    implementation: grpc:grpc:cpp
rules:
  - name: proto_compile
    implementation: stackb:rules_proto:proto_compile
    visibility:
      -  //visibility:public
  - name: proto_cc_library
    implementation: stackb:rules_proto:proto_cc_library
    visibility:
      -  //visibility:public
    deps:
      - &quot;@com_google_protobuf//:protobuf&quot;
  - name: grpc_cc_library
    implementation: stackb:rules_proto:grpc_cc_library
    visibility:
      -  //visibility:public
    deps:
      - &quot;@com_github_grpc_grpc//:grpc++&quot;
      - &quot;@com_github_grpc_grpc//:grpc++_reflection&quot;
languages:
  - name: &quot;cpp&quot;
    plugins:
      - cpp
      - protoc-gen-grpc-cpp
    rules:
      - proto_compile
      - proto_cc_library
      - grpc_cc_library"><pre><span class="pl-ent">plugins</span>:
  - <span class="pl-ent">name</span>: <span class="pl-s">cpp</span>
    <span class="pl-ent">implementation</span>: <span class="pl-s">builtin:cpp</span>
  - <span class="pl-ent">name</span>: <span class="pl-s">protoc-gen-grpc-cpp</span>
    <span class="pl-ent">implementation</span>: <span class="pl-s">grpc:grpc:cpp</span>
<span class="pl-ent">rules</span>:
  - <span class="pl-ent">name</span>: <span class="pl-s">proto_compile</span>
    <span class="pl-ent">implementation</span>: <span class="pl-s">stackb:rules_proto:proto_compile</span>
    <span class="pl-ent">visibility</span>:
      -  <span class="pl-s">//visibility:public</span>
  - <span class="pl-ent">name</span>: <span class="pl-s">proto_cc_library</span>
    <span class="pl-ent">implementation</span>: <span class="pl-s">stackb:rules_proto:proto_cc_library</span>
    <span class="pl-ent">visibility</span>:
      -  <span class="pl-s">//visibility:public</span>
    <span class="pl-ent">deps</span>:
      - <span class="pl-s"><span class="pl-pds">"</span>@com_google_protobuf//:protobuf<span class="pl-pds">"</span></span>
  - <span class="pl-ent">name</span>: <span class="pl-s">grpc_cc_library</span>
    <span class="pl-ent">implementation</span>: <span class="pl-s">stackb:rules_proto:grpc_cc_library</span>
    <span class="pl-ent">visibility</span>:
      -  <span class="pl-s">//visibility:public</span>
    <span class="pl-ent">deps</span>:
      - <span class="pl-s"><span class="pl-pds">"</span>@com_github_grpc_grpc//:grpc++<span class="pl-pds">"</span></span>
      - <span class="pl-s"><span class="pl-pds">"</span>@com_github_grpc_grpc//:grpc++_reflection<span class="pl-pds">"</span></span>
<span class="pl-ent">languages</span>:
  - <span class="pl-ent">name</span>: <span class="pl-s"><span class="pl-pds">"</span>cpp<span class="pl-pds">"</span></span>
    <span class="pl-ent">plugins</span>:
      - <span class="pl-s">cpp</span>
      - <span class="pl-s">protoc-gen-grpc-cpp</span>
    <span class="pl-ent">rules</span>:
      - <span class="pl-s">proto_compile</span>
      - <span class="pl-s">proto_cc_library</span>
      - <span class="pl-s">grpc_cc_library</span></pre></div>
<blockquote>
<p dir="auto">A yaml config is particularly useful in conjunction with the
<code>proto_repository</code> rule, for example to apply a set of custom plugins over the
googleapis/googleapis repo.</p>
</blockquote>
<p dir="auto">To use this in a gazelle rule, specify <code>-proto_configs</code> in <code>args</code>
(comma-separated list):</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="gazelle(
    name = &quot;gazelle&quot;,
    gazelle = &quot;:gazelle-protobuf&quot;,
    args = [
        &quot;-proto_configs=example/config.yaml&quot;,
    ],
)"><pre><span class="pl-en">gazelle</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gazelle"</span>,
    <span class="pl-s1">gazelle</span> <span class="pl-c1">=</span> <span class="pl-s">":gazelle-protobuf"</span>,
    <span class="pl-s1">args</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"-proto_configs=example/config.yaml"</span>,
    ],
)</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Running Gazelle</h2><a id="user-content-running-gazelle" class="anchor" aria-label="Permalink: Running Gazelle" href="#running-gazelle"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Now that we have the <code>WORKSPACE</code> setup and gazelle configured, we can run
gazelle:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel run //:gazelle -- proto/"><pre>$ bazel run //:gazelle -- proto/</pre></div>
<p dir="auto">To restrict gazelle to only a particular subdirectory <code>example/routeguide/</code>:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel run //:gazelle -- example/routeguide/"><pre>$ bazel run //:gazelle -- example/routeguide/</pre></div>
<p dir="auto">Gazelle should now have generated something like the following:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@rules_proto//proto:defs.bzl&quot;, &quot;proto_library&quot;)
load(&quot;@build_stack_rules_proto//rules/cc:grpc_cc_library.bzl&quot;, &quot;grpc_cc_library&quot;)
load(&quot;@build_stack_rules_proto//rules/cc:proto_cc_library.bzl&quot;, &quot;proto_cc_library&quot;)
load(&quot;@build_stack_rules_proto//rules:proto_compile.bzl&quot;, &quot;proto_compile&quot;)

proto_library(
    name = &quot;routeguide_proto&quot;,
    srcs = [&quot;routeguide.proto&quot;],
    visibility = [&quot;//visibility:public&quot;],
)

proto_compile(
    name = &quot;routeguide_cpp_compile&quot;,
    outputs = [
        &quot;routeguide.grpc.pb.cc&quot;,
        &quot;routeguide.grpc.pb.h&quot;,
        &quot;routeguide.pb.cc&quot;,
        &quot;routeguide.pb.h&quot;,
    ],
    plugins = [
        &quot;@build_stack_rules_proto//plugin/builtin:cpp&quot;,
        &quot;@build_stack_rules_proto//plugin/grpc/grpc:protoc-gen-grpc-cpp&quot;,
    ],
    proto = &quot;routeguide_proto&quot;,
)

proto_cc_library(
    name = &quot;routeguide_cc_library&quot;,
    srcs = [&quot;routeguide.pb.cc&quot;],
    hdrs = [&quot;routeguide.pb.h&quot;],
    visibility = [&quot;//visibility:public&quot;],
    deps = [&quot;@com_google_protobuf//:protobuf&quot;],
)

grpc_cc_library(
    name = &quot;routeguide_grpc_cc_library&quot;,
    srcs = [&quot;routeguide.grpc.pb.cc&quot;],
    hdrs = [&quot;routeguide.grpc.pb.h&quot;],
    visibility = [&quot;//visibility:public&quot;],
    deps = [
        &quot;:routeguide_cc_library&quot;,
        &quot;@com_github_grpc_grpc//:grpc++&quot;,
        &quot;@com_github_grpc_grpc//:grpc++_reflection&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@rules_proto//proto:defs.bzl"</span>, <span class="pl-s">"proto_library"</span>)
<span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules/cc:grpc_cc_library.bzl"</span>, <span class="pl-s">"grpc_cc_library"</span>)
<span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules/cc:proto_cc_library.bzl"</span>, <span class="pl-s">"proto_cc_library"</span>)
<span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules:proto_compile.bzl"</span>, <span class="pl-s">"proto_compile"</span>)

<span class="pl-en">proto_library</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"routeguide_proto"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"routeguide.proto"</span>],
    <span class="pl-s1">visibility</span> <span class="pl-c1">=</span> [<span class="pl-s">"//visibility:public"</span>],
)

<span class="pl-en">proto_compile</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"routeguide_cpp_compile"</span>,
    <span class="pl-s1">outputs</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"routeguide.grpc.pb.cc"</span>,
        <span class="pl-s">"routeguide.grpc.pb.h"</span>,
        <span class="pl-s">"routeguide.pb.cc"</span>,
        <span class="pl-s">"routeguide.pb.h"</span>,
    ],
    <span class="pl-s1">plugins</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"@build_stack_rules_proto//plugin/builtin:cpp"</span>,
        <span class="pl-s">"@build_stack_rules_proto//plugin/grpc/grpc:protoc-gen-grpc-cpp"</span>,
    ],
    <span class="pl-s1">proto</span> <span class="pl-c1">=</span> <span class="pl-s">"routeguide_proto"</span>,
)

<span class="pl-en">proto_cc_library</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"routeguide_cc_library"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"routeguide.pb.cc"</span>],
    <span class="pl-s1">hdrs</span> <span class="pl-c1">=</span> [<span class="pl-s">"routeguide.pb.h"</span>],
    <span class="pl-s1">visibility</span> <span class="pl-c1">=</span> [<span class="pl-s">"//visibility:public"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">"@com_google_protobuf//:protobuf"</span>],
)

<span class="pl-en">grpc_cc_library</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"routeguide_grpc_cc_library"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"routeguide.grpc.pb.cc"</span>],
    <span class="pl-s1">hdrs</span> <span class="pl-c1">=</span> [<span class="pl-s">"routeguide.grpc.pb.h"</span>],
    <span class="pl-s1">visibility</span> <span class="pl-c1">=</span> [<span class="pl-s">"//visibility:public"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":routeguide_cc_library"</span>,
        <span class="pl-s">"@com_github_grpc_grpc//:grpc++"</span>,
        <span class="pl-s">"@com_github_grpc_grpc//:grpc++_reflection"</span>,
    ],
)</pre></div>
<p dir="auto">Regarding rules like
<code>@build_stack_rules_proto//rules/cc:proto_cc_library.bzl%proto_cc_library"</code>.
These are nearly always very thin wrappers for the "real" rule. For example,
here's the implementation in <code>proto_cc_library.bzl</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@rules_cc//cc:defs.bzl&quot;, &quot;cc_library&quot;)

def proto_cc_library(**kwargs):
    cc_library(**kwargs)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@rules_cc//cc:defs.bzl"</span>, <span class="pl-s">"cc_library"</span>)

<span class="pl-k">def</span> <span class="pl-en">proto_cc_library</span>(<span class="pl-c1">**</span><span class="pl-s1">kwargs</span>):
    <span class="pl-en">cc_library</span>(<span class="pl-c1">**</span><span class="pl-s1">kwargs</span>)</pre></div>
<p dir="auto">An implementation detail of gazelle itself is that two different language
extensions should not <em>claim</em> the same load namespace, so in order to prevent
potential conflicts with other possible gazelle extensions, using the name
<code>@rules_cc//cc:defs.bzl%cc_library</code> is undesirable.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Build Rules</h2><a id="user-content-build-rules" class="anchor" aria-label="Permalink: Build Rules" href="#build-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The core of <code>stackb/rules_proto</code> contains two build rules:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Rule</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>proto_compile</code></td>
<td>Executes the <code>protoc</code> tool.</td>
</tr>
<tr>
<td><code>proto_plugin</code></td>
<td>Provides static <code>protoc</code> plugin-specific configuration.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">proto_compile</h3><a id="user-content-proto_compile" class="anchor" aria-label="Permalink: proto_compile" href="#proto_compile"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@rules_proto//proto:defs.bzl&quot;, &quot;proto_library&quot;)
load(&quot;@build_stack_rules_proto//rules:proto_compile.bzl&quot;, &quot;proto_compile&quot;)

proto_library(
    name = &quot;thing_proto&quot;,
    srcs = [&quot;thing.proto&quot;],
    deps = [&quot;@com_google_protobuf//:timestamp_proto&quot;],
)

proto_plugin(name = &quot;cpp&quot;)

proto_compile(
    name = &quot;person_cpp_compile&quot;,
    outputs = [
        &quot;person.pb.cc&quot;,
        &quot;person.pb.h&quot;,
    ],
    plugins = [&quot;:cpp&quot;],
    proto = &quot;person_proto&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@rules_proto//proto:defs.bzl"</span>, <span class="pl-s">"proto_library"</span>)
<span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules:proto_compile.bzl"</span>, <span class="pl-s">"proto_compile"</span>)

<span class="pl-en">proto_library</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_proto"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"thing.proto"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">"@com_google_protobuf//:timestamp_proto"</span>],
)

<span class="pl-en">proto_plugin</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"cpp"</span>)

<span class="pl-en">proto_compile</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"person_cpp_compile"</span>,
    <span class="pl-s1">outputs</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"person.pb.cc"</span>,
        <span class="pl-s">"person.pb.h"</span>,
    ],
    <span class="pl-s1">plugins</span> <span class="pl-c1">=</span> [<span class="pl-s">":cpp"</span>],
    <span class="pl-s1">proto</span> <span class="pl-c1">=</span> <span class="pl-s">"person_proto"</span>,
)</pre></div>
<p dir="auto">Takeaways:</p>
<ul dir="auto">
<li>A <code>proto_library</code> rule forms the basis for other language-specific derived
rules.</li>
<li><code>proto_library</code> is provided by
<a href="https://github.com/bazelbuild/rules_proto">bazelbuild/rules_proto</a>.</li>
<li>A <code>proto_compile</code> rule references a single <code>proto_library</code> target.</li>
<li>The <code>plugins</code> attribute is a list of labels to <code>proto_plugin</code> targets.</li>
<li>The <code>outputs</code> attribute names the files that will be generated by the protoc
invocation.</li>
<li>The
<a href="https://github.com/bazelbuild/bazel-gazelle/blob/master/language/proto/lang.go">proto</a>
extension provided by [bazel-gazelle] is responsible for generating
<code>proto_library</code>.</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">proto_plugin</h3><a id="user-content-proto_plugin" class="anchor" aria-label="Permalink: proto_plugin" href="#proto_plugin"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>proto_plugin</code> primarily provides the plugin tool executable. The example seen
above is the simplest case where the plugin is builtin to <code>protoc</code> itself; no
separate plugin tool is required. In this case the <code>proto_plugin</code> rule
degenerates into just a <code>name</code>.</p>
<p dir="auto">It is possible to add additional plugin-specific
<code>name = "foo", options = ["bar"]</code> on the <code>proto_plugin</code> rule, but the use-case
for this is narrow. Generally it is preferred to say
<code># gazelle:proto_plugin foo option bar</code> such that the option can be interpreted
during a gazelle run.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">proto_compiled_sources</h3><a id="user-content-proto_compiled_sources" class="anchor" aria-label="Permalink: proto_compiled_sources" href="#proto_compiled_sources"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>proto_compiled_sources</code> is used when you prefer to check the generated files
into source control. This may be necessary for legacy reasons, during an initial
Bazel migration, or to support better IDE integration.</p>
<p dir="auto">The shape of a <code>proto_compiled_sources</code> rule is essentially identical to
<code>proto_compile</code> with one exception: generated source are named in the <code>srcs</code>
attribute rather than <code>outputs</code>.</p>
<p dir="auto">For example, a <code>proto_compiled_sources</code> named <code>//example/thing:proto_go_sources</code>
is a macro that generates three rules:</p>
<ol dir="auto">
<li><code>bazel build //example/thing:proto_go_sources</code> emits the generated files.</li>
<li><code>bazel run //example/thing:proto_go_sources.update</code> copies the generated
files back into the source package.</li>
<li><code>bazel test //example/thing:proto_go_sources_test</code> asserts the source files
are identical to generated files.</li>
</ol>
<p dir="auto">In this scenario, <code>2.</code> is used to build the generated files (in the <code>bazel-bin/</code>
output tree) and copy the <code>example/thing/thing.pb.go</code> back into place where it
will be committed under source control. <code>3.</code> is used to prevent drift: if a
developer modifies <code>thing.proto</code> and neglects to run the <code>.update</code> the test will
fail in CI.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">proto_compile_assets</h3><a id="user-content-proto_compile_assets" class="anchor" aria-label="Permalink: proto_compile_assets" href="#proto_compile_assets"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The macro <code>proto_compile_assets</code> aggregates a list of dependencies (which
provide <code>ProtoCompileInfo</code>) into a single runnable target that copies files in
bulk.</p>
<p dir="auto">For example, <code>bazel run //proto:assets</code> will copy all the generated <code>.pb.go</code>
files back into the source tree:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//rules:proto_compile_assets.bzl&quot;, &quot;proto_compile_assets&quot;)

proto_compile_assets(
    name = &quot;assets&quot;,
    deps = [,
      &quot;//proto/api/v1:proto_go_compile&quot;,
      &quot;//proto/api/v2:proto_go_compile&quot;,
      &quot;//proto/api/v3:proto_go_compile&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules:proto_compile_assets.bzl"</span>, <span class="pl-s">"proto_compile_assets"</span>)

<span class="pl-en">proto_compile_assets</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"assets"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s1"></span>,
      <span class="pl-s">"//proto/api/v1:proto_go_compile"</span>,
      <span class="pl-s">"//proto/api/v2:proto_go_compile"</span>,
      <span class="pl-s">"//proto/api/v3:proto_go_compile"</span>,
    ],
)</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">The <code>output_mappings</code> attribute</h3><a id="user-content-the-output_mappings-attribute" class="anchor" aria-label="Permalink: The output_mappings attribute" href="#the-output_mappings-attribute"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Consider the following rule within the package <code>example/thing</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="proto_compile(
    name = &quot;thing_go_compile&quot;,
    output_mappings = [&quot;thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go&quot;],
    outputs = [&quot;thing.pb.go&quot;],
    plugins = [&quot;@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go&quot;],
    proto = &quot;thing_proto&quot;,
)"><pre><span class="pl-en">proto_compile</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_go_compile"</span>,
    <span class="pl-s1">output_mappings</span> <span class="pl-c1">=</span> [<span class="pl-s">"thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go"</span>],
    <span class="pl-s1">outputs</span> <span class="pl-c1">=</span> [<span class="pl-s">"thing.pb.go"</span>],
    <span class="pl-s1">plugins</span> <span class="pl-c1">=</span> [<span class="pl-s">"@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go"</span>],
    <span class="pl-s1">proto</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_proto"</span>,
)</pre></div>
<p dir="auto">This rule is declaring that a file <code>bazel-bin/example/thing/thing.pb.go</code> will be
output when the action is run. When we
<code>bazel build //example/thing:thing_go_compile</code>, the file is indeed created.</p>
<p dir="auto">Let's temporarily comment out the <code>output_mappings</code> attribute and rebuild:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="proto_compile(
    name = &quot;thing_go_compile&quot;,
    # output_mappings = [&quot;thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go&quot;],
    outputs = [&quot;thing.pb.go&quot;],
    plugins = [&quot;@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go&quot;],
    proto = &quot;thing_proto&quot;,
)"><pre><span class="pl-en">proto_compile</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_go_compile"</span>,
    <span class="pl-c"># output_mappings = ["thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go"],</span>
    <span class="pl-s1">outputs</span> <span class="pl-c1">=</span> [<span class="pl-s">"thing.pb.go"</span>],
    <span class="pl-s1">plugins</span> <span class="pl-c1">=</span> [<span class="pl-s">"@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go"</span>],
    <span class="pl-s1">proto</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_proto"</span>,
)</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel build //example/thing:thing_go_compile
ERROR: /github.com/stackb/rules_proto/example/thing/BUILD.bazel:54:14: output 'example/thing/thing.pb.go' was not created"><pre>$ bazel build //example/thing:thing_go_compile
ERROR: /github.com/stackb/rules_proto/example/thing/BUILD.bazel:54:14: output <span class="pl-s"><span class="pl-pds">'</span>example/thing/thing.pb.go<span class="pl-pds">'</span></span> was not created</pre></div>
<p dir="auto">What happened? Let's add a debugging attribute <code>verbose = True</code> on the rule:
this will print debugging information and show the bazel sandbox before and
after the <code>protoc</code> tool is invoked:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="proto_compile(
    name = &quot;thing_go_compile&quot;,
    # output_mappings = [&quot;thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go&quot;],
    outputs = [&quot;thing.pb.go&quot;],
    plugins = [&quot;@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go&quot;],
    proto = &quot;thing_proto&quot;,
    verbose = True,
)"><pre><span class="pl-en">proto_compile</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_go_compile"</span>,
    <span class="pl-c"># output_mappings = ["thing.pb.go=github.com/stackb/rules_proto/example/thing/thing.pb.go"],</span>
    <span class="pl-s1">outputs</span> <span class="pl-c1">=</span> [<span class="pl-s">"thing.pb.go"</span>],
    <span class="pl-s1">plugins</span> <span class="pl-c1">=</span> [<span class="pl-s">"@build_stack_rules_proto//plugin/golang/protobuf:protoc-gen-go"</span>],
    <span class="pl-s1">proto</span> <span class="pl-c1">=</span> <span class="pl-s">"thing_proto"</span>,
    <span class="pl-s1">verbose</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>,
)</pre></div>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel build //example/thing:thing_go_compile
##### SANDBOX BEFORE RUNNING PROTOC
./bazel-out/host/bin/external/com_google_protobuf/protoc
./bazel-out/darwin-opt-exec-2B5CBBC6/bin/external/com_github_golang_protobuf/protoc-gen-go/protoc-gen-go_/protoc-gen-go
./bazel-out/darwin-fastbuild/bin/example/thing/thing_proto-descriptor-set.proto.bin
./bazel-out/darwin-fastbuild/bin/external/com_google_protobuf/timestamp_proto-descriptor-set.proto.bin

##### SANDBOX AFTER RUNNING PROTOC
./bazel-out/darwin-fastbuild/bin/github.com/stackb/rules_proto/example/thing/thing.pb.go"><pre>$ bazel build //example/thing:thing_go_compile
<span class="pl-c"><span class="pl-c">#</span>#### SANDBOX BEFORE RUNNING PROTOC</span>
./bazel-out/host/bin/external/com_google_protobuf/protoc
./bazel-out/darwin-opt-exec-2B5CBBC6/bin/external/com_github_golang_protobuf/protoc-gen-go/protoc-gen-go_/protoc-gen-go
./bazel-out/darwin-fastbuild/bin/example/thing/thing_proto-descriptor-set.proto.bin
./bazel-out/darwin-fastbuild/bin/external/com_google_protobuf/timestamp_proto-descriptor-set.proto.bin

<span class="pl-c"><span class="pl-c">#</span>#### SANDBOX AFTER RUNNING PROTOC</span>
./bazel-out/darwin-fastbuild/bin/github.com/stackb/rules_proto/example/thing/thing.pb.go</pre></div>
<p dir="auto">So, the file was created, but not in the location we wanted. In this case the
<code>protoc-gen-go</code> plugin is not "playing nice" with Bazel. Because this
<code>thing.proto</code> has
<code>option go_package = "github.com/stackb/rules_proto/example/thing;thing";</code>, the
output location is no longer based on the <code>package</code>. This is a problem, because
Bazel semantics disallow declaring a File outside its package boundary. As a
result, we need to do a
<code>mv ./bazel-out/darwin-fastbuild/bin/github.com/stackb/rules_proto/example/thing/thing.pb.go ./bazel-out/darwin-fastbuild/bin/example/thing/thing.pb.go</code>
to relocate the file into its expected location before the action terminates.</p>
<p dir="auto">Therefore, the <code>output_mappings</code> attribute is a list of entries that map file
locations <code>want=got</code> relative to the action execution root. It is required when
the actual output location does not match the desired location. This can occur
if the proto <code>package</code> statement does not match the Bazel package path, or in
special circumstances specific to the plugin itself (like <code>go_package</code>).</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Repository Rules</h2><a id="user-content-repository-rules" class="anchor" aria-label="Permalink: Repository Rules" href="#repository-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">proto_repository</h2><a id="user-content-proto_repository" class="anchor" aria-label="Permalink: proto_repository" href="#proto_repository"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">From an implementation standpoint, this is very similar to the <code>go_repository</code>
rule. Both can download external files and then run the gazelle generator over
the downloaded files. Example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="proto_repository(
    name = &quot;googleapis&quot;,
    build_directives = [
        &quot;gazelle:resolve proto google/api/http.proto //google/api:http_proto&quot;,
    ],
    build_file_generation = &quot;clean&quot;,
    build_file_proto_mode = &quot;file&quot;,
    reresolve_known_proto_imports = True,
    proto_language_config_file = &quot;@//:rules_proto_config.yaml&quot;,
    strip_prefix = &quot;googleapis-02710fa0ea5312d79d7fb986c9c9823fb41049a9&quot;,
    type = &quot;zip&quot;,
    urls = [&quot;https://codeload.github.com/googleapis/googleapis/zip/02710fa0ea5312d79d7fb986c9c9823fb41049a9&quot;],
)"><pre><span class="pl-en">proto_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"googleapis"</span>,
    <span class="pl-s1">build_directives</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"gazelle:resolve proto google/api/http.proto //google/api:http_proto"</span>,
    ],
    <span class="pl-s1">build_file_generation</span> <span class="pl-c1">=</span> <span class="pl-s">"clean"</span>,
    <span class="pl-s1">build_file_proto_mode</span> <span class="pl-c1">=</span> <span class="pl-s">"file"</span>,
    <span class="pl-s1">reresolve_known_proto_imports</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>,
    <span class="pl-s1">proto_language_config_file</span> <span class="pl-c1">=</span> <span class="pl-s">"@//:rules_proto_config.yaml"</span>,
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"googleapis-02710fa0ea5312d79d7fb986c9c9823fb41049a9"</span>,
    <span class="pl-s1">type</span> <span class="pl-c1">=</span> <span class="pl-s">"zip"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://codeload.github.com/googleapis/googleapis/zip/02710fa0ea5312d79d7fb986c9c9823fb41049a9"</span>],
)</pre></div>
<p dir="auto">Takeaways:</p>
<ul dir="auto">
<li>The <code>urls</code>, <code>strip_prefix</code> and <code>type</code> behave similarly to <code>http_archive</code>.</li>
<li><code>build_file_proto_mode</code> is the same the <code>go_repository</code> attribute of the same
name; additionally the value <code>file</code> is permitted which generates a
<code>proto_library</code> for each individual proto file.</li>
<li><code>build_file_generation</code> is the same the <code>go_repository</code> attribute of the same
name; additionally the value <code>clean</code> is supported. For example, googleapis
already has a set of BUILD files; the <code>clean</code> mode will remove all the
existing build files before generating new ones.</li>
<li><code>build_directives</code> is the same as <code>go_repository</code>. Resolve directives in this
case are needed because the gazelle <code>language/proto</code> extension hardcodes a
proto import like <code>google/api/http.proto</code> to resolve to the <code>@go_googleapis</code>
workspace; here we want to make sure that http.proto resolves to the same
external workspace.</li>
<li><code>proto_language_config_file</code> is an optional label pointing to a valid
<code>config.yaml</code> file to configure this extension.</li>
<li><code>reresolve_known_proto_imports</code> is a boolean attribute that has special meaning for
the googleapis repository. Due to the fact that the builtin gazelle "proto"
extension has
<a href="https://github.com/bazelbuild/bazel-gazelle/blob/master/language/proto/known_proto_imports.go">hardcoded logic</a>
for what googleapis deps look like, additional work is needed to override
that. With this sample configuration, the following build command succeeds:</li>
</ul>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel build @googleapis//google/api:annotations_cc_library
Target @googleapis//google/api:annotations_cc_library up-to-date:
  bazel-bin/external/googleapis/google/api/libannotations_cc_library.a
  bazel-bin/external/googleapis/google/api/libannotations_cc_library.so"><pre>$ bazel build @googleapis//google/api:annotations_cc_library
Target @googleapis//google/api:annotations_cc_library up-to-date:
  bazel-bin/external/googleapis/google/api/libannotations_cc_library.a
  bazel-bin/external/googleapis/google/api/libannotations_cc_library.so</pre></div>
<p dir="auto">Another example using the Bazel repository:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//rules/proto:proto_repository.bzl&quot;, &quot;proto_repository&quot;)

proto_repository(
    name = &quot;bazelapis&quot;,
    build_directives = [
        &quot;gazelle:exclude third_party&quot;,
        &quot;gazelle:proto_language go enable true&quot;,
        &quot;gazelle:proto_language closure enabled true&quot;,
        &quot;gazelle:prefix github.com/bazelbuild/bazelapis&quot;,
    ],
    build_file_expunge = True,
    build_file_proto_mode = &quot;file&quot;,
    cfgs = [&quot;//proto:config.yaml&quot;],
    imports = [
        &quot;@googleapis//:imports.csv&quot;,
        &quot;@protoapis//:imports.csv&quot;,
        &quot;@remoteapis//:imports.csv&quot;,
    ],
    strip_prefix = &quot;bazel-02ad3e3bc6970db11fe80f966da5707a6c389fdd&quot;,
    type = &quot;zip&quot;,
    urls = [&quot;https://codeload.github.com/bazelbuild/bazel/zip/02ad3e3bc6970db11fe80f966da5707a6c389fdd&quot;],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules/proto:proto_repository.bzl"</span>, <span class="pl-s">"proto_repository"</span>)

<span class="pl-en">proto_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"bazelapis"</span>,
    <span class="pl-s1">build_directives</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"gazelle:exclude third_party"</span>,
        <span class="pl-s">"gazelle:proto_language go enable true"</span>,
        <span class="pl-s">"gazelle:proto_language closure enabled true"</span>,
        <span class="pl-s">"gazelle:prefix github.com/bazelbuild/bazelapis"</span>,
    ],
    <span class="pl-s1">build_file_expunge</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>,
    <span class="pl-s1">build_file_proto_mode</span> <span class="pl-c1">=</span> <span class="pl-s">"file"</span>,
    <span class="pl-s1">cfgs</span> <span class="pl-c1">=</span> [<span class="pl-s">"//proto:config.yaml"</span>],
    <span class="pl-s1">imports</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"@googleapis//:imports.csv"</span>,
        <span class="pl-s">"@protoapis//:imports.csv"</span>,
        <span class="pl-s">"@remoteapis//:imports.csv"</span>,
    ],
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"bazel-02ad3e3bc6970db11fe80f966da5707a6c389fdd"</span>,
    <span class="pl-s1">type</span> <span class="pl-c1">=</span> <span class="pl-s">"zip"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://codeload.github.com/bazelbuild/bazel/zip/02ad3e3bc6970db11fe80f966da5707a6c389fdd"</span>],
)</pre></div>
<p dir="auto">Takeaways:</p>
<ul dir="auto">
<li>The <code>build_directives</code> are setting the <code>gazelle:prefix</code> for the <code>language/go</code>
plugin; two <code>proto_language</code> configs named in the <code>proto/config.yaml</code> are
being enabled.</li>
<li><code>build_file_expunge</code> means <em>remove all existing BUILD files before generating
new ones</em>.</li>
<li><code>build_file_proto_mode = "file"</code> means <em>make a separate <code>proto_library</code> rule
for every <code>.proto</code> file</em>.</li>
<li><code>cfgs = ["//proto:config.yaml"]</code> means <em>use the configuration in this YAML
file as a base set of gazelle directives</em>. It is easier/more consistent to
share the same <code>config.yaml</code> file across multiple <code>proto_repository</code> rules.</li>
</ul>
<p dir="auto">The last one <code>imports = ["@googleapis//:imports.csv", ...]</code> requires extra
explanation. When the <code>proto_repository</code> gazelle process finishes, it writes a
file named <code>imports.csv</code> in the root of the external workspace. This file
records the association between import statements and bazel labels, much like a
<code>gazelle:resolve</code> directive:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# GENERATED FILE, DO NOT EDIT (created by gazelle)
# lang,imp.lang,imp,label
go,go,github.com/googleapis/gapic-showcase/server/genproto,@googleapis//google/example/showcase/v1:compliance_go_proto
go,go,google.golang.org/genproto/firestore/bundle,@googleapis//google/firestore/bundle:bundle_go_proto
go,go,google.golang.org/genproto/googleapis/actions/sdk/v2,@googleapis//google/actions/sdk/v2:account_linking_go_proto"><pre lang="csv" class="notranslate"><code># GENERATED FILE, DO NOT EDIT (created by gazelle)
# lang,imp.lang,imp,label
go,go,github.com/googleapis/gapic-showcase/server/genproto,@googleapis//google/example/showcase/v1:compliance_go_proto
go,go,google.golang.org/genproto/firestore/bundle,@googleapis//google/firestore/bundle:bundle_go_proto
go,go,google.golang.org/genproto/googleapis/actions/sdk/v2,@googleapis//google/actions/sdk/v2:account_linking_go_proto
</code></pre></div>
<p dir="auto">Therefore, the <code>imports</code> attribute assists gazelle in figuring how to resolve
imports. Therefore, when gazelle is preparing a <code>go_library</code> rule and finds a
<code>main.go</code> file having an import on
<code>google.golang.org/genproto/firestore/bundle</code>, it knows to put
<code>@googleapis//google/firestore/bundle:bundle_go_proto</code> in the rule <code>deps</code>.</p>
<p dir="auto">To take advantage of this mechanism in the default workspace, use the
<code>proto_gazelle</code> rule.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">proto_gazelle</h2><a id="user-content-proto_gazelle" class="anchor" aria-label="Permalink: proto_gazelle" href="#proto_gazelle"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>proto_gazelle</code> is not a repository rule: it's just like the typical <code>gazelle</code>
rule, but with extra deps resolution superpowers. But, we discuss it here since
it works in conjunction with <code>proto_repository</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//rules:proto_gazelle.bzl&quot;, &quot;DEFAULT_LANGUAGES&quot;, &quot;proto_gazelle&quot;)

proto_gazelle(
    name = &quot;gazelle&quot;,
    cfgs = [&quot;//proto:config.yaml&quot;],
    command = &quot;update&quot;,
    gazelle = &quot;:gazelle-protobuf&quot;,
    imports = [
        &quot;@bazelapis//:imports.csv&quot;,
        &quot;@googleapis//:imports.csv&quot;,
        &quot;@protoapis//:imports.csv&quot;,
        &quot;@remoteapis//:imports.csv&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules:proto_gazelle.bzl"</span>, <span class="pl-s">"DEFAULT_LANGUAGES"</span>, <span class="pl-s">"proto_gazelle"</span>)

<span class="pl-en">proto_gazelle</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gazelle"</span>,
    <span class="pl-s1">cfgs</span> <span class="pl-c1">=</span> [<span class="pl-s">"//proto:config.yaml"</span>],
    <span class="pl-s1">command</span> <span class="pl-c1">=</span> <span class="pl-s">"update"</span>,
    <span class="pl-s1">gazelle</span> <span class="pl-c1">=</span> <span class="pl-s">":gazelle-protobuf"</span>,
    <span class="pl-s1">imports</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"@bazelapis//:imports.csv"</span>,
        <span class="pl-s">"@googleapis//:imports.csv"</span>,
        <span class="pl-s">"@protoapis//:imports.csv"</span>,
        <span class="pl-s">"@remoteapis//:imports.csv"</span>,
    ],
)</pre></div>
<p dir="auto">In this example, we are again setting the base gazelle config using the YAML
file (the same one used in for the <code>proto_repository</code> rules). We are also now
importing resolve information from four external sources.</p>
<p dir="auto">With this setup, we can simply place an import statement like
<code>import "src/main/java/com/google/devtools/build/lib/buildeventstream/proto/build_event_stream.proto";</code>
in a <code>foo.proto</code> file in the default workspace, and gazelle will automagically
figure out the import dependency tree spanning <code>@bazelapis</code>, <code>@remoteapis</code>,
<code>@googleapis</code>, and the well-known types from <code>@protoapis</code>.</p>
<p dir="auto">This works for any <code>proto_language</code>, with any set of custom protoc plugins.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">golden_filegroup</h2><a id="user-content-golden_filegroup" class="anchor" aria-label="Permalink: golden_filegroup" href="#golden_filegroup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>golden_filegroup</code> is a utility macro for golden file testing. It works like a
native filegroup, but adds <code>.update</code> and <code>.test</code> targets. Example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@build_stack_rules_proto//rules:golden_filegroup.bzl&quot;, &quot;golden_filegroup&quot;)

# golden_filegroup asserts that generated files named in 'srcs' are
# identical to the ones checked into source control.
#
# Usage:
#
# $ bazel build :golden        # not particularly useful, just a regular filegroup
#
# $ bazel test  :golden.test   # checks that generated files are identical to
# ones in git (for CI)
#
# $ bazel run   :golden.update # copies the generated files into source tree
# (then 'git add' to your PR if it looks good)
golden_filegroup(
    name = &quot;golden&quot;,
    srcs = [
        &quot;:some_generated_file1.json&quot;,
        &quot;:some_generated_file2.json&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@build_stack_rules_proto//rules:golden_filegroup.bzl"</span>, <span class="pl-s">"golden_filegroup"</span>)

<span class="pl-c"># golden_filegroup asserts that generated files named in 'srcs' are</span>
<span class="pl-c"># identical to the ones checked into source control.</span>
<span class="pl-c">#</span>
<span class="pl-c"># Usage:</span>
<span class="pl-c">#</span>
<span class="pl-c"># $ bazel build :golden        # not particularly useful, just a regular filegroup</span>
<span class="pl-c">#</span>
<span class="pl-c"># $ bazel test  :golden.test   # checks that generated files are identical to</span>
<span class="pl-c"># ones in git (for CI)</span>
<span class="pl-c">#</span>
<span class="pl-c"># $ bazel run   :golden.update # copies the generated files into source tree</span>
<span class="pl-c"># (then 'git add' to your PR if it looks good)</span>
<span class="pl-en">golden_filegroup</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"golden"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":some_generated_file1.json"</span>,
        <span class="pl-s">":some_generated_file2.json"</span>,
    ],
)</pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Plugin Implementations</h2><a id="user-content-plugin-implementations" class="anchor" aria-label="Permalink: Plugin Implementations" href="#plugin-implementations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The plugin name is an opaque string, but by convention they are maven-esqe
artifact identifiers that follow a GitHub org/repo/plugin_name convention.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="pkg/plugin/builtin/cpp_plugin.go">builtin:cpp</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/csharp_plugin.go">builtin:csharp</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/java_plugin.go">builtin:java</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/js_closure_plugin.go">builtin:js:closure</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/js_common_plugin.go">builtin:js:common</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/objc_plugin.go">builtin:objc</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/php_plugin.go">builtin:php</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/python_plugin.go">builtin:python</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/pyi_plugin.go">builtin:pyi</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/ruby_plugin.go">builtin:ruby</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/builtin/grpc_grpc_cpp.go">grpc:grpc:cpp</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpc/grpc/protoc-gen-grpc-python.go">grpc:grpc:protoc-gen-grpc-python</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/golang/protobuf/protoc-gen-go.go">golang:protobuf:protoc-gen-go</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpc/grpcgo/protoc-gen-go-grpc.go">grpc:grpc-go:protoc-gen-go-grpc</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpc/grpcjava/protoc-gen-grpc-java.go">grpc:grpc-java:protoc-gen-grpc-java</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpc/grpcnode/protoc-gen-grpc-node.go">grpc:grpc-node:protoc-gen-grpc-node</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpc/grpcweb/protoc-gen-grpc-web.go">grpc:grpc-web:protoc-gen-grpc-web</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-combo</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gogo</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gogofast</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gogofaster</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gogoslick</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gogotypes</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/gogo/protobuf/protoc-gen-gogo.go">gogo:protobuf:protoc-gen-gostring</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/grpcecosystem/grpcgateway/protoc-gen-grpc-gateway.go">grpc-ecosystem:grpc-gateway:protoc-gen-grpc-gateway</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/scalapb/scalapb/protoc_gen_scala.go">scalapb:scalapb:protoc-gen-scala</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/stackb/grpc_js/protoc-gen-grpc-js.go">stackb:grpc.js:protoc-gen-grpc-js</a></td>
</tr>
<tr>
<td><a href="pkg/plugin/stephenh/ts-proto/protoc-gen-ts-proto.go">stephenh:ts-proto:protoc-gen-ts-proto</a></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Rule Implementations</h2><a id="user-content-rule-implementations" class="anchor" aria-label="Permalink: Rule Implementations" href="#rule-implementations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The rule name is an opaque string, but by convention they are maven-esqe
artifact identifiers that follow a GitHub org/repo/rule_name convention.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="pkg/rule/rules_cc/grpc_cc_library.go">stackb:rules_proto:grpc_cc_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_closure/grpc_closure_js_library.go">stackb:rules_proto:grpc_closure_js_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_java/grpc_java_library.go">stackb:rules_proto:grpc_java_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_nodejs/grpc_nodejs_library.go">stackb:rules_proto:grpc_nodejs_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_nodejs/grpc_web_js_library.go">stackb:rules_proto:grpc_web_js_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_python/grpc_py_library.go">stackb:rules_proto:grpc_py_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_cc/proto_cc_library.go">stackb:rules_proto:proto_cc_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_closure/proto_closure_js_library.go">stackb:rules_proto:proto_closure_js_library</a></td>
</tr>
<tr>
<td><a href="pkg/protoc/proto_compile.go">stackb:rules_proto:proto_compile</a></td>
</tr>
<tr>
<td><a href="pkg/protoc/proto_compiled_sources.go">stackb:rules_proto:proto_compiled_sources</a></td>
</tr>
<tr>
<td><a href="pkg/protoc/proto_descriptor_set.go">stackb:rules_proto:proto_descriptor_set</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_go/go_library.go">stackb:rules_proto:proto_go_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_java/proto_java_library.go">stackb:rules_proto:proto_java_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_nodejs/proto_nodejs_library.go">stackb:rules_proto:proto_nodejs_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_python/proto_py_library.go">stackb:rules_proto:proto_py_library</a></td>
</tr>
<tr>
<td><a href="pkg/rule/rules_scala/scala_proto_library.go">bazelbuild:rules_scala:scala_proto_library</a></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Please consult the <code>example/</code> directory and unit tests for more additional
detail.</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Writing Custom Plugins and Rules</h1><a id="user-content-writing-custom-plugins-and-rules" class="anchor" aria-label="Permalink: Writing Custom Plugins and Rules" href="#writing-custom-plugins-and-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Custom plugin implementations and rule implementations can be written in golang
or starlark.  Golang implementations are statically compiled into the final
<code>gazelle_binary</code> whereas starlark plugins are evaluated at gazelle runtime.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">+/- of golang implementations</h2><a id="user-content---of-golang-implementations" class="anchor" aria-label="Permalink: +/- of golang implementations" href="#--of-golang-implementations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><code>+</code> Full power of a statically compiled language, the golang stdlib, and
external dependencies.</li>
<li><code>+</code> Easier to test.</li>
<li><code>+</code> API not experimental.</li>
<li><code>-</code> Cannot be used in a <code>proto_repository</code> rule without forking
stackb/rules_proto.</li>
<li><code>-</code> Initial setup harder, often housed within your own custom gazelle
extension.</li>
</ul>
<p dir="auto">Until a dedicated tutorial is available, please consult the source code for
examples.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">+/- of starlark implementations</h2><a id="user-content---of-starlark-implementations" class="anchor" aria-label="Permalink: +/- of starlark implementations" href="#--of-starlark-implementations"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><code>+</code> More familiar to developer with starlark experience but not golang.</li>
<li><code>+</code> Easier setup (*.star files in your gazelle repository)</li>
<li><code>+</code> Possible to use in conjunction with the <code>proto_repository</code> rule.</li>
<li><code>-</code> Limited API: can only reference state that has been already configured via gazelle directives.</li>
<li><code>-</code> Not possible to implement stateful design.</li>
<li><code>-</code> No standard library.</li>
</ul>
<p dir="auto">Until a dedicated tutorial is available, please consult the reference example in
<code>example/testdata/starlark_java</code>.</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">History</h1><a id="user-content-history" class="anchor" aria-label="Permalink: History" href="#history"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The original rules_proto was <a href="https://github.com/pubref/rules_proto">https://github.com/pubref/rules_proto</a>. This was
redesigned around the <code>proto_library</code> rule and moved to
<a href="https://github.com/stackb/rules_proto">https://github.com/stackb/rules_proto</a>.</p>
<p dir="auto">Following earlier experiments with aspects, this ruleset was forked to
<a href="https://github.com/rules-proto-grpc/rules_proto_grpc">https://github.com/rules-proto-grpc/rules_proto_grpc</a>. Aspect-based compilation
was featured for quite a while there but has recently been deprecated.</p>
<p dir="auto">Maintaining <code>stackb/rules_proto</code> and its polyglot set of languages in its
original v0-v1 form became a full-time (unpaid) job. The main issue is that the
<code>{LANG}_{PROTO|GRPC}_library</code> rules are <strong>tightly bound to a specific set of
dependencies</strong>. As such, rules_proto users are tightly bound to the specific
labels named by those rules. This is a problem for the maintainer as one must
keep the dependencies current. It is also a problem for rule consumers: <em>it
becomes increasingly difficult to upgrade as the dependencies as assumptions and
dependencies drift</em>.</p>
<p dir="auto">With <code>stackb/rules_proto</code> in its <code>v2</code> gazelle-based form, it is largely
<strong>dependency-free</strong>: other than gazelle and the <code>protoc</code> toolchain, <em>there are
no dependencies that you cannot fully control in your own workspace via the
gazelle configuration</em>.</p>
<p dir="auto">The gazelle based design also makes things <em>much</em> simpler and powerful, because
the <strong>content of the proto files is the source of truth</strong>. Due to the fact that
Bazel does not permit reading/interpreting a file during the scope of an action,
it is impossible to make a decision about what to do. A prime example of this is
the <code>go_package</code> option. If the <code>go_package</code> option is present, the location of
the output file for <code>protoc-gen-go</code> is completely different. As a result, the
information about the go_package metadata ultimately needs to be duplicated so
that the build system can know about it.</p>
<p dir="auto">The gazelle-based approach moves all that messy interpretation and evaluation
into a precompiled state; as a result, the work that needs to be done in the
action itself is dramatically simplified.</p>
<p dir="auto">Furthermore, by parsing the proto files it is easy to support complex custom
plugins that do things like:</p>
<ul dir="auto">
<li>Emit no files (only assert/lint).</li>
<li>Emit a file only if a specific enum constant is found. With the previous
design, this was near impossible. With the <code>v2</code> design, the <code>protoc.Plugin</code>
implementation can trivially perform that evaluation because it is handed the
complete proto AST during gazelle evaluation.</li>
</ul>
</article></div>