<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><p align="left" dir="auto"><a target="_blank" rel="noopener noreferrer" href="logo/horizontal.png"><img src="logo/horizontal.png" alt="rules_haskell" height="100px" style="max-width: 100%; height: auto; max-height: 100px;"></a></p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Haskell rules for <a href="https://bazel.build/" rel="nofollow">Bazel</a></h1><a id="user-content-haskell-rules-for-bazel" class="anchor" aria-label="Permalink: Haskell rules for Bazel" href="#haskell-rules-for-bazel"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><a href="https://github.com/tweag/rules_haskell/actions/workflows/workflow.yaml"><img src="https://github.com/tweag/rules_haskell/actions/workflows/workflow.yaml/badge.svg?event=schedule" alt="Continuous Integration" style="max-width: 100%;"></a></p>
<p dir="auto">Bazel CI: <a href="https://buildkite.com/bazel/rules-haskell-haskell" rel="nofollow"><img src="https://camo.githubusercontent.com/91fb354a18300216acf966dda6619775a444e7b2d13b6882e7115da6599e8ce4/68747470733a2f2f62616467652e6275696c646b6974652e636f6d2f31646533323730663164663037306139393937386164623665666131383064306333326561633538653066643139333864312e7376673f6272616e63683d6d6173746572" alt="Build status" data-canonical-src="https://badge.buildkite.com/1de3270f1df070a99978adb6efa180d0c32eac58e0fd1938d1.svg?branch=master" style="max-width: 100%;"></a></p>
<p dir="auto">Bazel automates building and testing software. It scales to very large
multi-language projects. This project extends Bazel with build rules
for Haskell. Get started building your own project using these rules
with the <a href="#setup">setup script below</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Rule summary</h2><a id="user-content-rule-summary" class="anchor" aria-label="Permalink: Rule summary" href="#rule-summary"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The full reference documentation for rules is at <a href="https://haskell.build" rel="nofollow">https://haskell.build</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Setup</h2><a id="user-content-setup" class="anchor" aria-label="Permalink: Setup" href="#setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You'll need <a href="https://bazel.build/start" rel="nofollow">Bazel &gt;= 6.0</a> installed.</p>
<p dir="auto">If you are on NixOS, skip to the <a href="#Nixpkgs">Nixpkgs</a> section.</p>
<div class="markdown-alert markdown-alert-note" dir="auto"><p class="markdown-alert-title" dir="auto"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">Bazel 8 users will need to add
<code>common --noincompatible_disallow_ctx_resolve_tools</code> to <code>.bazelrc</code></p>
</div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">System dependencies</h3><a id="user-content-system-dependencies" class="anchor" aria-label="Permalink: System dependencies" href="#system-dependencies"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Refer to the "Before you begin" section in <a href="docs/haskell.rst">the documentation</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">The easy way</h3><a id="user-content-the-easy-way" class="anchor" aria-label="Permalink: The easy way" href="#the-easy-way"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In a fresh directory, run:</p>
<div class="highlight highlight-text-shell-session notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ curl https://haskell.build/start | sh"><pre>$ <span class="pl-s1">curl https://haskell.build/start <span class="pl-k">|</span> sh</span></pre></div>
<p dir="auto">Alternatively, if you want to start a project with bzlmod, run:</p>
<div class="highlight highlight-text-shell-session notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ sh &lt;(curl https://haskell.build/start) --with-bzlmod=true"><pre>$ <span class="pl-s1">sh <span class="pl-s"><span class="pl-pds">&lt;(</span>curl https://haskell.build/start<span class="pl-pds">)</span></span> --with-bzlmod=true</span></pre></div>
<p dir="auto">This will generate initial <code>WORKSPACE</code> and <code>BUILD</code> files for you. See the
<a href="./examples">examples</a> and the <a href="#Rules">API reference</a> below to adapt these for
your project. Then,</p>
<div class="highlight highlight-text-shell-session notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel build //...    # Build all targets
$ bazel test //...     # Run all tests"><pre>$ <span class="pl-s1">bazel build //...    <span class="pl-c"><span class="pl-c">#</span> Build all targets</span></span>
$ <span class="pl-s1">bazel <span class="pl-c1">test</span> //...     <span class="pl-c"><span class="pl-c">#</span> Run all tests</span></span></pre></div>
<p dir="auto">You can learn more about Bazel's command line
syntax <a href="https://docs.bazel.build/versions/master/command-line-reference.html" rel="nofollow">here</a>. Common <a href="https://docs.bazel.build/versions/master/command-line-reference.html#commands" rel="nofollow">commands</a> are
<code>build</code>, <code>test</code>, <code>run</code> and <code>coverage</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Nixpkgs</h3><a id="user-content-nixpkgs" class="anchor" aria-label="Permalink: Nixpkgs" href="#nixpkgs"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This rule set supports using <a href="https://nixos.org/nixpkgs/" rel="nofollow">Nixpkgs</a> to provision your GHC
toolchain and to fetch hackage packages from there. To create your
project, pass <code>--use-nix</code>, like so:</p>
<div class="highlight highlight-text-shell-session notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ sh &lt;(curl https://haskell.build/start) --use-nix"><pre>$ <span class="pl-s1">sh <span class="pl-s"><span class="pl-pds">&lt;(</span>curl https://haskell.build/start<span class="pl-pds">)</span></span> --use-nix</span></pre></div>
<p dir="auto">This generates the same files as above, but uses <code>nixpkgs</code> to
provision GHC.</p>
<p dir="auto">If you are on NixOS, this is the only way to set up your project,
because the GHC toolchain provisioned through binary distributions
cannot be executed on NixOS.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Tutorial and Examples</h2><a id="user-content-tutorial-and-examples" class="anchor" aria-label="Permalink: Tutorial and Examples" href="#tutorial-and-examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">We provide a <a href="https://rules-haskell.readthedocs.io/en/latest/" rel="nofollow">tutorial for writing your first rules</a>.
The corresponding source code is in <a href="./tutorial">./tutorial</a>.</p>
<p dir="auto">A collection of example rules is in <a href="./examples">./examples</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Rules</h2><a id="user-content-rules" class="anchor" aria-label="Permalink: Rules" href="#rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See <a href="https://api.haskell.build" rel="nofollow">https://api.haskell.build</a> for the reference documentation on provided
rules. Using <a href="./serve-docs.sh">./serve-docs.sh</a>, you can also view
this documentation locally.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Troubleshooting</h2><a id="user-content-troubleshooting" class="anchor" aria-label="Permalink: Troubleshooting" href="#troubleshooting"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">No such file or directory</h3><a id="user-content-no-such-file-or-directory" class="anchor" aria-label="Permalink: No such file or directory" href="#no-such-file-or-directory"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you see error messages complaining about missing <code>as</code> (<code>ld</code> or indeed
some other executable):</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="cc: error trying to exec 'as': execvp: No such file or directory
`cc' failed in phase `Assembler'. (Exit code: 1)"><pre class="notranslate"><code>cc: error trying to exec 'as': execvp: No such file or directory
`cc' failed in phase `Assembler'. (Exit code: 1)
</code></pre></div>
<p dir="auto">It means that your <code>gcc</code> cannot find <code>as</code> by itself. This happens only on
certain operating systems which have <code>gcc</code> compiled without <code>--with-as</code> and
<code>--with-ld</code> flags. We need to make <code>as</code> visible manually in that case:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# Create a symlink to system executable 'as'
genrule(
    name = &quot;toolchain_as&quot;,
    outs = [&quot;as&quot;],
    cmd = &quot;ln -s /usr/bin/as $@&quot;,
)

# Make it visible to rules_haskell rules:
haskell_toolchain(
    name = &quot;ghc&quot;,
    tools = [&quot;@ghc//:bin&quot;],
    version = &quot;8.4.1&quot;,
    extra_binaries = [&quot;:toolchain_as&quot;], # &lt;----
)"><pre><span class="pl-c"># Create a symlink to system executable 'as'</span>
<span class="pl-en">genrule</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"toolchain_as"</span>,
    <span class="pl-s1">outs</span> <span class="pl-c1">=</span> [<span class="pl-s">"as"</span>],
    <span class="pl-s1">cmd</span> <span class="pl-c1">=</span> <span class="pl-s">"ln -s /usr/bin/as $@"</span>,
)

<span class="pl-c"># Make it visible to rules_haskell rules:</span>
<span class="pl-en">haskell_toolchain</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"ghc"</span>,
    <span class="pl-s1">tools</span> <span class="pl-c1">=</span> [<span class="pl-s">"@ghc//:bin"</span>],
    <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"8.4.1"</span>,
    <span class="pl-s1">extra_binaries</span> <span class="pl-c1">=</span> [<span class="pl-s">":toolchain_as"</span>], <span class="pl-c"># &lt;----</span>
)</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><code>__STDC_VERSION__</code> does not advertise C99 or later</h3><a id="user-content-__stdc_version__-does-not-advertise-c99-or-later" class="anchor" aria-label="Permalink: __STDC_VERSION__ does not advertise C99 or later" href="#__stdc_version__-does-not-advertise-c99-or-later"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you see an error message like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="/root/.cache/bazel/_bazel_root/b8b1b1d6144a88c698a010767d2217af/external/ghc/lib/ghc-8.4.1/include/Stg.h:29:3: error:
     error: #error __STDC_VERSION__ does not advertise C99 or later
     # error __STDC_VERSION__ does not advertise C99 or later
       ^
   |
29 | # error __STDC_VERSION__ does not advertise C99 or later
   |   ^"><pre class="notranslate"><code>/root/.cache/bazel/_bazel_root/b8b1b1d6144a88c698a010767d2217af/external/ghc/lib/ghc-8.4.1/include/Stg.h:29:3: error:
     error: #error __STDC_VERSION__ does not advertise C99 or later
     # error __STDC_VERSION__ does not advertise C99 or later
       ^
   |
29 | # error __STDC_VERSION__ does not advertise C99 or later
   |   ^
</code></pre></div>
<p dir="auto">It means that your <code>gcc</code> selects incorrect flavor of C by default. We need
C99 or later, as the error message says, so try this:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="haskell_toolchain(
    name = &quot;ghc&quot;,
    tools = [&quot;@ghc//:bin&quot;],
    version = &quot;8.4.1&quot;,
    compiler_flags = [&quot;-optc-std=c99&quot;], # &lt;----
)"><pre><span class="pl-en">haskell_toolchain</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"ghc"</span>,
    <span class="pl-s1">tools</span> <span class="pl-c1">=</span> [<span class="pl-s">"@ghc//:bin"</span>],
    <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"8.4.1"</span>,
    <span class="pl-s1">compiler_flags</span> <span class="pl-c1">=</span> [<span class="pl-s">"-optc-std=c99"</span>], <span class="pl-c"># &lt;----</span>
)</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><code>bazel</code> fails because some executable cannot be found</h3><a id="user-content-bazel-fails-because-some-executable-cannot-be-found" class="anchor" aria-label="Permalink: bazel fails because some executable cannot be found" href="#bazel-fails-because-some-executable-cannot-be-found"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Make sure you run your build in a pure nix shell
(<code>nix-shell --pure shell.nix</code>). If it still doesn’t build,
it is likely a bug.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">A Haskell dependency fails with strange error messages</h3><a id="user-content-a-haskell-dependency-fails-with-strange-error-messages" class="anchor" aria-label="Permalink: A Haskell dependency fails with strange error messages" href="#a-haskell-dependency-fails-with-strange-error-messages"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you get cabal error messages the likes of:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="CallStack (from HasCallStack):
  dieNoWrap, called at libraries/Cabal/Cabal/Distribution/Utils/LogProgress.hs:61:9 in Cabal-2.0.1.0:Distribution.Utils.LogProgress
Error:
    The following packages are broken because other packages they depend on are missing. These broken packages must be rebuilt before they can be used.
installed package lens-labels-0.2.0.1 is broken due to missing package profunctors-5.2.2-HzcVdviprlKb7Ap1woZu4, tagged-0.8.5-HviTdonkllN1ZD6he1Zn8I"><pre class="notranslate"><code>CallStack (from HasCallStack):
  dieNoWrap, called at libraries/Cabal/Cabal/Distribution/Utils/LogProgress.hs:61:9 in Cabal-2.0.1.0:Distribution.Utils.LogProgress
Error:
    The following packages are broken because other packages they depend on are missing. These broken packages must be rebuilt before they can be used.
installed package lens-labels-0.2.0.1 is broken due to missing package profunctors-5.2.2-HzcVdviprlKb7Ap1woZu4, tagged-0.8.5-HviTdonkllN1ZD6he1Zn8I
</code></pre></div>
<p dir="auto">you’ve most likely hit GHC’s
<a href="https://nixos.org/nixpkgs/manual/#how-to-recover-from-ghcs-infamous-non-deterministic-library-id-bug" rel="nofollow">infamous non-deterministic library ID bug</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Warning about home modules during non-sandboxed builds</h3><a id="user-content-warning-about-home-modules-during-non-sandboxed-builds" class="anchor" aria-label="Permalink: Warning about home modules during non-sandboxed builds" href="#warning-about-home-modules-during-non-sandboxed-builds"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Say you have a folder that mixes source files for two different
libraries or for a library and an executable. If you build with
sandboxing turned off, it is possible that GHC will use the source
files for one library during the build of the other. The danger in
this situation is that because GHC used inputs that Bazel didn't know
about, incremental rebuilds might not be correct. This is why you get
a warning of the following form if this happens:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="&lt;no location info&gt;: warning: [-Wmissing-home-modules]
    Modules are not listed in command line but needed for compilation: Foo"><pre class="notranslate"><code>&lt;no location info&gt;: warning: [-Wmissing-home-modules]
    Modules are not listed in command line but needed for compilation: Foo
</code></pre></div>
<p dir="auto">Turning sandboxing on (this is Bazel's default on Linux and macOS)
protects against this problem. If sandboxing is not an option, simply
put the source files for each target in a separate directory (you can
still use a single <code>BUILD</code> file to define all targets).</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">hGetContents: invalid argument (invalid byte sequence)</h3><a id="user-content-hgetcontents-invalid-argument-invalid-byte-sequence" class="anchor" aria-label="Permalink: hGetContents: invalid argument (invalid byte sequence)" href="#hgetcontents-invalid-argument-invalid-byte-sequence"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you are using the GHC bindists and see an error message like this:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="haddock: internal error: /tmp/tmputn68mya/doc/html/path-io/haddock-response300-1.txt: hGetContents: invalid argument (invalid byte sequence)"><pre class="notranslate"><code>haddock: internal error: /tmp/tmputn68mya/doc/html/path-io/haddock-response300-1.txt: hGetContents: invalid argument (invalid byte sequence)
</code></pre></div>
<p dir="auto">It means that the default locale (<code>C.UTF-8</code>) does not work on your system.
You can use a locale that your system has. For example, if your system has the
locale <code>en_US.UTF-8</code>, you can specify that locale:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="rules_haskell_toolchains(
    locale = &quot;en_US.UTF-8&quot;, # &lt;----
    version = &quot;8.4.1&quot;,
)"><pre><span class="pl-en">rules_haskell_toolchains</span>(
    <span class="pl-s1">locale</span> <span class="pl-c1">=</span> <span class="pl-s">"en_US.UTF-8"</span>, <span class="pl-c"># &lt;----</span>
    <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"8.4.1"</span>,
)</pre></div>
<p dir="auto">To find available locales, run <code>locale -a</code> in a terminal. You should see output like the following:</p>
<div class="highlight highlight-text-shell-session notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ locale -a
C
en_US
en_US.iso88591
en_US.utf8
POSIX"><pre>$ <span class="pl-s1">locale -a</span>
<span class="pl-c1">C</span>
<span class="pl-c1">en_US</span>
<span class="pl-c1">en_US.iso88591</span>
<span class="pl-c1">en_US.utf8</span>
<span class="pl-c1">POSIX</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Windows: Incorrect <code>cc_toolchain</code> used</h3><a id="user-content-windows-incorrect-cc_toolchain-used" class="anchor" aria-label="Permalink: Windows: Incorrect cc_toolchain used" href="#windows-incorrect-cc_toolchain-used"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you're using Windows, bazel might use a different <code>cc_toolchain</code>
than is required to build. This might happen if the environment has a
<code>cc_toolchain</code> from Visual Studio. This might show up with an error like:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="Traceback (most recent call last):
  File &quot;\\?\C:\Users\appveyor\AppData\Local\Temp\1\Bazel.runfiles_w5rfpqk5\runfiles\rules_haskell\haskell\cabal_wrapper.py&quot;, line 105, in &lt;module&gt;
    strip = find_exe(&quot;external/local_config_cc/wrapper/bin/msvc_nop.bat&quot;)
  File &quot;\\?\C:\Users\appveyor\AppData\Local\Temp\1\Bazel.runfiles_w5rfpqk5\runfiles\rules_haskell\haskell\cabal_wrapper.py&quot;, line 56, in find_exe
    if not os.path.isfile(path) and &quot;True&quot; == &quot;True&quot;:
  File &quot;C:\Python37\lib\genericpath.py&quot;, line 30, in isfile
    st = os.stat(path)
TypeError: stat: path should be string, bytes, os.PathLike or integer, not NoneType"><pre class="notranslate"><code>Traceback (most recent call last):
  File "\\?\C:\Users\appveyor\AppData\Local\Temp\1\Bazel.runfiles_w5rfpqk5\runfiles\rules_haskell\haskell\cabal_wrapper.py", line 105, in &lt;module&gt;
    strip = find_exe("external/local_config_cc/wrapper/bin/msvc_nop.bat")
  File "\\?\C:\Users\appveyor\AppData\Local\Temp\1\Bazel.runfiles_w5rfpqk5\runfiles\rules_haskell\haskell\cabal_wrapper.py", line 56, in find_exe
    if not os.path.isfile(path) and "True" == "True":
  File "C:\Python37\lib\genericpath.py", line 30, in isfile
    st = os.stat(path)
TypeError: stat: path should be string, bytes, os.PathLike or integer, not NoneType
</code></pre></div>
<p dir="auto">You can override the <code>cc_toolchain</code> chosen with the following flag:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="--crosstool_top=@rules_haskell_ghc_windows_amd64//:cc_toolchain"><pre class="notranslate"><code>--crosstool_top=@rules_haskell_ghc_windows_amd64//:cc_toolchain
</code></pre></div>
<p dir="auto">This chooses the <code>cc_toolchain</code> bundled with GHC.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">GHC settings file does not exist</h3><a id="user-content-ghc-settings-file-does-not-exist" class="anchor" aria-label="Permalink: GHC settings file does not exist" href="#ghc-settings-file-does-not-exist"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you use the GHC bindist toolchain, i.e. <code>haskell_register_ghc_bindists</code>, then you may encounter the following type of error with packages that use the GHC API, e.g. <code>doctest</code>, <code>ghcide</code>, or <code>proto-lens-protoc</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content=".../lib/settings: openFile: does not exist (No such file or directory)"><pre class="notranslate"><code>.../lib/settings: openFile: does not exist (No such file or directory)
</code></pre></div>
<p dir="auto">This could be caused by a dependency on the <code>ghc-paths</code> package which bakes the path to the GHC installation at build time into the binary. In the GHC bindist use case this path points into Bazel's sandbox working directory which can change between build actions and between build-time and runtime.</p>
<p dir="auto">You can use <code>@rules_haskell//tools/ghc-paths</code> as a drop-in replacement to work around this issue. See <code>tools/ghc-paths/README.md</code> for further details.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Windows: protoc.exe exits with an error</h3><a id="user-content-windows-protocexe-exits-with-an-error" class="anchor" aria-label="Permalink: Windows: protoc.exe exits with an error" href="#windows-protocexe-exits-with-an-error"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you see</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="protoc.exe: error while loading shared libraries: api-ms-win-crt-filesystem-l1-1-0.dll: cannot open shared object file: No such file or directory"><pre class="notranslate"><code>protoc.exe: error while loading shared libraries: api-ms-win-crt-filesystem-l1-1-0.dll: cannot open shared object file: No such file or directory
</code></pre></div>
<p dir="auto">or</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="Process finished with exit code -1073741515 (0xC0000135)"><pre class="notranslate"><code>Process finished with exit code -1073741515 (0xC0000135)
</code></pre></div>
<p dir="auto">this usually means the executable cannot find a DLL it depends on (not necessarily the DLL that is mentioned in the error message).</p>
<p dir="auto">Newer Windows GHC distributions (&gt;= 9.4), come with clang as the C/C++ compiler, and executables produced using that toolchain depend on the libc++ DLL, which is found in the <code>mingw\bin</code> directory of the bindist. You can pass <code>--proto_compiler @rules_haskell//tests:protoc</code> as a build flag to bazel as a workaround (see [tests/protoc.bzl]).</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">For <code>rules_haskell</code> developers</h2><a id="user-content-for-rules_haskell-developers" class="anchor" aria-label="Permalink: For rules_haskell developers" href="#for-rules_haskell-developers"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Configuring your platform</h3><a id="user-content-configuring-your-platform" class="anchor" aria-label="Permalink: Configuring your platform" href="#configuring-your-platform"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>rules_haskell</code> can be built and tested on Linux, MacOS, and Windows. Depending
on the platform GHC can be provisioned using nixpkgs or by downloading a binary
distribution. In case of nixpkgs other toolchains (C compiler, Python, shell
tools) will also be provided by nixpkgs, in case of bindist they will be taken
from the environment (<code>$PATH</code>). The following <code>--config</code> options select the
corresponding combination of operating system and GHC distribution:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th></th>
<th>Linux</th>
<th>MacOS</th>
<th>Windows</th>
</tr>
</thead>
<tbody>
<tr>
<td>nixpkgs</td>
<td><code>linux-nixpkgs</code></td>
<td><code>macos-nixpkgs</code></td>
<td></td>
</tr>
<tr>
<td>binary distribution</td>
<td><code>linux-bindist</code></td>
<td><code>macos-bindist</code></td>
<td><code>windows-bindist</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Hint: You can use Bazel's <code>--announce_rc</code> flag to see what options are being
used for a command in a specific configuration. E.g.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ bazel build //tests:run-tests --config linux-nixpkgs --nobuild --announce_rc"><pre class="notranslate"><code>$ bazel build //tests:run-tests --config linux-nixpkgs --nobuild --announce_rc
</code></pre></div>
<p dir="auto">Hint: To avoid repetition you can add your configuration to <code>.bazelrc.local</code>.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="echo &quot;build --config=linux-nixpkgs&quot; &gt;&gt;.bazelrc.local"><pre class="notranslate"><code>echo "build --config=linux-nixpkgs" &gt;&gt;.bazelrc.local
</code></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Saving common command-line flags to a file</h3><a id="user-content-saving-common-command-line-flags-to-a-file" class="anchor" aria-label="Permalink: Saving common command-line flags to a file" href="#saving-common-command-line-flags-to-a-file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If you find yourself constantly passing the same flags on the
command-line for certain commands (such as <code>--host_platform</code> or
<code>--compiler</code>), you can augment the <a href="./.bazelrc"><code>.bazelrc</code></a> file in
this repository with a <code>.bazelrc.local</code> file. This file is ignored by
Git.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Reference a local checkout of <code>rules_haskell</code></h3><a id="user-content-reference-a-local-checkout-of-rules_haskell" class="anchor" aria-label="Permalink: Reference a local checkout of rules_haskell" href="#reference-a-local-checkout-of-rules_haskell"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">When you develop on <code>rules_haskell</code>, you usually do it in the context
of a different project that has <code>rules_haskell</code> as a <code>WORKSPACE</code>
dependency, like so:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="http_archive(
    name = &quot;rules_haskell&quot;,
    strip_prefix = &quot;rules_haskell-&quot; + version,
    sha256 = …,
    urls = …,
)"><pre class="notranslate"><code>http_archive(
    name = "rules_haskell",
    strip_prefix = "rules_haskell-" + version,
    sha256 = …,
    urls = …,
)
</code></pre></div>
<p dir="auto">To reference a local checkout instead, use the
<a href="https://docs.bazel.build/versions/master/command-line-reference.html#flag--override_repository" rel="nofollow"><code>--override_repository</code></a> command line option:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel build/test/run/sync \
  --override_repository rules_haskell=/path/to/checkout"><pre class="notranslate"><code>bazel build/test/run/sync \
  --override_repository rules_haskell=/path/to/checkout
</code></pre></div>
<p dir="auto">If you don’t want to type that every time, <a href="https://docs.bazel.build/versions/master/best-practices.html#bazelrc" rel="nofollow">temporarily add it to
<code>.bazelrc</code></a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Test Suite</h3><a id="user-content-test-suite" class="anchor" aria-label="Permalink: Test Suite" href="#test-suite"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To run the test suite for these rules, you'll need <a href="https://nixos.org/nix" rel="nofollow">Nix</a>
installed. First, from the project’s folder start a pure nix shell:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ nix-shell --pure shell.nix"><pre class="notranslate"><code>$ nix-shell --pure shell.nix
</code></pre></div>
<p dir="auto">This will make sure that bazel has the exact same environment
on every development system (<code>python</code>, <code>ghc</code>, <code>go</code>, …).</p>
<p dir="auto">To build and run tests locally, execute:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ bazel test //... &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel test //..."><pre class="notranslate"><code>$ bazel test //... &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel test //...
</code></pre></div>
<p dir="auto">Starlark code in this project is formatted according to the output of
<a href="https://github.com/bazelbuild/buildtools/tree/master/buildifier">buildifier</a>. You can check that the formatting is correct using:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ bazel run //buildifier &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel run //buildifier"><pre class="notranslate"><code>$ bazel run //buildifier &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel run //buildifier
</code></pre></div>
<p dir="auto">If tests fail then run the following to fix the formatting:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="$ git rebase --exec &quot;bazel run //buildifier:buildifier-fix &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel run //buildifier:buildifier-fix&quot; &lt;first commit&gt;"><pre class="notranslate"><code>$ git rebase --exec "bazel run //buildifier:buildifier-fix &amp;&amp; cd rules_haskell_tests &amp;&amp; bazel run //buildifier:buildifier-fix" &lt;first commit&gt;
</code></pre></div>
<p dir="auto">where <code>&lt;first commit&gt;</code> is the first commit in your pull request.
This fixes formatting for each of your commits separately, to keep
the history clean.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto"><a name="user-content-nixpkgs-pin">How to update the nixpkgs pin</a></h3><a id="user-content-how-to-update-the-nixpkgs-pin" class="anchor" aria-label="Permalink: How to update the nixpkgs pin" href="#how-to-update-the-nixpkgs-pin"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You have to find a new git commit where all our <code>shell.nix</code>
dependencies are available from the official NixOS Hydra binary cache.</p>
<p dir="auto">At least for <code>x86-linux</code> this is guaranteed for the <code>unstable</code>
channels. You can find the <code>nixpkgs</code> git commit of current <code>unstable</code>
here:</p>
<p dir="auto"><a href="https://nixos.org/channels/nixos-unstable/git-revision" rel="nofollow">https://nixos.org/channels/nixos-unstable/git-revision</a></p>
<p dir="auto">That might be too old for your use-case (because all tests have to
pass for that channel to be updated), so as a fallback there is:</p>
<p dir="auto"><a href="https://nixos.org/channels/nixos-unstable-small/git-revision" rel="nofollow">https://nixos.org/channels/nixos-unstable-small/git-revision</a></p>
<p dir="auto">You copy that hash to <code>url</code> in
<a href="./nixpkgs/default.nix"><code>./nixpkgs/default.nix</code></a>. Don’t forget to
change the <code>sha256</code> or it will use the old version. Please update the
date comment to the date of the <code>nixpkgs</code> commit you are pinning to.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">GitHub Actions Cache</h3><a id="user-content-github-actions-cache" class="anchor" aria-label="Permalink: GitHub Actions Cache" href="#github-actions-cache"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The GitHub actions CI pipeline uses
<a href="https://github.com/actions/cache"><code>actions/cache</code></a> to store the Bazel
repository cache. The <code>cache-version</code> must be updated manually in the <code>env</code>
section in the <a href="./.github/workflows/workflow.yaml">workflow</a> to invalidate the
cache if any cacheable external dependencies are changed.</p>
<div class="markdown-heading" dir="auto"><h4 class="heading-element" dir="auto">“unable to start any build”</h4><a id="user-content-unable-to-start-any-build" class="anchor" aria-label="Permalink: “unable to start any build”" href="#unable-to-start-any-build"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="error: unable to start any build; either increase '--max-jobs' or enable remote builds"><pre class="notranslate"><code>error: unable to start any build; either increase '--max-jobs' or enable remote builds
</code></pre></div>
<p dir="auto">We set <code>--builders ""</code> and <code>--max-jobs 0</code> on CI to be sure all
dependencies are coming from binary caches. You might need to add an
exception (TODO: where to add exception) or <a href="#nixpkgs-pin">switch to a different
nixpkgs pin</a>.</p>
</article></div>