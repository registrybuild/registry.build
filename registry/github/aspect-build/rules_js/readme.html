<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Bazel rules for JavaScript</h1><a id="user-content-bazel-rules-for-javascript" class="anchor" aria-label="Permalink: Bazel rules for JavaScript" href="#bazel-rules-for-javascript"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This ruleset is a high-performance and npm-compatible Bazel integration for JavaScript.</p>
<ul dir="auto">
<li>Lazy: only fetches/installs npm packages needed for the requested build/test targets.</li>
<li>Correct: works seamlessly with node.js module resolution. For example there are no pathMapping issues with TypeScript <code>rootDirs</code>.</li>
<li>Fast: Bazel's sandbox only sees npm packages as directories, not individual files.</li>
<li>Supports npm "workspaces": nested npm packages in a monorepo.</li>
</ul>
<p dir="auto">Many companies are successfully building with rules_js. If you're getting value from the project, please let us know! Just comment on our <a href="https://github.com/aspect-build/rules_js/discussions/1000" data-hovercard-type="discussion" data-hovercard-url="/aspect-build/rules_js/discussions/1000/hovercard">Adoption Discussion</a>.</p>
<p dir="auto"><a href="https://blog.aspect.build/rulesjs-npm-benchmarks" rel="nofollow">https://blog.aspect.build/rulesjs-npm-benchmarks</a> shows benchmarks for fetching, installing, and linking packages under rules_js as well as typical alternatives like npm and yarn.</p>
<p dir="auto">Google does not fund development of rules_js. If your company benefits, please consider donating to continue development and maintenance work: <a href="https://opencollective.com/aspect-build/projects/rules_js" rel="nofollow">https://opencollective.com/aspect-build/projects/rules_js</a></p>
<p dir="auto">rules_js is just a part of what Aspect provides:</p>
<ul dir="auto">
<li><em>Need help?</em>
<ul dir="auto">
<li>Community support is available on the #javascript channel on <a href="https://slack.bazel.build/" rel="nofollow">Bazel Slack</a></li>
<li>This ruleset has commercial support provided by <a href="https://aspect.build/services" rel="nofollow">https://aspect.build/services</a>.</li>
</ul>
</li>
<li>See our other Bazel rules, especially those built for rules_js:
<ul dir="auto">
<li><a href="https://github.com/aspect-build/rules_ts">rules_ts</a> - Bazel rules for <a href="http://typescriptlang.org" rel="nofollow">TypeScript</a></li>
<li><a href="https://github.com/aspect-build/rules_swc">rules_swc</a> - Bazel rules for <a href="https://swc.rs" rel="nofollow">swc</a></li>
<li><a href="https://github.com/aspect-build/rules_jest">rules_jest</a> - Bazel rules to run tests using <a href="https://jestjs.io" rel="nofollow">Jest</a></li>
<li><a href="https://github.com/aspect-build/rules_esbuild">rules_esbuild</a> - Bazel rules for <a href="https://esbuild.github.io" rel="nofollow">esbuild</a> JS bundler</li>
<li><a href="https://github.com/aspect-build/rules_webpack">rules_webpack</a> - Bazel rules for <a href="https://webpack.js.org" rel="nofollow">Webpack</a></li>
<li><a href="https://github.com/aspect-build/rules_rollup">rules_rollup</a> - Bazel rules for <a href="https://rollupjs.org" rel="nofollow">Rollup</a> - a JavaScript bundler</li>
<li><a href="https://github.com/aspect-build/rules_jasmine">rules_jasmine</a> - Bazel rules to run tests using <a href="https://jasmine.github.io/" rel="nofollow">Jasmine</a></li>
<li><a href="https://github.com/aspect-build/rules_terser">rules_terser</a> - Bazel rules for <a href="https://terser.org" rel="nofollow">Terser</a> - a JavaScript minifier</li>
<li><a href="https://github.com/aspect-build/rules_cypress">rules_cypress</a> - Bazel rules to run tests using <a href="https://cypress.io" rel="nofollow">Cypress</a></li>
</ul>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Bazel compatibility</h2><a id="user-content-bazel-compatibility" class="anchor" aria-label="Permalink: Bazel compatibility" href="#bazel-compatibility"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The ruleset is known to work with:</p>
<ul dir="auto">
<li>Bazel 7 using WORKSPACE and Bzlmod <em>(tested on CI)</em></li>
<li>Bazel 6 using WORKSPACE and Bzlmod <em>(tested on CI)</em></li>
<li>Bazel 5 using WORKSPACE <em>(no longer tested on CI)</em></li>
</ul>
<div class="markdown-alert markdown-alert-note" dir="auto"><p class="markdown-alert-title" dir="auto"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">Remote Execution (RBE) requires at least Bazel <a href="https://blog.bazel.build/2022/12/19/bazel-6.0.html" rel="nofollow">6.0</a>.</p>
</div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Known issues</h2><a id="user-content-known-issues" class="anchor" aria-label="Permalink: Known issues" href="#known-issues"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>ESM imports escape the runfiles tree and the sandbox due to <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="1330168243" data-permission-text="Title is private" data-url="https://github.com/aspect-build/rules_js/issues/362" data-hovercard-type="issue" data-hovercard-url="/aspect-build/rules_js/issues/362/hovercard" href="https://github.com/aspect-build/rules_js/issues/362">#362</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Installation</h2><a id="user-content-installation" class="anchor" aria-label="Permalink: Installation" href="#installation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">From the release you wish to use:
<a href="https://github.com/aspect-build/rules_js/releases">https://github.com/aspect-build/rules_js/releases</a>
copy the WORKSPACE snippet into your <code>WORKSPACE</code> file.</p>
<p dir="auto">To use a commit rather than a release, you can point at any SHA of the repo.</p>
<p dir="auto">For example to use commit <code>abc123</code>:</p>
<ol dir="auto">
<li>Replace <code>url = "https://github.com/aspect-build/rules_js/releases/download/v0.1.0/rules_js-v0.1.0.tar.gz"</code>
with a GitHub-provided source archive like
<code>url = "https://github.com/aspect-build/rules_js/archive/abc123.tar.gz"</code></li>
<li>Replace <code>strip_prefix = "rules_js-0.1.0"</code> with <code>strip_prefix = "rules_js-abc123"</code></li>
<li>Update the <code>sha256</code>. The easiest way to do this is to comment out the line, then Bazel will
print a message with the correct value.</li>
</ol>
<blockquote>
<p dir="auto">Note that GitHub source archives don't have a strong guarantee on the sha256 stability, see
<a href="https://github.blog/2023-02-21-update-on-the-future-stability-of-source-code-archives-and-hashes" rel="nofollow">https://github.blog/2023-02-21-update-on-the-future-stability-of-source-code-archives-and-hashes</a></p>
</blockquote>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See the documentation in the <a href="docs/">docs</a> folder.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Examples</h2><a id="user-content-examples" class="anchor" aria-label="Permalink: Examples" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Basic usage examples can be found under the <a href="https://github.com/aspect-build/rules_js/tree/main/examples">examples</a> folder.</p>
<blockquote>
<p dir="auto">Note that the examples also rely on code in the <code>/WORKSPACE</code> file in the root of this repo.</p>
</blockquote>
<p dir="auto">The <a href="https://github.com/aspect-build/rules_js/tree/main/e2e">e2e</a> folder also has a few useful examples such as <a href="https://github.com/aspect-build/rules_js/tree/main/e2e/js_image_oci">js_image_layer</a> for containerizing a js_binary and <a href="https://github.com/aspect-build/rules_js/tree/main/e2e/js_run_devserver">js_run_devserver</a>, a generic rule for running a devserver in watch mode with <a href="https://github.com/bazelbuild/bazel-watcher">ibazel</a>.</p>
<p dir="auto">Larger examples can be found in our <a href="https://github.com/aspect-build/bazel-examples">bazel-examples</a> repository including:</p>
<ul dir="auto">
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/next.js">Next.js</a> / <a href="https://github.com/aspect-build/rules_ts">rules_ts</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/angular">Angular (cli/architect)</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/angular-ngc">Angular (ngc)</a> / <a href="https://github.com/aspect-build/rules_ts">rules_ts</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/react-cra">React (create-react-app)</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/vue">Vue</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/jest">Jest</a> / <a href="https://github.com/aspect-build/rules_jest">rules_jest</a></li>
<li><a href="https://github.com/aspect-build/bazel-examples/tree/main/nestjs">NestJS</a> / <a href="https://github.com/aspect-build/rules_ts">rules_ts</a>, <a href="https://github.com/aspect-build/rules_swc">rules_swc</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Relationship to rules_nodejs</h2><a id="user-content-relationship-to-rules_nodejs" class="anchor" aria-label="Permalink: Relationship to rules_nodejs" href="#relationship-to-rules_nodejs"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">rules_js is an alternative to the <code>build_bazel_rules_nodejs</code> Bazel module and
accompanying npm packages hosted in <a href="https://github.com/bazelbuild/rules_nodejs">https://github.com/bazelbuild/rules_nodejs</a>,
which is now unmaintained. All users are recommended to use rules_js instead.</p>
<p dir="auto">rules_js replaces some parts of <a href="http://github.com/bazelbuild/rules_nodejs">bazelbuild/rules_nodejs</a> and re-uses other parts:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Layer</th>
<th>Legacy</th>
<th>Modern</th>
</tr>
</thead>
<tbody>
<tr>
<td>Custom rules</td>
<td><code>npm:@bazel/typescript</code>, etc.</td>
<td><code>aspect_rules_ts</code>, etc.</td>
</tr>
<tr>
<td>Package manager and Basic rules</td>
<td><code>build_bazel_rules_nodejs</code></td>
<td><code>aspect_rules_js</code></td>
</tr>
<tr>
<td>Toolchain and core providers</td>
<td><code>rules_nodejs</code></td>
<td><code>rules_nodejs</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">The common layer here is the <code>rules_nodejs</code> Bazel module, documented as the "core" in
<a href="https://bazelbuild.github.io/rules_nodejs/" rel="nofollow">https://bazelbuild.github.io/rules_nodejs/</a>:</p>
<blockquote>
<p dir="auto">It is currently useful for Bazel Rules developers who want to make their own JavaScript support.</p>
</blockquote>
<p dir="auto">That's what <code>rules_js</code> does! It's a completely different approach to making JS tooling work under Bazel.</p>
<p dir="auto">First, there's dependency management.</p>
<ul dir="auto">
<li><code>build_bazel_rules_nodejs</code> uses existing package managers by calling <code>npm install</code> or <code>yarn install</code> on a whole <code>package.json</code>.</li>
<li><code>rules_js</code> uses Bazel's downloader to fetch only the packages needed for the requested targets, then mimics <a href="https://pnpm.io/" rel="nofollow"><code>pnpm</code></a> to lay out a <code>node_modules</code> tree.</li>
</ul>
<p dir="auto">Then, there's how a Node.js tool can be executed:</p>
<ul dir="auto">
<li><code>build_bazel_rules_nodejs</code> follows the Bazel idiom: sources in one folder, outputs in another.</li>
<li><code>rules_js</code> follows the npm idiom: sources and outputs together in a common folder.</li>
</ul>
<p dir="auto">There are trade-offs involved here, but we think the <code>rules_js</code> approach is superior for all users,
especially those at large scale. Read below for more in-depth discussion of the design differences
and trade-offs you should be aware of.
Also see the <a href="https://hackmd.io/@aspect/rules_js" rel="nofollow">slides for our Bazel eXchange talk</a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Design</h2><a id="user-content-design" class="anchor" aria-label="Permalink: Design" href="#design"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The authors of <code>rules_js</code> spent four years writing and re-writing <code>build_bazel_rules_nodejs</code>.
We learned a lot from that project, as well as from discussions with <a href="https://rushjs.io/" rel="nofollow">Rush</a> maintainer <a href="https://github.com/octogonz">@octogonz</a>.</p>
<p dir="auto">There are two core problems:</p>
<ul dir="auto">
<li>How do you install third-party dependencies?</li>
<li>How does a running Node.js program resolve those dependencies?</li>
</ul>
<p dir="auto">And there's a fundamental trade-off: make it fast and deterministic, or support 100% of existing use cases.</p>
<p dir="auto">Over the years we tried a number of solutions and each end of the trade-off spectrum.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Installing third-party libraries</h3><a id="user-content-installing-third-party-libraries" class="anchor" aria-label="Permalink: Installing third-party libraries" href="#installing-third-party-libraries"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Downloading packages should be Bazel's job. It has a full featured remote downloader, with a content-address-cached (confusingly called the "repository cache"). We now mirror pnpm's lock file
into starlark code, then use only Bazel repository rules to perform fetches and translate the
dependency graph into Bazel's representation.</p>
<p dir="auto">For historical context, we started thinking about this in February 2021 in a (now outdated) <a href="https://hackmd.io/gu2Nj0TKS068LKAf8KanuA" rel="nofollow">design doc</a>
and have been working through the details since then.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Running Node.js programs</h3><a id="user-content-running-nodejs-programs" class="anchor" aria-label="Permalink: Running Node.js programs" href="#running-nodejs-programs"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Fundamentally, Bazel operates out of a different filesystem layout than Node.
Bazel keeps outputs in a distinct tree outside of the sources.</p>
<p dir="auto">Our first attempt was based on what Yarn PnP and Google-internal Node.js rules do:
monkey-patch the implementation of <code>require</code> in NodeJS itself,
so that every resolution can be aware of the source/output tree difference.
The main downside to this is compatibility: many packages on npm make their own assumptions about
how to resolve dependencies without asking the <code>require</code> implementation, and you can't patch them all.
Unlike Google, most of us don't want to re-write all the npm packages we use to be compatible.</p>
<p dir="auto">Our second attempt was essentially to run <code>npm link</code> before running a program, using a runtime linker.
This was largely successful at papering over the filesystem layout differences without disrupting
execution of programs. However, it required a lot of workarounds anytime a JS tool wanted to be
aware of the input and output locations on disk. For example, many tools like react-scripts (the
build system used by Create React App aka. CRA) insist on writing their outputs relative to the
working directory. Such programs were forced to be run with Bazel's output folder as the working
directory, and their sources copied to that location.</p>
<p dir="auto"><code>rules_js</code> takes a better approach, where we follow that react-scripts-prompted workaround to the
extreme. We <em>always</em> run JS tools with the working directory in Bazel's output tree.
We can use a <code>pnpm</code>-style layout tool to create a <code>node_modules</code> under <code>bazel-out</code>, and all resolutions
naturally work.</p>
<p dir="auto">This third approach has trade-offs.</p>
<ul dir="auto">
<li>The benefit is that very intractable problems like TypeScript's <code>rootDirs</code> just go away.
In that example, we filed <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="580388985" data-permission-text="Title is private" data-url="https://github.com/microsoft/TypeScript/issues/37378" data-hovercard-type="issue" data-hovercard-url="/microsoft/TypeScript/issues/37378/hovercard" href="https://github.com/microsoft/TypeScript/issues/37378">microsoft/TypeScript#37378</a> but it probably
won't be solved, so many users trip over issues like
<a href="https://github.com/bazelbuild/rules_nodejs/issues/3423" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_nodejs/issues/3423/hovercard">this</a> and
<a href="https://github.com/bazelbuild/rules_nodejs/issues/3421" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_nodejs/issues/3421/hovercard">this</a>. Now this just works, plus results like sourcemaps look like users expect: just like they would if the tool had written outputs in the source tree.</li>
<li>The downside is that Bazel rules/macro authors (even <code>genrule</code> authors) must re-path
inputs and outputs to account for the working directory under <code>bazel-out</code>,
and must ensure that sources are copied there first.
This forces users to pass a <code>BAZEL_BINDIR</code> in the environment of every node action.
<a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="1233212314" data-permission-text="Title is private" data-url="https://github.com/bazelbuild/bazel/issues/15470" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/bazel/issues/15470/hovercard" href="https://github.com/bazelbuild/bazel/issues/15470">bazelbuild/bazel#15470</a> suggests a way to improve that, avoiding that imposition on users.</li>
</ul>
</article></div>