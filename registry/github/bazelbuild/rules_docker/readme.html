<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-bazel-container-image-rules" class="anchor" aria-hidden="true" tabindex="-1" href="#bazel-container-image-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Bazel Container Image Rules</h1>
<table>
<thead>
<tr>
<th align="center">Bazel CI</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><a href="https://buildkite.com/bazel/docker-rules-docker-postsubmit" rel="nofollow"><img src="https://camo.githubusercontent.com/054fc44b4de5dc39f0b03b4039a47a5ff86e80550e0be6dfb52d7f62e6ad5620/68747470733a2f2f62616467652e6275696c646b6974652e636f6d2f36393364373839323235306366643434626565613363643935353733333838323030393335393036613238636433313436642e7376673f6272616e63683d6d6173746572" alt="Build status" data-canonical-src="https://badge.buildkite.com/693d7892250cfd44beea3cd95573388200935906a28cd3146d.svg?branch=master" style="max-width: 100%;"></a></td>
</tr>
</tbody>
</table>
<h2 dir="auto"><a id="user-content-status" class="anchor" aria-hidden="true" tabindex="-1" href="#status"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Status</h2>
<p dir="auto">ðŸš¨ rules_docker is no longer maintained and deprecated. Please see <a href="https://github.com/bazel-contrib/rules_oci">rules_oci</a> for a better designed and maintained alternative.</p>
<h2 dir="auto"><a id="user-content-basic-rules" class="anchor" aria-hidden="true" tabindex="-1" href="#basic-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Basic Rules</h2>
<ul dir="auto">
<li><a href="/docs/container.md#container_image">container_image</a> (<a href="#container_image">example</a>)</li>
<li><a href="/docs/container.md#container_bundle">container_bundle</a> (<a href="#container_bundle">example</a>)</li>
<li><a href="/docs/container.md#container_import">container_import</a></li>
<li><a href="/docs/container.md#container_load">container_load</a></li>
<li><a href="/docs/container.md#container_pull">container_pull</a> (<a href="#container_pull">example</a>)</li>
<li><a href="/docs/container.md#container_push">container_push</a> (<a href="#container_push">example</a>)</li>
</ul>
<p dir="auto">These rules used to be <code>docker_build</code>, <code>docker_push</code>, etc. and the aliases for
these (mostly) legacy names still exist largely for backwards-compatibility.  We
also have <strong>early-stage</strong> <code>oci_image</code>, <code>oci_push</code>, etc. aliases for folks that
enjoy the consistency of a consistent rule prefix.  The only place the
format-specific names currently do any more than alias things is in <code>foo_push</code>,
where they also specify the appropriate format as which to publish the image.</p>
<h3 dir="auto"><a id="user-content-overview" class="anchor" aria-hidden="true" tabindex="-1" href="#overview"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Overview</h3>
<p dir="auto">This repository contains a set of rules for pulling down base images, augmenting
them with build artifacts and assets, and publishing those images.
<strong>These rules do not require / use Docker for pulling, building, or pushing
images.</strong>  This means:</p>
<ul dir="auto">
<li>They can be used to develop Docker containers on OSX without
<code>boot2docker</code> or <code>docker-machine</code> installed. Note use of these rules on Windows
is currently not supported.</li>
<li>They do not require root access on your workstation.</li>
</ul>
<p dir="auto">Also, unlike traditional container builds (e.g. Dockerfile), the Docker images
produced by <code>container_image</code> are deterministic / reproducible.</p>
<p dir="auto">To get started with building Docker images, check out the
<a href="https://github.com/bazelbuild/rules_docker/tree/master/testing/examples">examples</a>
that build the same images using both rules_docker and a Dockerfile.</p>
<p dir="auto"><strong>NOTE:</strong> <code>container_push</code> and <code>container_pull</code> make use of
<a href="https://github.com/google/go-containerregistry">google/go-containerregistry</a> for
registry interactions.</p>
<h2 dir="auto"><a id="user-content-language-rules" class="anchor" aria-hidden="true" tabindex="-1" href="#language-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Language Rules</h2>
<ul dir="auto">
<li><a href="#py_image">py_image</a> (<a href="https://docs.bazel.build/versions/master/be/python.html#py_binary" rel="nofollow">signature</a>)</li>
<li><a href="#py3_image">py3_image</a> (<a href="https://docs.bazel.build/versions/master/be/python.html#py_binary" rel="nofollow">signature</a>)</li>
<li><a href="#nodejs_image">nodejs_image</a> (<a href="https://github.com/bazelbuild/rules_nodejs#usage">usage</a>)</li>
<li><a href="#java_image">java_image</a> (<a href="https://docs.bazel.build/versions/master/be/java.html#java_binary" rel="nofollow">signature</a>)</li>
<li><a href="#war_image">war_image</a> (<a href="https://docs.bazel.build/versions/master/be/java.html#java_library" rel="nofollow">signature</a>)</li>
<li><a href="#scala_image">scala_image</a> (<a href="https://github.com/bazelbuild/rules_scala#scala_binary">signature</a>)</li>
<li><a href="#groovy_image">groovy_image</a> (<a href="https://github.com/bazelbuild/rules_groovy#groovy_binary">signature</a>)</li>
<li><a href="#cc_image">cc_image</a> (<a href="https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary" rel="nofollow">signature</a>)</li>
<li><a href="#go_image">go_image</a> (<a href="https://github.com/bazelbuild/rules_go#go_binary">signature</a>)</li>
<li><a href="#rust_image">rust_image</a> (<a href="https://github.com/bazelbuild/rules_rust#rust_binary">signature</a>)</li>
<li><a href="#d_image">d_image</a> (<a href="https://github.com/bazelbuild/rules_d#d_binary">signature</a>)</li>
</ul>
<p dir="auto">It is notable that: <code>cc_image</code>, <code>go_image</code>, <code>rust_image</code>, and <code>d_image</code>
also allow you to specify an external binary target.</p>
<h2 dir="auto"><a id="user-content-docker-rules" class="anchor" aria-hidden="true" tabindex="-1" href="#docker-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Docker Rules</h2>
<p dir="auto">This repo now includes rules that provide additional functionality
to install packages and run commands inside docker containers. These
rules, however, require a docker binary is present and properly
configured. These rules include:</p>
<ul dir="auto">
<li><a href="docker/package_managers/README.md">Package manager rules</a>: rules to install
apt-get packages.</li>
<li><a href="docker/util/README.md">Docker run rules</a>: rules to run commands inside docker
containers.</li>
</ul>
<h3 dir="auto"><a id="user-content-overview-1" class="anchor" aria-hidden="true" tabindex="-1" href="#overview-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Overview</h3>
<p dir="auto">In addition to low-level rules for building containers, this repository
provides a set of higher-level rules for containerizing applications.  The idea
behind these rules is to make containerizing an application built via a
<code>lang_binary</code> rule as simple as changing it to <code>lang_image</code>.</p>
<p dir="auto">By default these higher level rules make use of the <a href="https://github.com/googlecloudplatform/distroless"><code>distroless</code></a> language runtimes, but these
can be overridden via the <code>base="..."</code> attribute (e.g. with a <code>container_pull</code>
or <code>container_image</code> target).</p>
<p dir="auto">Note also that these rules do not expose any docker related attributes. If you
need to add a custom <code>env</code> or <code>symlink</code> to a <code>lang_image</code>, you must use
<code>container_image</code> targets for this purpose. Specifically, you can use as base for your
<code>lang_image</code> target a <code>container_image</code> target that adds e.g., custom <code>env</code> or <code>symlink</code>.
Please see <a href="#go_image-custom-base">go_image (custom base)</a> for an example.</p>
<h2 dir="auto"><a id="user-content-setup" class="anchor" aria-hidden="true" tabindex="-1" href="#setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Setup</h2>
<p dir="auto">Add the following to your <code>WORKSPACE</code> file to add the external repositories:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

http_archive(
  # Get copy paste instructions for the http_archive attributes from the
  # release notes at https://github.com/bazelbuild/rules_docker/releases
)

# OPTIONAL: Call this to override the default docker toolchain configuration.
# This call should be placed BEFORE the call to &quot;container_repositories&quot; below
# to actually override the default toolchain configuration.
# Note this is only required if you actually want to call
# docker_toolchain_configure with a custom attr; please read the toolchains
# docs in /toolchains/docker/ before blindly adding this to your WORKSPACE.
# BEGIN OPTIONAL segment:
load(&quot;@io_bazel_rules_docker//toolchains/docker:toolchain.bzl&quot;,
    docker_toolchain_configure=&quot;toolchain_configure&quot;
)
docker_toolchain_configure(
  name = &quot;docker_config&quot;,
  # OPTIONAL: Bazel target for the build_tar tool, must be compatible with build_tar.py
  build_tar_target=&quot;&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable build_tar target&gt;&quot;,
  # OPTIONAL: Path to a directory which has a custom docker client config.json.
  # See https://docs.docker.com/engine/reference/commandline/cli/#configuration-files
  # for more details.
  client_config=&quot;&lt;enter Bazel label to your docker config.json here&gt;&quot;,
  # OPTIONAL: Path to the docker binary.
  # Should be set explicitly for remote execution.
  docker_path=&quot;&lt;enter absolute path to the docker binary (in the remote exec env) here&gt;&quot;,
  # OPTIONAL: Path to the gzip binary.
  gzip_path=&quot;&lt;enter absolute path to the gzip binary (in the remote exec env) here&gt;&quot;,
  # OPTIONAL: Bazel target for the gzip tool.
  gzip_target=&quot;&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable gzip target&gt;&quot;,
  # OPTIONAL: Path to the xz binary.
  # Should be set explicitly for remote execution.
  xz_path=&quot;&lt;enter absolute path to the xz binary (in the remote exec env) here&gt;&quot;,
  # OPTIONAL: Bazel target for the xz tool.
  # Either xz_path or xz_target should be set explicitly for remote execution.
  xz_target=&quot;&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable xz target&gt;&quot;,
  # OPTIONAL: List of additional flags to pass to the docker command.
  docker_flags = [
    &quot;--tls&quot;,
    &quot;--log-level=info&quot;,
  ],

)
# End of OPTIONAL segment.

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)
container_repositories()

load(&quot;@io_bazel_rules_docker//repositories:deps.bzl&quot;, container_deps = &quot;deps&quot;)

container_deps()

load(
    &quot;@io_bazel_rules_docker//container:container.bzl&quot;,
    &quot;container_pull&quot;,
)

container_pull(
  name = &quot;java_base&quot;,
  registry = &quot;gcr.io&quot;,
  repository = &quot;distroless/java&quot;,
  # 'tag' is also supported, but digest is encouraged for reproducibility.
  digest = &quot;sha256:deadbeef&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-en">http_archive</span>(
  <span class="pl-c"># Get copy paste instructions for the http_archive attributes from the</span>
  <span class="pl-c"># release notes at https://github.com/bazelbuild/rules_docker/releases</span>
)

<span class="pl-c"># OPTIONAL: Call this to override the default docker toolchain configuration.</span>
<span class="pl-c"># This call should be placed BEFORE the call to "container_repositories" below</span>
<span class="pl-c"># to actually override the default toolchain configuration.</span>
<span class="pl-c"># Note this is only required if you actually want to call</span>
<span class="pl-c"># docker_toolchain_configure with a custom attr; please read the toolchains</span>
<span class="pl-c"># docs in /toolchains/docker/ before blindly adding this to your WORKSPACE.</span>
<span class="pl-c"># BEGIN OPTIONAL segment:</span>
<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//toolchains/docker:toolchain.bzl"</span>,
    <span class="pl-s1">docker_toolchain_configure</span><span class="pl-c1">=</span><span class="pl-s">"toolchain_configure"</span>
)
<span class="pl-en">docker_toolchain_configure</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"docker_config"</span>,
  <span class="pl-c"># OPTIONAL: Bazel target for the build_tar tool, must be compatible with build_tar.py</span>
  <span class="pl-s1">build_tar_target</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable build_tar target&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Path to a directory which has a custom docker client config.json.</span>
  <span class="pl-c"># See https://docs.docker.com/engine/reference/commandline/cli/#configuration-files</span>
  <span class="pl-c"># for more details.</span>
  <span class="pl-s1">client_config</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter Bazel label to your docker config.json here&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Path to the docker binary.</span>
  <span class="pl-c"># Should be set explicitly for remote execution.</span>
  <span class="pl-s1">docker_path</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path to the docker binary (in the remote exec env) here&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Path to the gzip binary.</span>
  <span class="pl-s1">gzip_path</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path to the gzip binary (in the remote exec env) here&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Bazel target for the gzip tool.</span>
  <span class="pl-s1">gzip_target</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable gzip target&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Path to the xz binary.</span>
  <span class="pl-c"># Should be set explicitly for remote execution.</span>
  <span class="pl-s1">xz_path</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path to the xz binary (in the remote exec env) here&gt;"</span>,
  <span class="pl-c"># OPTIONAL: Bazel target for the xz tool.</span>
  <span class="pl-c"># Either xz_path or xz_target should be set explicitly for remote execution.</span>
  <span class="pl-s1">xz_target</span><span class="pl-c1">=</span><span class="pl-s">"&lt;enter absolute path (i.e., must start with repo name @...//:...) to an executable xz target&gt;"</span>,
  <span class="pl-c"># OPTIONAL: List of additional flags to pass to the docker command.</span>
  <span class="pl-s1">docker_flags</span> <span class="pl-c1">=</span> [
    <span class="pl-s">"--tls"</span>,
    <span class="pl-s">"--log-level=info"</span>,
  ],

)
<span class="pl-c"># End of OPTIONAL segment.</span>

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)
<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//repositories:deps.bzl"</span>, <span class="pl-s1">container_deps</span> <span class="pl-c1">=</span> <span class="pl-s">"deps"</span>)

<span class="pl-en">container_deps</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//container:container.bzl"</span>,
    <span class="pl-s">"container_pull"</span>,
)

<span class="pl-en">container_pull</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"java_base"</span>,
  <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io"</span>,
  <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"distroless/java"</span>,
  <span class="pl-c"># 'tag' is also supported, but digest is encouraged for reproducibility.</span>
  <span class="pl-s1">digest</span> <span class="pl-c1">=</span> <span class="pl-s">"sha256:deadbeef"</span>,
)</pre></div>
<h3 dir="auto"><a id="user-content-known-issues" class="anchor" aria-hidden="true" tabindex="-1" href="#known-issues"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Known Issues</h3>
<ul dir="auto">
<li>Bazel does not deal well with diamond dependencies.</li>
</ul>
<p dir="auto">If the repositories that are imported by <code>container_repositories()</code> have already been
imported (at a different version) by other rules you called in your <code>WORKSPACE</code>, which
are placed above the call to <code>container_repositories()</code>, arbitrary errors might
occur. If you get errors related to external repositories, you will likely
not be able to use <code>container_repositories()</code> and will have to import
directly in your <code>WORKSPACE</code> all the required dependencies (see the most up
to date impl of <code>container_repositories()</code> for details).</p>
<ul dir="auto">
<li>ImportError: No module named moves.urllib.parse</li>
</ul>
<p dir="auto">This is an example of an error due to a diamond dependency. If you get this
error, make sure to import rules_docker before other libraries, so that
<em>six</em> can be patched properly.</p>
<p dir="auto">See <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="472608124" data-permission-text="Title is private" data-url="https://github.com/bazelbuild/rules_docker/issues/1022" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_docker/issues/1022/hovercard" href="https://github.com/bazelbuild/rules_docker/issues/1022">#1022</a> for more details.</p>
<ul dir="auto">
<li>Ensure your project has a <code>BUILD</code> or <code>BUILD.bazel</code> file at the top level. This
can be a blank file if necessary. Otherwise you might see an error that looks
like:</li>
</ul>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="Unable to load package for //:WORKSPACE: BUILD file not found in any of the following directories."><pre class="notranslate"><code>Unable to load package for //:WORKSPACE: BUILD file not found in any of the following directories.
</code></pre></div>
<ul dir="auto">
<li>rules_docker uses transitions to build your containers using toolchains the correct
architecture and operating system. If you run into issues with toolchain resolutions,
you can disable this behaviour, by adding this to your .bazelrc:</li>
</ul>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="build --@io_bazel_rules_docker//transitions:enable=false"><pre class="notranslate"><code>build --@io_bazel_rules_docker//transitions:enable=false
</code></pre></div>
<h2 dir="auto"><a id="user-content-using-with-docker-locally" class="anchor" aria-hidden="true" tabindex="-1" href="#using-with-docker-locally"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Using with Docker locally.</h2>
<p dir="auto">Suppose you have a <code>container_image</code> target <code>//my/image:helloworld</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_image(
    name = &quot;helloworld&quot;,
    ...
)"><pre><span class="pl-en">container_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"helloworld"</span>,
    ...
)</pre></div>
<p dir="auto">You can load this into your local Docker client by running:
<code>bazel run my/image:helloworld</code>.</p>
<p dir="auto">For the <code>lang_image</code> targets, this will also <strong>run</strong> the
container using <code>docker run</code> to maximize compatibility with <code>lang_binary</code> rules.</p>
<p dir="auto">Arguments to this command are forwarded to docker, meaning the command</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel run my/image:helloworld -- -p 8080:80 -- arg0"><pre>bazel run my/image:helloworld -- -p 8080:80 -- arg0</pre></div>
<p dir="auto">performs the following steps:</p>
<ul dir="auto">
<li>load the <code>my/image:helloworld</code> target into your local Docker client</li>
<li>start a container using this image where <code>arg0</code> is passed to the image entrypoint</li>
<li>port forward 8080 on the host to port 80 on the container, as per <code>docker run</code> documentation</li>
</ul>
<p dir="auto">You can suppress this behavior by passing the single flag: <code>bazel run :foo -- --norun</code></p>
<p dir="auto">Alternatively, you can build a <code>docker load</code> compatible bundle with:
<code>bazel build my/image:helloworld.tar</code>.  This will produce a tar file
in your <code>bazel-out</code> directory that can be loaded into your local Docker
client. Building this target can be expensive for large images. You will
first need to query the ouput file location.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="TARBALL_LOCATION=$(bazel cquery my/image:helloworld.tar \
    --output starlark \
    --starlark:expr=&quot;target.files.to_list()[0].path&quot;)
docker load -i $TARBALL_LOCATION"><pre>TARBALL_LOCATION=<span class="pl-s"><span class="pl-pds">$(</span>bazel cquery my/image:helloworld.tar \</span>
<span class="pl-s">    --output starlark \</span>
<span class="pl-s">    --starlark:expr=<span class="pl-s"><span class="pl-pds">"</span>target.files.to_list()[0].path<span class="pl-pds">"</span></span><span class="pl-pds">)</span></span>
docker load -i <span class="pl-smi">$TARBALL_LOCATION</span></pre></div>
<p dir="auto">These work with both <code>container_image</code>, <code>container_bundle</code>, and the
<code>lang_image</code> rules.  For everything except <code>container_bundle</code>, the image
name will be <code>bazel/my/image:helloworld</code>. The <code>container_bundle</code> rule will
apply the tags you have specified.</p>
<h2 dir="auto"><a id="user-content-authentication" class="anchor" aria-hidden="true" tabindex="-1" href="#authentication"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Authentication</h2>
<p dir="auto">You can use these rules to access private images using standard Docker
authentication methods.  e.g. to utilize the <a href="https://gcr.io" rel="nofollow">Google Container Registry</a>. See
<a href="https://cloud.google.com/container-registry/docs/advanced-authentication" rel="nofollow">here</a> for authentication methods.</p>
<p dir="auto">See also:</p>
<ul dir="auto">
<li><a href="https://github.com/awslabs/amazon-ecr-credential-helper">Amazon ECR Docker Credential Helper</a></li>
<li><a href="https://github.com/Azure/acr-docker-credential-helper">Azure Docker Credential Helper</a></li>
</ul>
<p dir="auto">Once you've setup your docker client configuration, see <a href="#container_pull-custom-client-configuration">here</a>
for an example of how to use <code>container_pull</code> with custom docker authentication credentials
and <a href="#container_push-custom-client-configuration">here</a> for an example of how
to use <code>container_push</code> with custom docker authentication credentials.</p>
<h2 dir="auto"><a id="user-content-varying-image-names" class="anchor" aria-hidden="true" tabindex="-1" href="#varying-image-names"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Varying image names</h2>
<p dir="auto">A common request from folks using
<code>container_push</code>, <code>container_bundle</code>, or <code>container_image</code> is to
be able to vary the tag that is pushed or embedded.  There are two options
at present for doing this.</p>
<h3 dir="auto"><a id="user-content-stamping" class="anchor" aria-hidden="true" tabindex="-1" href="#stamping"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Stamping</h3>
<p dir="auto">The first option is to use stamping.
Stamping is enabled when bazel is run with <code>--stamp</code>.
This enables replacements in stamp-aware attributes.
A python format placeholder (e.g. <code>{BUILD_USER}</code>)
is replaced by the value of the corresponding workspace-status variable.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# A common pattern when users want to avoid trampling
# on each other's images during development.
container_push(
  name = &quot;publish&quot;,
  format = &quot;Docker&quot;,

  # Any of these components may have variables.
  registry = &quot;gcr.io&quot;,
  repository = &quot;my-project/my-image&quot;,
  # This will be replaced with the current user when built with --stamp
  tag = &quot;{BUILD_USER}&quot;,
)"><pre><span class="pl-c"># A common pattern when users want to avoid trampling</span>
<span class="pl-c"># on each other's images during development.</span>
<span class="pl-en">container_push</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"publish"</span>,
  <span class="pl-s1">format</span> <span class="pl-c1">=</span> <span class="pl-s">"Docker"</span>,

  <span class="pl-c"># Any of these components may have variables.</span>
  <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io"</span>,
  <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"my-project/my-image"</span>,
  <span class="pl-c"># This will be replaced with the current user when built with --stamp</span>
  <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"{BUILD_USER}"</span>,
)</pre></div>
<blockquote>
<p dir="auto">Rules that are sensitive to stamping can also be forced to stamp or non-stamp mode
irrespective of the <code>--stamp</code> flag to Bazel. Use the <code>build_context_data</code> rule
to make a target that provides <code>StampSettingInfo</code>, and pass this to the
<code>build_context_data</code> attribute.</p>
</blockquote>
<p dir="auto">The next natural question is: "Well what variables can I use?"  This
option consumes the workspace-status variables Bazel defines in
<code>bazel-out/stable-status.txt</code> and <code>bazel-out/volatile-status.txt</code>.</p>
<blockquote>
<p dir="auto">Note that changes to the stable-status file
cause a rebuild of the action, while volatile-status does not.</p>
</blockquote>
<p dir="auto">You can add more stamp variables via <code>--workspace_status_command</code>,
see the <a href="https://docs.bazel.build/versions/master/user-manual.html#workspace_status" rel="nofollow">bazel docs</a>.
A common example is to provide the current git SHA, with
<code>--workspace_status_command="echo STABLE_GIT_SHA $(git rev-parse HEAD)"</code></p>
<p dir="auto">That flag is typically passed in the <code>.bazelrc</code> file, see for example <a href="https://github.com/kubernetes/kubernetes/blob/81ce94ae1d8f5d04058eeb214e9af498afe78ff2/build/root/.bazelrc#L6"><code>.bazelrc</code> in kubernetes</a>.</p>
<h3 dir="auto"><a id="user-content-make-variables" class="anchor" aria-hidden="true" tabindex="-1" href="#make-variables"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Make variables</h3>
<p dir="auto">The second option is to employ <code>Makefile</code>-style variables:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_bundle(
  name = &quot;bundle&quot;,

  images = {
    &quot;gcr.io/$(project)/frontend:latest&quot;: &quot;//frontend:image&quot;,
    &quot;gcr.io/$(project)/backend:latest&quot;: &quot;//backend:image&quot;,
  }
)"><pre><span class="pl-en">container_bundle</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"bundle"</span>,

  <span class="pl-s1">images</span> <span class="pl-c1">=</span> {
    <span class="pl-s">"gcr.io/$(project)/frontend:latest"</span>: <span class="pl-s">"//frontend:image"</span>,
    <span class="pl-s">"gcr.io/$(project)/backend:latest"</span>: <span class="pl-s">"//backend:image"</span>,
  }
)</pre></div>
<p dir="auto">These variables are specified on the CLI using:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="   bazel build --define project=blah //path/to:bundle"><pre>   bazel build --define project=blah //path/to:bundle</pre></div>
<h2 dir="auto"><a id="user-content-debugging-lang_image-rules" class="anchor" aria-hidden="true" tabindex="-1" href="#debugging-lang_image-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Debugging <code>lang_image</code> rules</h2>
<p dir="auto">By default the <code>lang_image</code> rules use the <code>distroless</code> base runtime images,
which are optimized to be the minimal set of things your application needs
at runtime.  That can make debugging these containers difficult because they
lack even a basic shell for exploring the filesystem.</p>
<p dir="auto">To address this, we publish variants of the <code>distroless</code> runtime images tagged
<code>:debug</code>, which are the exact-same images, but with additions such as <code>busybox</code>
to make debugging easier.</p>
<p dir="auto">For example (in this repo):</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="$ bazel run -c dbg testdata:go_image
...
INFO: Build completed successfully, 5 total actions

INFO: Running command line: bazel-bin/testdata/go_image
Loaded image ID: sha256:9c5c2167a1db080a64b5b401b43b3c5cdabb265b26cf7a60aabe04a20da79e24
Tagging 9c5c2167a1db080a64b5b401b43b3c5cdabb265b26cf7a60aabe04a20da79e24 as bazel/testdata:go_image
Hello, world!

$ docker run -ti --rm --entrypoint=sh bazel/testdata:go_image -c &quot;echo Hello, busybox.&quot;
Hello, busybox."><pre>$ bazel run -c dbg testdata:go_image
...
INFO: Build completed successfully, 5 total actions

INFO: Running <span class="pl-c1">command</span> line: bazel-bin/testdata/go_image
Loaded image ID: sha256:9c5c2167a1db080a64b5b401b43b3c5cdabb265b26cf7a60aabe04a20da79e24
Tagging 9c5c2167a1db080a64b5b401b43b3c5cdabb265b26cf7a60aabe04a20da79e24 as bazel/testdata:go_image
Hello, world<span class="pl-k">!</span>

$ docker run -ti --rm --entrypoint=sh bazel/testdata:go_image -c <span class="pl-s"><span class="pl-pds">"</span>echo Hello, busybox.<span class="pl-pds">"</span></span>
Hello, busybox.</pre></div>
<h2 dir="auto"><a id="user-content-examples" class="anchor" aria-hidden="true" tabindex="-1" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Examples</h2>
<h3 dir="auto"><a id="user-content-container_image" class="anchor" aria-hidden="true" tabindex="-1" href="#container_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_image</h3>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_image(
    name = &quot;app&quot;,
    # References container_pull from WORKSPACE (above)
    base = &quot;@java_base//image&quot;,
    files = [&quot;//java/com/example/app:Hello_deploy.jar&quot;],
    cmd = [&quot;Hello_deploy.jar&quot;]
)"><pre><span class="pl-en">container_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"app"</span>,
    <span class="pl-c"># References container_pull from WORKSPACE (above)</span>
    <span class="pl-s1">base</span> <span class="pl-c1">=</span> <span class="pl-s">"@java_base//image"</span>,
    <span class="pl-s1">files</span> <span class="pl-c1">=</span> [<span class="pl-s">"//java/com/example/app:Hello_deploy.jar"</span>],
    <span class="pl-s1">cmd</span> <span class="pl-c1">=</span> [<span class="pl-s">"Hello_deploy.jar"</span>]
)</pre></div>
<p dir="auto">Hint: if you want to put files in specific directories inside the image
use <a href="https://docs.bazel.build/versions/master/be/pkg.html" rel="nofollow"><code>pkg_tar</code> rule</a>
to create the desired directory structure and pass that to <code>container_image</code> via
<code>tars</code> attribute. Note you might need to set <code>strip_prefix = "."</code> or <code>strip_prefix = "{some directory}"</code>
in your rule for the files to not be flattened.
See <a href="https://github.com/bazelbuild/bazel/issues/2176">Bazel upstream issue 2176</a> and
<a href="https://github.com/bazelbuild/rules_docker/issues/317" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/rules_docker/issues/317/hovercard">rules_docker issue 317</a>
for more details.</p>
<h3 dir="auto"><a id="user-content-cc_image" class="anchor" aria-hidden="true" tabindex="-1" href="#cc_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>cc_image</h3>
<p dir="auto">To use <code>cc_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//cc:image.bzl&quot;,
    _cc_image_repos = &quot;repositories&quot;,
)

_cc_image_repos()"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//cc:image.bzl"</span>,
    <span class="pl-s1">_cc_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_cc_image_repos</span>()</pre></div>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>cc_binary</code> to <code>cc_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//cc:image.bzl&quot;, &quot;cc_image&quot;)

cc_image(
    name = &quot;cc_image&quot;,
    srcs = [&quot;cc_image.cc&quot;],
    deps = [&quot;:cc_image_library&quot;],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//cc:image.bzl"</span>, <span class="pl-s">"cc_image"</span>)

<span class="pl-en">cc_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"cc_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"cc_image.cc"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">":cc_image_library"</span>],
)</pre></div>
<h3 dir="auto"><a id="user-content-cc_image-external-binary" class="anchor" aria-hidden="true" tabindex="-1" href="#cc_image-external-binary"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>cc_image (external binary)</h3>
<p dir="auto">To use <code>cc_image</code> (or <code>go_image</code>, <code>d_image</code>, <code>rust_image</code>) with an external
<code>cc_binary</code> (or the like) target, then your <code>BUILD</code> file should instead look
like:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//cc:image.bzl&quot;, &quot;cc_image&quot;)

cc_binary(
    name = &quot;cc_binary&quot;,
    srcs = [&quot;cc_binary.cc&quot;],
    deps = [&quot;:cc_library&quot;],
)

cc_image(
    name = &quot;cc_image&quot;,
    binary = &quot;:cc_binary&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//cc:image.bzl"</span>, <span class="pl-s">"cc_image"</span>)

<span class="pl-en">cc_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"cc_binary"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"cc_binary.cc"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">":cc_library"</span>],
)

<span class="pl-en">cc_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"cc_image"</span>,
    <span class="pl-s1">binary</span> <span class="pl-c1">=</span> <span class="pl-s">":cc_binary"</span>,
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>cc_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example below.</p>
<h3 dir="auto"><a id="user-content-py_image" class="anchor" aria-hidden="true" tabindex="-1" href="#py_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>py_image</h3>
<p dir="auto">To use <code>py_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//python:image.bzl&quot;,
    _py_image_repos = &quot;repositories&quot;,
)

_py_image_repos()"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//python:image.bzl"</span>,
    <span class="pl-s1">_py_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_py_image_repos</span>()</pre></div>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>py_binary</code> to <code>py_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//python:image.bzl&quot;, &quot;py_image&quot;)

py_image(
    name = &quot;py_image&quot;,
    srcs = [&quot;py_image.py&quot;],
    deps = [&quot;:py_image_library&quot;],
    main = &quot;py_image.py&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//python:image.bzl"</span>, <span class="pl-s">"py_image"</span>)

<span class="pl-en">py_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"py_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"py_image.py"</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">":py_image_library"</span>],
    <span class="pl-s1">main</span> <span class="pl-c1">=</span> <span class="pl-s">"py_image.py"</span>,
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>py_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example below.</p>
<p dir="auto">If you are using <code>py_image</code> with a custom base that has python tools installed
in a location different to the default base, please see
<a href="#python-tools">Python tools</a>.</p>
<h3 dir="auto"><a id="user-content-py_image-fine-layering" class="anchor" aria-hidden="true" tabindex="-1" href="#py_image-fine-layering"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>py_image (fine layering)</h3>
<p dir="auto">For Python and Java's <code>lang_image</code> rules, you can factor
dependencies that don't change into their own layers by overriding the
<code>layers=[]</code> attribute.  Consider this sample from the <code>rules_k8s</code> repository:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="py_image(
    name = &quot;server&quot;,
    srcs = [&quot;server.py&quot;],
    # &quot;layers&quot; is just like &quot;deps&quot;, but it also moves the dependencies each into
    # their own layer, which can dramatically improve developer cycle time. For
    # example here, the grpcio layer is ~40MB, but the rest of the app is only
    # ~400KB.  By partitioning things this way, the large grpcio layer remains
    # unchanging and we can reduce the amount of image data we repush by ~99%!
    layers = [
        requirement(&quot;grpcio&quot;),
        &quot;//examples/hellogrpc/proto:py&quot;,
    ],
    main = &quot;server.py&quot;,
)"><pre><span class="pl-en">py_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"server"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"server.py"</span>],
    <span class="pl-c"># "layers" is just like "deps", but it also moves the dependencies each into</span>
    <span class="pl-c"># their own layer, which can dramatically improve developer cycle time. For</span>
    <span class="pl-c"># example here, the grpcio layer is ~40MB, but the rest of the app is only</span>
    <span class="pl-c"># ~400KB.  By partitioning things this way, the large grpcio layer remains</span>
    <span class="pl-c"># unchanging and we can reduce the amount of image data we repush by ~99%!</span>
    <span class="pl-s1">layers</span> <span class="pl-c1">=</span> [
        <span class="pl-en">requirement</span>(<span class="pl-s">"grpcio"</span>),
        <span class="pl-s">"//examples/hellogrpc/proto:py"</span>,
    ],
    <span class="pl-s1">main</span> <span class="pl-c1">=</span> <span class="pl-s">"server.py"</span>,
)</pre></div>
<p dir="auto">You can also implement more complex fine layering strategies by using the
<code>py_layer</code> or <code>java_layer</code> rules and their <code>filter</code> attribute.  For example:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# Suppose that we are synthesizing an image that depends on a complex set
# of libraries that we want to break into layers.
LIBS = [
    &quot;//pkg/complex_library&quot;,
    # ...
]
# First, we extract all transitive dependencies of LIBS that are under //pkg/common.
py_layer(
    name = &quot;common_deps&quot;,
    deps = LIBS,
    filter = &quot;//pkg/common&quot;,
)
# Then, we further extract all external dependencies of the deps under //pkg/common.
py_layer(
    name = &quot;common_external_deps&quot;,
    deps = [&quot;:common_deps&quot;],
    filter = &quot;@&quot;,
)
# We also extract all external dependencies of LIBS, which is a superset of
# &quot;:common_external_deps&quot;.
py_layer(
    name = &quot;external_deps&quot;,
    deps = LIBS,
    filter = &quot;@&quot;,
)
# Finally, we create the image, stacking the above filtered layers on top of one
# another in the &quot;layers&quot; attribute.  The layers are applied in order, and any
# dependencies already added to the image will not be added again.  Therefore,
# &quot;:external_deps&quot; will only add the external dependencies not present in
# &quot;:common_external_deps&quot;.
py_image(
    name = &quot;image&quot;,
    deps = LIBS,
    layers = [
        &quot;:common_external_deps&quot;,
        &quot;:common_deps&quot;,
        &quot;:external_deps&quot;,
    ],
    # ...
)"><pre><span class="pl-c"># Suppose that we are synthesizing an image that depends on a complex set</span>
<span class="pl-c"># of libraries that we want to break into layers.</span>
<span class="pl-v">LIBS</span> <span class="pl-c1">=</span> [
    <span class="pl-s">"//pkg/complex_library"</span>,
    <span class="pl-c"># ...</span>
]
<span class="pl-c"># First, we extract all transitive dependencies of LIBS that are under //pkg/common.</span>
<span class="pl-en">py_layer</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"common_deps"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> <span class="pl-v">LIBS</span>,
    <span class="pl-s1">filter</span> <span class="pl-c1">=</span> <span class="pl-s">"//pkg/common"</span>,
)
<span class="pl-c"># Then, we further extract all external dependencies of the deps under //pkg/common.</span>
<span class="pl-en">py_layer</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"common_external_deps"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">":common_deps"</span>],
    <span class="pl-s1">filter</span> <span class="pl-c1">=</span> <span class="pl-s">"@"</span>,
)
<span class="pl-c"># We also extract all external dependencies of LIBS, which is a superset of</span>
<span class="pl-c"># ":common_external_deps".</span>
<span class="pl-en">py_layer</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"external_deps"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> <span class="pl-v">LIBS</span>,
    <span class="pl-s1">filter</span> <span class="pl-c1">=</span> <span class="pl-s">"@"</span>,
)
<span class="pl-c"># Finally, we create the image, stacking the above filtered layers on top of one</span>
<span class="pl-c"># another in the "layers" attribute.  The layers are applied in order, and any</span>
<span class="pl-c"># dependencies already added to the image will not be added again.  Therefore,</span>
<span class="pl-c"># ":external_deps" will only add the external dependencies not present in</span>
<span class="pl-c"># ":common_external_deps".</span>
<span class="pl-en">py_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"image"</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> <span class="pl-v">LIBS</span>,
    <span class="pl-s1">layers</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":common_external_deps"</span>,
        <span class="pl-s">":common_deps"</span>,
        <span class="pl-s">":external_deps"</span>,
    ],
    <span class="pl-c"># ...</span>
)</pre></div>
<h3 dir="auto"><a id="user-content-py3_image" class="anchor" aria-hidden="true" tabindex="-1" href="#py3_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>py3_image</h3>
<p dir="auto">To use a Python 3 runtime instead of the default of Python 2, use <code>py3_image</code>,
instead of <code>py_image</code>.  The other semantics are identical.</p>
<p dir="auto">If you need to modify somehow the container produced by
<code>py3_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example below.</p>
<p dir="auto">If you are using <code>py3_image</code> with a custom base that has python tools installed
in a location different to the default base, please see
<a href="#python-tools">Python tools</a>.</p>
<h3 dir="auto"><a id="user-content-nodejs_image" class="anchor" aria-hidden="true" tabindex="-1" href="#nodejs_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>nodejs_image</h3>
<p dir="auto"><strong>It is notable that unlike the other image rules, <code>nodejs_image</code> is not
currently using the <code>gcr.io/distroless/nodejs</code> image for a handful of reasons.</strong>
This is a switch we plan to make, when we can manage it.  We are currently
utilizing the <code>gcr.io/google-appengine/debian9</code> image as our base.</p>
<p dir="auto">To use <code>nodejs_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

http_archive(
    name = &quot;build_bazel_rules_nodejs&quot;,
    # Replace with a real SHA256 checksum
    sha256 = &quot;{SHA256}&quot;
    # Replace with a real release version
    urls = [&quot;https://github.com/bazelbuild/rules_nodejs/releases/download/{VERSION}/rules_nodejs-{VERSION}.tar.gz&quot;],
)


load(&quot;@build_bazel_rules_nodejs//:index.bzl&quot;, &quot;npm_install&quot;)

# Install your declared Node.js dependencies
npm_install(
    name = &quot;npm&quot;,
    package_json = &quot;//:package.json&quot;,
    yarn_lock = &quot;//:yarn.lock&quot;,
)

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//nodejs:image.bzl&quot;,
    _nodejs_image_repos = &quot;repositories&quot;,
)

_nodejs_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"build_bazel_rules_nodejs"</span>,
    <span class="pl-c"># Replace with a real SHA256 checksum</span>
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"{SHA256}"</span>
    <span class="pl-c"># Replace with a real release version</span>
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/bazelbuild/rules_nodejs/releases/download/{VERSION}/rules_nodejs-{VERSION}.tar.gz"</span>],
)


<span class="pl-en">load</span>(<span class="pl-s">"@build_bazel_rules_nodejs//:index.bzl"</span>, <span class="pl-s">"npm_install"</span>)

<span class="pl-c"># Install your declared Node.js dependencies</span>
<span class="pl-en">npm_install</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"npm"</span>,
    <span class="pl-s1">package_json</span> <span class="pl-c1">=</span> <span class="pl-s">"//:package.json"</span>,
    <span class="pl-s1">yarn_lock</span> <span class="pl-c1">=</span> <span class="pl-s">"//:yarn.lock"</span>,
)

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//nodejs:image.bzl"</span>,
    <span class="pl-s1">_nodejs_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_nodejs_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>nodejs_binary</code> to <code>nodejs_image</code> with
the following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//nodejs:image.bzl&quot;, &quot;nodejs_image&quot;)

nodejs_image(
    name = &quot;nodejs_image&quot;,
    entry_point = &quot;@your_workspace//path/to:file.js&quot;,
    # npm deps will be put into their own layer
    data = [&quot;:file.js&quot;, &quot;@npm//some-npm-dep&quot;],
    ...
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//nodejs:image.bzl"</span>, <span class="pl-s">"nodejs_image"</span>)

<span class="pl-en">nodejs_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"nodejs_image"</span>,
    <span class="pl-s1">entry_point</span> <span class="pl-c1">=</span> <span class="pl-s">"@your_workspace//path/to:file.js"</span>,
    <span class="pl-c"># npm deps will be put into their own layer</span>
    <span class="pl-s1">data</span> <span class="pl-c1">=</span> [<span class="pl-s">":file.js"</span>, <span class="pl-s">"@npm//some-npm-dep"</span>],
    ...
)</pre></div>
<p dir="auto"><code>nodejs_image</code> also supports the <code>launcher</code> and <code>launcher_args</code> attributes which are passed to <code>container_image</code> and used to prefix the image's <code>entry_point</code>.</p>
<p dir="auto">If you need to modify somehow the container produced by
<code>nodejs_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example below.</p>
<h3 dir="auto"><a id="user-content-go_image" class="anchor" aria-hidden="true" tabindex="-1" href="#go_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>go_image</h3>
<p dir="auto">To use <code>go_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//go:image.bzl&quot;,
    _go_image_repos = &quot;repositories&quot;,
)

_go_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//go:image.bzl"</span>,
    <span class="pl-s1">_go_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_go_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>go_binary</code> to <code>go_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//go:image.bzl&quot;, &quot;go_image&quot;)

go_image(
    name = &quot;go_image&quot;,
    srcs = [&quot;main.go&quot;],
    importpath = &quot;github.com/your/path/here&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//go:image.bzl"</span>, <span class="pl-s">"go_image"</span>)

<span class="pl-en">go_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"go_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"main.go"</span>],
    <span class="pl-s1">importpath</span> <span class="pl-c1">=</span> <span class="pl-s">"github.com/your/path/here"</span>,
)</pre></div>
<p dir="auto">Notice that it is important to explicitly build this target with the
<code>--platforms=@io_bazel_rules_go//go/toolchain:linux_amd64</code> flag
as the binary should be built for Linux since it will run in a Linux container.</p>
<p dir="auto">If you need to modify somehow the container produced by
<code>go_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this and
see example below.</p>
<h3 dir="auto"><a id="user-content-go_image-custom-base" class="anchor" aria-hidden="true" tabindex="-1" href="#go_image-custom-base"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>go_image (custom base)</h3>
<p dir="auto">To use a custom base image, with any of the <code>lang_image</code>
rules, you can override the default <code>base="..."</code> attribute.  Consider this
modified sample from the <code>distroless</code> repository:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@rules_pkg//pkg:tar.bzl&quot;, &quot;pkg_tar&quot;)

# Create a passwd file with a root and nonroot user and uid.
passwd_entry(
    username = &quot;root&quot;,
    uid = 0,
    gid = 0,
    name = &quot;root_user&quot;,
)

passwd_entry(
    username = &quot;nonroot&quot;,
    info = &quot;nonroot&quot;,
    uid = 1002,
    name = &quot;nonroot_user&quot;,
)

passwd_file(
    name = &quot;passwd&quot;,
    entries = [
        &quot;:root_user&quot;,
        &quot;:nonroot_user&quot;,
    ],
)

# Create a tar file containing the created passwd file
pkg_tar(
    name = &quot;passwd_tar&quot;,
    srcs = [&quot;:passwd&quot;],
    mode = &quot;0o644&quot;,
    package_dir = &quot;etc&quot;,
)

# Include it in our base image as a tar.
container_image(
    name = &quot;passwd_image&quot;,
    base = &quot;@go_image_base//image&quot;,
    tars = [&quot;:passwd_tar&quot;],
    user = &quot;nonroot&quot;,
)

# Simple go program to print out the username and uid.
go_image(
    name = &quot;user&quot;,
    srcs = [&quot;user.go&quot;],
    # Override the base image.
    base = &quot;:passwd_image&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@rules_pkg//pkg:tar.bzl"</span>, <span class="pl-s">"pkg_tar"</span>)

<span class="pl-c"># Create a passwd file with a root and nonroot user and uid.</span>
<span class="pl-en">passwd_entry</span>(
    <span class="pl-s1">username</span> <span class="pl-c1">=</span> <span class="pl-s">"root"</span>,
    <span class="pl-s1">uid</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>,
    <span class="pl-s1">gid</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span>,
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"root_user"</span>,
)

<span class="pl-en">passwd_entry</span>(
    <span class="pl-s1">username</span> <span class="pl-c1">=</span> <span class="pl-s">"nonroot"</span>,
    <span class="pl-s1">info</span> <span class="pl-c1">=</span> <span class="pl-s">"nonroot"</span>,
    <span class="pl-s1">uid</span> <span class="pl-c1">=</span> <span class="pl-c1">1002</span>,
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"nonroot_user"</span>,
)

<span class="pl-en">passwd_file</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"passwd"</span>,
    <span class="pl-s1">entries</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":root_user"</span>,
        <span class="pl-s">":nonroot_user"</span>,
    ],
)

<span class="pl-c"># Create a tar file containing the created passwd file</span>
<span class="pl-en">pkg_tar</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"passwd_tar"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">":passwd"</span>],
    <span class="pl-s1">mode</span> <span class="pl-c1">=</span> <span class="pl-s">"0o644"</span>,
    <span class="pl-s1">package_dir</span> <span class="pl-c1">=</span> <span class="pl-s">"etc"</span>,
)

<span class="pl-c"># Include it in our base image as a tar.</span>
<span class="pl-en">container_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"passwd_image"</span>,
    <span class="pl-s1">base</span> <span class="pl-c1">=</span> <span class="pl-s">"@go_image_base//image"</span>,
    <span class="pl-s1">tars</span> <span class="pl-c1">=</span> [<span class="pl-s">":passwd_tar"</span>],
    <span class="pl-s1">user</span> <span class="pl-c1">=</span> <span class="pl-s">"nonroot"</span>,
)

<span class="pl-c"># Simple go program to print out the username and uid.</span>
<span class="pl-en">go_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"user"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"user.go"</span>],
    <span class="pl-c"># Override the base image.</span>
    <span class="pl-s1">base</span> <span class="pl-c1">=</span> <span class="pl-s">":passwd_image"</span>,
)</pre></div>
<h3 dir="auto"><a id="user-content-java_image" class="anchor" aria-hidden="true" tabindex="-1" href="#java_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>java_image</h3>
<p dir="auto">To use <code>java_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//java:image.bzl&quot;,
    _java_image_repos = &quot;repositories&quot;,
)

_java_image_repos()"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//java:image.bzl"</span>,
    <span class="pl-s1">_java_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_java_image_repos</span>()</pre></div>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>java_binary</code> to <code>java_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//java:image.bzl&quot;, &quot;java_image&quot;)

java_image(
    name = &quot;java_image&quot;,
    srcs = [&quot;Binary.java&quot;],
    # Put these runfiles into their own layer.
    layers = [&quot;:java_image_library&quot;],
    main_class = &quot;examples.images.Binary&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//java:image.bzl"</span>, <span class="pl-s">"java_image"</span>)

<span class="pl-en">java_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"java_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"Binary.java"</span>],
    <span class="pl-c"># Put these runfiles into their own layer.</span>
    <span class="pl-s1">layers</span> <span class="pl-c1">=</span> [<span class="pl-s">":java_image_library"</span>],
    <span class="pl-s1">main_class</span> <span class="pl-c1">=</span> <span class="pl-s">"examples.images.Binary"</span>,
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>java_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<h3 dir="auto"><a id="user-content-war_image" class="anchor" aria-hidden="true" tabindex="-1" href="#war_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>war_image</h3>
<p dir="auto">To use <code>war_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//java:image.bzl&quot;,
    _java_image_repos = &quot;repositories&quot;,
)

_java_image_repos()"><pre><span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//java:image.bzl"</span>,
    <span class="pl-s1">_java_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_java_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>java_war</code> to <code>war_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//java:image.bzl&quot;, &quot;war_image&quot;)

war_image(
    name = &quot;war_image&quot;,
    srcs = [&quot;Servlet.java&quot;],
    # Put these JARs into their own layers.
    layers = [
        &quot;:java_image_library&quot;,
        &quot;@javax_servlet_api//jar:jar&quot;,
    ],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//java:image.bzl"</span>, <span class="pl-s">"war_image"</span>)

<span class="pl-en">war_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"war_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"Servlet.java"</span>],
    <span class="pl-c"># Put these JARs into their own layers.</span>
    <span class="pl-s1">layers</span> <span class="pl-c1">=</span> [
        <span class="pl-s">":java_image_library"</span>,
        <span class="pl-s">"@javax_servlet_api//jar:jar"</span>,
    ],
)</pre></div>
<p dir="auto">The produced image uses Jetty 9.x to serve the web application. Servlets included in the web application need to follow the API specification 3.0. For best compatibility, use a <a href="https://search.maven.org/search?q=g:org.mortbay.jetty%20AND%20a:servlet-api&amp;core=gav" rel="nofollow">Servlet dependency provided by the Jetty project</a>.</p>
<p dir="auto">A Servlet implementation needs to declare the <code>@WebServlet</code> annotation to be auto-discovered. The use of a <code>web.xml</code> to declare the Servlet URL mapping is not supported.</p>
<p dir="auto">If you need to modify somehow the container produced by
<code>war_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<h3 dir="auto"><a id="user-content-scala_image" class="anchor" aria-hidden="true" tabindex="-1" href="#scala_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>scala_image</h3>
<p dir="auto">To use <code>scala_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

# You *must* import the Scala rules before setting up the scala_image rules.
http_archive(
    name = &quot;io_bazel_rules_scala&quot;,
    # Replace with a real SHA256 checksum
    sha256 = &quot;{SHA256}&quot;
    # Replace with a real commit SHA
    strip_prefix = &quot;rules_scala-{HEAD}&quot;,
    urls = [&quot;https://github.com/bazelbuild/rules_scala/archive/{HEAD}.tar.gz&quot;],
)

load(&quot;@io_bazel_rules_scala//scala:scala.bzl&quot;, &quot;scala_repositories&quot;)

scala_repositories()

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//scala:image.bzl&quot;,
    _scala_image_repos = &quot;repositories&quot;,
)

_scala_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c"># You *must* import the Scala rules before setting up the scala_image rules.</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"io_bazel_rules_scala"</span>,
    <span class="pl-c"># Replace with a real SHA256 checksum</span>
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"{SHA256}"</span>
    <span class="pl-c"># Replace with a real commit SHA</span>
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_scala-{HEAD}"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/bazelbuild/rules_scala/archive/{HEAD}.tar.gz"</span>],
)

<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_scala//scala:scala.bzl"</span>, <span class="pl-s">"scala_repositories"</span>)

<span class="pl-en">scala_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//scala:image.bzl"</span>,
    <span class="pl-s1">_scala_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_scala_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>scala_binary</code> to <code>scala_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//scala:image.bzl&quot;, &quot;scala_image&quot;)

scala_image(
    name = &quot;scala_image&quot;,
    srcs = [&quot;Binary.scala&quot;],
    main_class = &quot;examples.images.Binary&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//scala:image.bzl"</span>, <span class="pl-s">"scala_image"</span>)

<span class="pl-en">scala_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"scala_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"Binary.scala"</span>],
    <span class="pl-s1">main_class</span> <span class="pl-c1">=</span> <span class="pl-s">"examples.images.Binary"</span>,
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>scala_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<h3 dir="auto"><a id="user-content-groovy_image" class="anchor" aria-hidden="true" tabindex="-1" href="#groovy_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>groovy_image</h3>
<p dir="auto">To use <code>groovy_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

# You *must* import the Groovy rules before setting up the groovy_image rules.
http_archive(
    name = &quot;io_bazel_rules_groovy&quot;,
    # Replace with a real SHA256 checksum
    sha256 = &quot;{SHA256}&quot;
    # Replace with a real commit SHA
    strip_prefix = &quot;rules_groovy-{HEAD}&quot;,
    urls = [&quot;https://github.com/bazelbuild/rules_groovy/archive/{HEAD}.tar.gz&quot;],
)

load(&quot;@io_bazel_rules_groovy//groovy:groovy.bzl&quot;, &quot;groovy_repositories&quot;)

groovy_repositories()

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//groovy:image.bzl&quot;,
    _groovy_image_repos = &quot;repositories&quot;,
)

_groovy_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c"># You *must* import the Groovy rules before setting up the groovy_image rules.</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"io_bazel_rules_groovy"</span>,
    <span class="pl-c"># Replace with a real SHA256 checksum</span>
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"{SHA256}"</span>
    <span class="pl-c"># Replace with a real commit SHA</span>
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_groovy-{HEAD}"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/bazelbuild/rules_groovy/archive/{HEAD}.tar.gz"</span>],
)

<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_groovy//groovy:groovy.bzl"</span>, <span class="pl-s">"groovy_repositories"</span>)

<span class="pl-en">groovy_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//groovy:image.bzl"</span>,
    <span class="pl-s1">_groovy_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_groovy_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>groovy_binary</code> to <code>groovy_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//groovy:image.bzl&quot;, &quot;groovy_image&quot;)

groovy_image(
    name = &quot;groovy_image&quot;,
    srcs = [&quot;Binary.groovy&quot;],
    main_class = &quot;examples.images.Binary&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//groovy:image.bzl"</span>, <span class="pl-s">"groovy_image"</span>)

<span class="pl-en">groovy_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"groovy_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"Binary.groovy"</span>],
    <span class="pl-s1">main_class</span> <span class="pl-c1">=</span> <span class="pl-s">"examples.images.Binary"</span>,
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>groovy_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<h3 dir="auto"><a id="user-content-rust_image" class="anchor" aria-hidden="true" tabindex="-1" href="#rust_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>rust_image</h3>
<p dir="auto">To use <code>rust_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

# You *must* import the Rust rules before setting up the rust_image rules.
http_archive(
    name = &quot;rules_rust&quot;,
    # Replace with a real SHA256 checksum
    sha256 = &quot;{SHA256}&quot;
    # Replace with a real commit SHA
    strip_prefix = &quot;rules_rust-{HEAD}&quot;,
    urls = [&quot;https://github.com/bazelbuild/rules_rust/archive/{HEAD}.tar.gz&quot;],
)

load(&quot;@rules_rust//rust:repositories.bzl&quot;, &quot;rust_repositories&quot;)

rust_repositories()

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//rust:image.bzl&quot;,
    _rust_image_repos = &quot;repositories&quot;,
)

_rust_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c"># You *must* import the Rust rules before setting up the rust_image rules.</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_rust"</span>,
    <span class="pl-c"># Replace with a real SHA256 checksum</span>
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"{SHA256}"</span>
    <span class="pl-c"># Replace with a real commit SHA</span>
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_rust-{HEAD}"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/bazelbuild/rules_rust/archive/{HEAD}.tar.gz"</span>],
)

<span class="pl-en">load</span>(<span class="pl-s">"@rules_rust//rust:repositories.bzl"</span>, <span class="pl-s">"rust_repositories"</span>)

<span class="pl-en">rust_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//rust:image.bzl"</span>,
    <span class="pl-s1">_rust_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_rust_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>rust_binary</code> to <code>rust_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//rust:image.bzl&quot;, &quot;rust_image&quot;)

rust_image(
    name = &quot;rust_image&quot;,
    srcs = [&quot;main.rs&quot;],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//rust:image.bzl"</span>, <span class="pl-s">"rust_image"</span>)

<span class="pl-en">rust_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rust_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"main.rs"</span>],
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>rust_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<h3 dir="auto"><a id="user-content-d_image" class="anchor" aria-hidden="true" tabindex="-1" href="#d_image"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>d_image</h3>
<p dir="auto">To use <code>d_image</code>, add the following to <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

# You *must* import the D rules before setting up the d_image rules.
http_archive(
    name = &quot;io_bazel_rules_d&quot;,
    # Replace with a real SHA256 checksum
    sha256 = &quot;{SHA256}&quot;
    # Replace with a real commit SHA
    strip_prefix = &quot;rules_d-{HEAD}&quot;,
    urls = [&quot;https://github.com/bazelbuild/rules_d/archive/{HEAD}.tar.gz&quot;],
)

load(&quot;@io_bazel_rules_d//d:d.bzl&quot;, &quot;d_repositories&quot;)

d_repositories()

load(
    &quot;@io_bazel_rules_docker//repositories:repositories.bzl&quot;,
    container_repositories = &quot;repositories&quot;,
)

container_repositories()

load(
    &quot;@io_bazel_rules_docker//d:image.bzl&quot;,
    _d_image_repos = &quot;repositories&quot;,
)

_d_image_repos()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-c"># You *must* import the D rules before setting up the d_image rules.</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"io_bazel_rules_d"</span>,
    <span class="pl-c"># Replace with a real SHA256 checksum</span>
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"{SHA256}"</span>
    <span class="pl-c"># Replace with a real commit SHA</span>
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_d-{HEAD}"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [<span class="pl-s">"https://github.com/bazelbuild/rules_d/archive/{HEAD}.tar.gz"</span>],
)

<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_d//d:d.bzl"</span>, <span class="pl-s">"d_repositories"</span>)

<span class="pl-en">d_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//repositories:repositories.bzl"</span>,
    <span class="pl-s1">container_repositories</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">container_repositories</span>()

<span class="pl-en">load</span>(
    <span class="pl-s">"@io_bazel_rules_docker//d:image.bzl"</span>,
    <span class="pl-s1">_d_image_repos</span> <span class="pl-c1">=</span> <span class="pl-s">"repositories"</span>,
)

<span class="pl-en">_d_image_repos</span>()</pre></div>
<p dir="auto">Note: See note about diamond dependencies in <a href="#setup">setup</a>
if you run into issues related to external repos after adding these
lines to your <code>WORKSPACE</code>.</p>
<p dir="auto">Then in your <code>BUILD</code> file, simply rewrite <code>d_binary</code> to <code>d_image</code> with the
following import:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//d:image.bzl&quot;, &quot;d_image&quot;)

d_image(
    name = &quot;d_image&quot;,
    srcs = [&quot;main.d&quot;],
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//d:image.bzl"</span>, <span class="pl-s">"d_image"</span>)

<span class="pl-en">d_image</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"d_image"</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">"main.d"</span>],
)</pre></div>
<p dir="auto">If you need to modify somehow the container produced by
<code>d_image</code> (e.g., <code>env</code>, <code>symlink</code>), see note above in
<a href="#overview-1">Language Rules Overview</a> about how to do this
and see <a href="#go_image-custom-base">go_image (custom base)</a> example.</p>
<blockquote>
<p dir="auto">NOTE: all application image rules support the <code>args</code> string_list
attribute.  If specified, they will be appended directly after the
container ENTRYPOINT binary name.</p>
</blockquote>
<h3 dir="auto"><a id="user-content-container_bundle" class="anchor" aria-hidden="true" tabindex="-1" href="#container_bundle"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_bundle</h3>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_bundle(
    name = &quot;bundle&quot;,
    images = {
        # A set of images to bundle up into a single tarball.
        &quot;gcr.io/foo/bar:bazz&quot;: &quot;:app&quot;,
        &quot;gcr.io/foo/bar:blah&quot;: &quot;//my:sidecar&quot;,
        &quot;gcr.io/foo/bar:booo&quot;: &quot;@your//random:image&quot;,
    }
)"><pre><span class="pl-en">container_bundle</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"bundle"</span>,
    <span class="pl-s1">images</span> <span class="pl-c1">=</span> {
        <span class="pl-c"># A set of images to bundle up into a single tarball.</span>
        <span class="pl-s">"gcr.io/foo/bar:bazz"</span>: <span class="pl-s">":app"</span>,
        <span class="pl-s">"gcr.io/foo/bar:blah"</span>: <span class="pl-s">"//my:sidecar"</span>,
        <span class="pl-s">"gcr.io/foo/bar:booo"</span>: <span class="pl-s">"@your//random:image"</span>,
    }
)</pre></div>
<h3 dir="auto"><a id="user-content-container_pull" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull</h3>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_pull(
    name = &quot;base&quot;,
    registry = &quot;gcr.io&quot;,
    repository = &quot;my-project/my-base&quot;,
    # 'tag' is also supported, but digest is encouraged for reproducibility.
    digest = &quot;sha256:deadbeef&quot;,
)"><pre><span class="pl-en">container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"base"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"my-project/my-base"</span>,
    <span class="pl-c"># 'tag' is also supported, but digest is encouraged for reproducibility.</span>
    <span class="pl-s1">digest</span> <span class="pl-c1">=</span> <span class="pl-s">"sha256:deadbeef"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@base//image</code>.</p>
<p dir="auto">To get the correct digest one can run <code>docker manifest inspect gcr.io/my-project/my-base:tag</code> once <a href="https://docs.docker.com/engine/reference/commandline/manifest_inspect" rel="nofollow">experimental docker cli features are enabled</a>.</p>
<p dir="auto">See <a href="#container_pull-custom-client-configuration">here</a> for an example of how
to use container_pull with custom docker authentication credentials.</p>
<h3 dir="auto"><a id="user-content-container_push" class="anchor" aria-hidden="true" tabindex="-1" href="#container_push"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_push</h3>
<p dir="auto">This target pushes on <code>bazel run :push_foo</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_push(
   name = &quot;push_foo&quot;,
   image = &quot;:foo&quot;,
   format = &quot;Docker&quot;,
   registry = &quot;gcr.io&quot;,
   repository = &quot;my-project/my-image&quot;,
   tag = &quot;dev&quot;,
)"><pre><span class="pl-en">container_push</span>(
   <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"push_foo"</span>,
   <span class="pl-s1">image</span> <span class="pl-c1">=</span> <span class="pl-s">":foo"</span>,
   <span class="pl-s1">format</span> <span class="pl-c1">=</span> <span class="pl-s">"Docker"</span>,
   <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io"</span>,
   <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"my-project/my-image"</span>,
   <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"dev"</span>,
)</pre></div>
<p dir="auto">We also support the <code>docker_push</code> (from <code>docker/docker.bzl</code>) and <code>oci_push</code>
(from <code>oci/oci.bzl</code>) aliases, which bake in the <code>format = "..."</code> attribute.</p>
<p dir="auto">See <a href="#container_push-custom-client-configuration">here</a> for an example of how
to use container_push with custom docker authentication credentials.</p>
<h3 dir="auto"><a id="user-content-container_push-custom-client-configuration" class="anchor" aria-hidden="true" tabindex="-1" href="#container_push-custom-client-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_push (Custom client configuration)</h3>
<p dir="auto">If you wish to use container_push using custom docker authentication credentials,
in <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# Download the rules_docker repository
http_archive(
    name = &quot;io_bazel_rules_docker&quot;,
    ...
)

# Load the macro that allows you to customize the docker toolchain configuration.
load(&quot;@io_bazel_rules_docker//toolchains/docker:toolchain.bzl&quot;,
    docker_toolchain_configure=&quot;toolchain_configure&quot;
)

docker_toolchain_configure(
  name = &quot;docker_config&quot;,
  # Replace this with a Bazel label to the config.json file. Note absolute or relative
  # paths are not supported. Docker allows you to specify custom authentication credentials
  # in the client configuration JSON file.
  # See https://docs.docker.com/engine/reference/commandline/cli/#configuration-files
  # for more details.
  client_config=&quot;@//path/to/docker:config.json&quot;,
)"><pre><span class="pl-c"># Download the rules_docker repository</span>
<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"io_bazel_rules_docker"</span>,
    ...
)

<span class="pl-c"># Load the macro that allows you to customize the docker toolchain configuration.</span>
<span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//toolchains/docker:toolchain.bzl"</span>,
    <span class="pl-s1">docker_toolchain_configure</span><span class="pl-c1">=</span><span class="pl-s">"toolchain_configure"</span>
)

<span class="pl-en">docker_toolchain_configure</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"docker_config"</span>,
  <span class="pl-c"># Replace this with a Bazel label to the config.json file. Note absolute or relative</span>
  <span class="pl-c"># paths are not supported. Docker allows you to specify custom authentication credentials</span>
  <span class="pl-c"># in the client configuration JSON file.</span>
  <span class="pl-c"># See https://docs.docker.com/engine/reference/commandline/cli/#configuration-files</span>
  <span class="pl-c"># for more details.</span>
  <span class="pl-s1">client_config</span><span class="pl-c1">=</span><span class="pl-s">"@//path/to/docker:config.json"</span>,
)</pre></div>
<p dir="auto">In <code>BUILD</code> file:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//container:container.bzl&quot;, &quot;container_push&quot;)

container_push(
   name = &quot;push_foo&quot;,
   image = &quot;:foo&quot;,
   format = &quot;Docker&quot;,
   registry = &quot;gcr.io&quot;,
   repository = &quot;my-project/my-image&quot;,
   tag = &quot;dev&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//container:container.bzl"</span>, <span class="pl-s">"container_push"</span>)

<span class="pl-en">container_push</span>(
   <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"push_foo"</span>,
   <span class="pl-s1">image</span> <span class="pl-c1">=</span> <span class="pl-s">":foo"</span>,
   <span class="pl-s1">format</span> <span class="pl-c1">=</span> <span class="pl-s">"Docker"</span>,
   <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"gcr.io"</span>,
   <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"my-project/my-image"</span>,
   <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"dev"</span>,
)</pre></div>
<h3 dir="auto"><a id="user-content-container_pull-dockerhub" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-dockerhub"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull (DockerHub)</h3>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_pull(
    name = &quot;official_ubuntu&quot;,
    registry = &quot;index.docker.io&quot;,
    repository = &quot;library/ubuntu&quot;,
    tag = &quot;14.04&quot;,
)"><pre><span class="pl-en">container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"official_ubuntu"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"index.docker.io"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"library/ubuntu"</span>,
    <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"14.04"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@official_ubuntu//image</code>.</p>
<h3 dir="auto"><a id="user-content-container_pull-quayio" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-quayio"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull (Quay.io)</h3>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_pull(
    name = &quot;etcd&quot;,
    registry = &quot;quay.io&quot;,
    repository = &quot;coreos/etcd&quot;,
    tag = &quot;latest&quot;,
)"><pre><span class="pl-en">container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"etcd"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"quay.io"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"coreos/etcd"</span>,
    <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"latest"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@etcd//image</code>.</p>
<h3 dir="auto"><a id="user-content-container_pull-bintrayio" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-bintrayio"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull (Bintray.io)</h3>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_pull(
    name = &quot;artifactory&quot;,
    registry = &quot;docker.bintray.io&quot;,
    repository = &quot;jfrog/artifactory-pro&quot;,
)"><pre><span class="pl-en">container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"artifactory"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"docker.bintray.io"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"jfrog/artifactory-pro"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@artifactory//image</code>.</p>
<h3 dir="auto"><a id="user-content-container_pull-gitlab" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-gitlab"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull (Gitlab)</h3>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="container_pull(
    name = &quot;gitlab&quot;,
    registry = &quot;registry.gitlab.com&quot;,
    repository = &quot;username/project/image&quot;,
    tag = &quot;tag&quot;,
)"><pre><span class="pl-en">container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gitlab"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"registry.gitlab.com"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"username/project/image"</span>,
    <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"tag"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@gitlab//image</code>.</p>
<h3 dir="auto"><a id="user-content-container_pull-custom-client-configuration" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-custom-client-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull (Custom client configuration)</h3>
<p dir="auto">If you specified a docker client directory using the <code>client_config</code> attribute
to the docker toolchain configuration described <a href="#setup">here</a>, you
can use a container_pull that uses the authentication credentials from the
specified docker client directory as follows:</p>
<p dir="auto">In <code>WORKSPACE</code>:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@io_bazel_rules_docker//toolchains/docker:toolchain.bzl&quot;,
    docker_toolchain_configure=&quot;toolchain_configure&quot;
)

# Configure the docker toolchain.
docker_toolchain_configure(
  name = &quot;docker_config&quot;,
  # Bazel label to a custom docker client config.json with
  # authentication credentials for registry.gitlab.com (used in this example).
  client_config=&quot;@//path/to/docker/client:config.json&quot;,
)

# Load the custom version of container_pull created by the docker toolchain
# configuration.
load(&quot;@docker_config//:pull.bzl&quot;, authenticated_container_pull=&quot;container_pull&quot;)

authenticated_container_pull(
    name = &quot;gitlab&quot;,
    registry = &quot;registry.gitlab.com&quot;,
    repository = &quot;username/project/image&quot;,
    tag = &quot;tag&quot;,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@io_bazel_rules_docker//toolchains/docker:toolchain.bzl"</span>,
    <span class="pl-s1">docker_toolchain_configure</span><span class="pl-c1">=</span><span class="pl-s">"toolchain_configure"</span>
)

<span class="pl-c"># Configure the docker toolchain.</span>
<span class="pl-en">docker_toolchain_configure</span>(
  <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"docker_config"</span>,
  <span class="pl-c"># Bazel label to a custom docker client config.json with</span>
  <span class="pl-c"># authentication credentials for registry.gitlab.com (used in this example).</span>
  <span class="pl-s1">client_config</span><span class="pl-c1">=</span><span class="pl-s">"@//path/to/docker/client:config.json"</span>,
)

<span class="pl-c"># Load the custom version of container_pull created by the docker toolchain</span>
<span class="pl-c"># configuration.</span>
<span class="pl-en">load</span>(<span class="pl-s">"@docker_config//:pull.bzl"</span>, <span class="pl-s1">authenticated_container_pull</span><span class="pl-c1">=</span><span class="pl-s">"container_pull"</span>)

<span class="pl-en">authenticated_container_pull</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"gitlab"</span>,
    <span class="pl-s1">registry</span> <span class="pl-c1">=</span> <span class="pl-s">"registry.gitlab.com"</span>,
    <span class="pl-s1">repository</span> <span class="pl-c1">=</span> <span class="pl-s">"username/project/image"</span>,
    <span class="pl-s1">tag</span> <span class="pl-c1">=</span> <span class="pl-s">"tag"</span>,
)</pre></div>
<p dir="auto">This can then be referenced in <code>BUILD</code> files as <code>@gitlab//image</code>.</p>
<p dir="auto"><strong>NOTE:</strong> This should only be used if a custom <code>client_config</code> was set. If you want
to use the DOCKER_CONFIG env variable or the default home directory
use the standard <code>container_pull</code> rule.</p>
<p dir="auto"><strong>NOTE:</strong> This will only work on systems with Python &gt;2.7.6</p>
<h2 dir="auto"><a id="user-content-python-tools" class="anchor" aria-hidden="true" tabindex="-1" href="#python-tools"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Python tools</h2>
<p dir="auto">Starting with Bazel 0.25.0 it's possible to configure python toolchains
for <code>rules_docker</code>.</p>
<p dir="auto">To use these features you need to enable the flags in the <code>.bazelrc</code>
file at the root of this project.</p>
<p dir="auto">Use of these features require a python toolchain to be registered.
<code>//py_images/image.bzl:deps</code> and <code>//py3_images/image.bzl:deps</code> register a
default python toolchain (<code>//toolchains:container_py_toolchain</code>)
that defines the path to python tools inside the default container used
for these rules.</p>
<h3 dir="auto"><a id="user-content-known-issues-1" class="anchor" aria-hidden="true" tabindex="-1" href="#known-issues-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Known issues</h3>
<p dir="auto">If you are using a custom base for <code>py_image</code> or <code>py3_image</code> builds that has
python tools installed in a different location to those defined in
<code>//toolchains:container_py_toolchain</code>, you will need to create a
toolchain that points to these paths and register it <em>before</em> the call to
<code>py*_images/image.bzl:deps</code> in your <code>WORKSPACE</code>.</p>
<p dir="auto">Use of python toolchain features, currently, only supports picking one
version of python for execution of host tools. <code>rules_docker</code> heavily depends
on execution of python host tools that are only compatible with python 2.
Flags in the recommended <code>.bazelrc</code> file force all host tools to use python 2.
If your project requires using host tools that are only compatible with
python 3 you will not be able to use these features at the moment. We
expect this issue to be resolved before use of python toolchain features
becomes the default.</p>
<h2 dir="auto"><a id="user-content-updating-the-distroless-base-images" class="anchor" aria-hidden="true" tabindex="-1" href="#updating-the-distroless-base-images"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Updating the <code>distroless</code> base images.</h2>
<p dir="auto">The digest references to the <code>distroless</code> base images must be updated over time
to pick up bug fixes and security patches.  To facilitate this, the files
containing the digest references are generated by <code>tools/update_deps.py</code>.  To
update all of the dependencies, please run (from the root of the repository):</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="./update_deps.sh"><pre>./update_deps.sh</pre></div>
<p dir="auto">Image references should not be updated individually because these images have
shared layers and letting them diverge could result in sub-optimal push and pull
performance.</p>
<p dir="auto"><a name="user-content-container_pull"></a></p>
<h2 dir="auto"><a id="user-content-container_pull-1" class="anchor" aria-hidden="true" tabindex="-1" href="#container_pull-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_pull</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_pull">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_push"></a></p>
<h2 dir="auto"><a id="user-content-container_push-1" class="anchor" aria-hidden="true" tabindex="-1" href="#container_push-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_push</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_push">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_layer"></a></p>
<h2 dir="auto"><a id="user-content-container_layer" class="anchor" aria-hidden="true" tabindex="-1" href="#container_layer"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_layer</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_layer">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_image"></a></p>
<h2 dir="auto"><a id="user-content-container_image-1" class="anchor" aria-hidden="true" tabindex="-1" href="#container_image-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_image</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_image">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_bundle"></a></p>
<h2 dir="auto"><a id="user-content-container_bundle-1" class="anchor" aria-hidden="true" tabindex="-1" href="#container_bundle-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_bundle</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_bundle">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_import"></a></p>
<h2 dir="auto"><a id="user-content-container_import" class="anchor" aria-hidden="true" tabindex="-1" href="#container_import"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_import</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_import">docs/container.md</a></p>
<p dir="auto"><a name="user-content-container_load"></a></p>
<h2 dir="auto"><a id="user-content-container_load" class="anchor" aria-hidden="true" tabindex="-1" href="#container_load"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>container_load</h2>
<p dir="auto"><strong>MOVED</strong>: See <a href="/docs/container.md#container_load">docs/container.md</a></p>
<h2 dir="auto"><a id="user-content-adopters" class="anchor" aria-hidden="true" tabindex="-1" href="#adopters"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Adopters</h2>
<p dir="auto">Here's a (non-exhaustive) list of companies that use <code>rules_docker</code> in production. Don't see yours? <a href="https://github.com/bazelbuild/rules_docker/edit/master/README.md">You can add it in a PR!</a></p>
<ul dir="auto">
<li><a href="https://github.com/amaizfinance">Amaiz</a></li>
<li><a href="https://auradevices.io/" rel="nofollow">Aura Devices</a></li>
<li><a href="https://usebutton.com" rel="nofollow">Button</a></li>
<li><a href="https://www.dominodatalab.com/" rel="nofollow">Domino Data Lab</a></li>
<li><a href="https://canva.com" rel="nofollow">Canva</a></li>
<li><a href="https://www.etsy.com" rel="nofollow">Etsy</a></li>
<li><a href="https://evertz.com/" rel="nofollow">Evertz</a></li>
<li><a href="https://www.jetstack.io/" rel="nofollow">Jetstack</a></li>
<li><a href="https://github.com/kubernetes-sigs/k8s-container-image-promoter">Kubernetes Container Image Promoter</a></li>
<li><a href="https://nordstrom.com" rel="nofollow">Nordstrom</a></li>
<li><a href="https://github.com/kubernetes/test-infra/tree/master/prow">Prow</a></li>
<li><a href="https://www.tink.com" rel="nofollow">Tink</a></li>
<li><a href="https://www.wix.com" rel="nofollow">Wix</a></li>
</ul>
</article></div>