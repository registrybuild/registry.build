<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Node Rules for Bazel (unsupported)</h1><a id="user-content-node-rules-for-bazel-unsupported" class="anchor" aria-label="Permalink: Node Rules for Bazel (unsupported)" href="#node-rules-for-bazel-unsupported"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Rules</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#node_binary">node_binary</a></td>
<td>Creates a node binary.</td>
</tr>
<tr>
<td><a href="#node_library">node_library</a></td>
<td>Groups node.js sources and deps together.</td>
</tr>
<tr>
<td><a href="#npm_library">npm_library</a></td>
<td>Defines an external npm module.</td>
</tr>
<tr>
<td><a href="#node_internal_module">node_internal_module</a></td>
<td>Create an internal node module that can be required as <code>require('module_name')</code>.</td>
</tr>
<tr>
<td><a href="#webpack_build">webpack_build</a></td>
<td>Build JS/CSS/etc with webpack.</td>
</tr>
<tr>
<td><a href="#node_build">node_build</a></td>
<td>Build JS/CSS/etc with a node binary.</td>
</tr>
<tr>
<td><a href="#mocha_test">mocha_test</a></td>
<td>Defines a node test that uses mocha.</td>
</tr>
<tr>
<td><a href="#node_test">node_test</a></td>
<td>Defines a basic node test.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Overview</h2><a id="user-content-overview" class="anchor" aria-label="Permalink: Overview" href="#overview"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">These rules are a public copy of what we're using at <a href="https://www.dropbox.com" rel="nofollow">Dropbox</a>. We
open sourced them because we think the community will benefit from
seeing how we've done things, but they are not supported. Pull
requests are welcome, though!</p>
<p dir="auto">We encourage you use the officially sanctioned
<a href="https://github.com/bazelbuild/rules_nodejs">nodejs</a> or
<a href="https://github.com/bazelbuild/rules_typescript">typescript</a> rules instead, if possible!</p>
<p dir="auto">A brief overview:</p>
<ul dir="auto">
<li>
<p dir="auto"><a href="#node_binary">node_binary</a>, <a href="#node_library">node_library</a>, <a href="#mocha_test">mocha_test</a>, <a href="#node_test">node_test</a> all work
the way you would expect them to.</p>
</li>
<li>
<p dir="auto"><a href="#npm_library">npm_library</a> downloads npm modules from the public npm repository. We
have a fair amount of tooling within Dropbox to support this rule,
with a private mirror and way to generate <code>npm_library</code> rules.
Simpler versions of those tools are included in
<a href="https://github.com/dropbox/rules_node/tree/master/node/tools/npm">node/tools/npm</a>. If you're using this rule for
serious development, you should replace the <code>npm_installer</code> with
something that pulls from an internal mirror.</p>
</li>
<li>
<p dir="auto"><a href="#webpack_build">webpack_build</a> uses webpack to build js/css files. Making the
experience of using webpack better within Dropbox was one of the
reasons we wrote these rules.</p>
</li>
<li>
<p dir="auto"><a href="#node_internal_module">node_internal_module</a> is used to create an "internal" node module
so that you can easily share code without having to upload it to
npm.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Design decisions</h3><a id="user-content-design-decisions" class="anchor" aria-label="Permalink: Design decisions" href="#design-decisions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto">As much as possible, we try to create a "normal" node environment
in the runfiles for node binaries. This simplifies debugging (it's
easier to create test cases without Bazel) and reduces the learning
curve for node developers.</p>
</li>
<li>
<p dir="auto">We use the <code>--preserve-symlinks</code> so that node doesn't get the
realpath of the file and look up the node_modules outside of its
runfiles.</p>
</li>
<li>
<p dir="auto">The <code>node_modules</code> folder is created in the runfiles and is placed
in the package directory that contains the <code>node_binary</code> target.
This simplifies things because you can have the <code>main</code> for a binary
be inside its <code>node_modules</code>. For example:</p>
</li>
</ul>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="node_binary(
    name = 'webpack_bin',
    main = 'node_modules/webpack/bin/webpack.js',
    deps = ['//npm/webpack'],
)"><pre><span class="pl-en">node_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">'webpack_bin'</span>,
    <span class="pl-s1">main</span> <span class="pl-c1">=</span> <span class="pl-s">'node_modules/webpack/bin/webpack.js'</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [<span class="pl-s">'//npm/webpack'</span>],
)</pre></div>
<ul dir="auto">
<li>
<p dir="auto">The <code>contents</code> attr for <code>npm_library</code> is a list of strings that are
turned into files instead of a list of labels because files have
fewer character restrictions.</p>
</li>
<li>
<p dir="auto">Compiled node modules are not currently supported.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Examples</h3><a id="user-content-examples" class="anchor" aria-label="Permalink: Examples" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See <a href="https://github.com/dropbox/rules_node/tree/master/examples">examples</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Setup</h2><a id="user-content-setup" class="anchor" aria-label="Permalink: Setup" href="#setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">First you must <a href="https://docs.bazel.build/versions/master/install.html" rel="nofollow">install</a> Bazel.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Linux</h3><a id="user-content-linux" class="anchor" aria-label="Permalink: Linux" href="#linux"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For Linux, you must add the following to your <code>WORKSPACE</code> file:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:git.bzl&quot;, &quot;git_repository&quot;)

git_repository(
    name = &quot;org_dropbox_rules_node&quot;,
    remote = &quot;https://github.com/dropbox/rules_node.git&quot;,
    commit = &quot;{HEAD}&quot;,
)

load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_repositories&quot;)

node_repositories()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:git.bzl"</span>, <span class="pl-s">"git_repository"</span>)

<span class="pl-en">git_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"org_dropbox_rules_node"</span>,
    <span class="pl-s1">remote</span> <span class="pl-c1">=</span> <span class="pl-s">"https://github.com/dropbox/rules_node.git"</span>,
    <span class="pl-s1">commit</span> <span class="pl-c1">=</span> <span class="pl-s">"{HEAD}"</span>,
)

<span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_repositories"</span>)

<span class="pl-en">node_repositories</span>()</pre></div>
<p dir="auto">This will pull in node v6.11.1 built for linux-x64. If you want to use
another version of node, you should pass <code>omit_nodejs=True</code> and define
another version of <code>nodejs</code> in your <code>WORKSPACE</code> file.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">macOS</h3><a id="user-content-macos" class="anchor" aria-label="Permalink: macOS" href="#macos"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">NOTE: These rules have only been tested on Linux.</p>
<p dir="auto">For macOS, you must add the following to your <code>WORKSPACE</code> file:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:git.bzl&quot;, &quot;git_repository&quot;)
load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

git_repository(
    name = &quot;org_dropbox_rules_node&quot;,
    remote = &quot;https://github.com/dropbox/rules_node.git&quot;,
    commit = &quot;{HEAD}&quot;,
)

load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_repositories&quot;, &quot;NODEJS_BUILD_FILE_CONTENT&quot;)

node_repositories(omit_nodejs=True)

http_archive(
    name = &quot;nodejs&quot;,
    url = &quot;https://nodejs.org/dist/v6.11.1/node-v6.11.1-darwin-x64.tar.gz&quot;,
    strip_prefix = &quot;node-v6.11.1-darwin-x64&quot;,
    sha256 = &quot;a2b839259089ef26f20c17864ff5ce9cd1a67e841be3d129b38d288b45fe375b&quot;,
    build_file_content = NODEJS_BUILD_FILE_CONTENT,
)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:git.bzl"</span>, <span class="pl-s">"git_repository"</span>)
<span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-en">git_repository</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"org_dropbox_rules_node"</span>,
    <span class="pl-s1">remote</span> <span class="pl-c1">=</span> <span class="pl-s">"https://github.com/dropbox/rules_node.git"</span>,
    <span class="pl-s1">commit</span> <span class="pl-c1">=</span> <span class="pl-s">"{HEAD}"</span>,
)

<span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_repositories"</span>, <span class="pl-s">"NODEJS_BUILD_FILE_CONTENT"</span>)

<span class="pl-en">node_repositories</span>(<span class="pl-s1">omit_nodejs</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)

<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"nodejs"</span>,
    <span class="pl-s1">url</span> <span class="pl-c1">=</span> <span class="pl-s">"https://nodejs.org/dist/v6.11.1/node-v6.11.1-darwin-x64.tar.gz"</span>,
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"node-v6.11.1-darwin-x64"</span>,
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"a2b839259089ef26f20c17864ff5ce9cd1a67e841be3d129b38d288b45fe375b"</span>,
    <span class="pl-s1">build_file_content</span> <span class="pl-c1">=</span> <span class="pl-v">NODEJS_BUILD_FILE_CONTENT</span>,
)</pre></div>
<p dir="auto">This will pull in node v6.11.1 built for macOS.</p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Rules</h1><a id="user-content-rules" class="anchor" aria-label="Permalink: Rules" href="#rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>node_binary</code></h2><a id="user-content-node_binary" class="anchor" aria-label="Permalink: node_binary" href="#node_binary"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_binary&quot;)
node_binary(name, main, srcs, deps, data, extra_args, node, max_old_memory, expose_gc)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_binary"</span>)
<span class="pl-en">node_binary</span>(<span class="pl-s1">name</span>, <span class="pl-s1">main</span>, <span class="pl-s1">srcs</span>, <span class="pl-s1">deps</span>, <span class="pl-s1">data</span>, <span class="pl-s1">extra_args</span>, <span class="pl-s1">node</span>, <span class="pl-s1">max_old_memory</span>, <span class="pl-s1">expose_gc</span>)</pre></div>
<p dir="auto">Creates a node binary, which is an executable Node program consisting
of a collection of <code>.js</code> source files.</p>
<p dir="auto">Node binaries are created using <code>--preserve-symlinks</code>.</p>
<p dir="auto">One quirk of this rule is that if your script uses the pattern:</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="  if (require.main === module) {"><pre>  <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-en">require</span><span class="pl-kos">.</span><span class="pl-c1">main</span> <span class="pl-c1">===</span> <span class="pl-smi">module</span><span class="pl-kos">)</span> <span class="pl-kos">{</span><span class="pl-kos"></span></pre></div>
<p dir="auto">to only execute something if the node script is the "main" script,
you'll need to modify it to check <code>BAZEL_NODE_MAIN_ID</code> against the
module id instead, like this:</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="  if (process.env['BAZEL_NODE_MAIN_ID'] === module.id || require.main === module) {"><pre>  <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">process</span><span class="pl-kos">.</span><span class="pl-c1">env</span><span class="pl-kos">[</span><span class="pl-s">'BAZEL_NODE_MAIN_ID'</span><span class="pl-kos">]</span> <span class="pl-c1">===</span> <span class="pl-smi">module</span><span class="pl-kos">.</span><span class="pl-c1">id</span> <span class="pl-c1">||</span> <span class="pl-en">require</span><span class="pl-kos">.</span><span class="pl-c1">main</span> <span class="pl-c1">===</span> <span class="pl-smi">module</span><span class="pl-kos">)</span> <span class="pl-kos">{</span><span class="pl-kos"></span></pre></div>
<p dir="auto">All node modules that this rule depends on, direct and transitive, end
up flattened in <code>{package-directory}/node_modules</code>, where
<code>package-directory</code> is the directory that the node_binary target
is it. This means that, across all of your transitive dependencies
tracked by Bazel, you can't depend on different versions of the same
node module. (This does not apply to transitive dependencies of
npm_library rules, which are not tracked by Bazel.)</p>
<p dir="auto">The environmental variable <code>NODE_PATH</code> is set to
<code>{package-directory}/node_modules</code> so that all the files that end up
running can find all the included node modules.</p>
<p dir="auto">One side-effect of that is that node libraries have access to all the
transitive dependencies for the node binary that depends on them.</p>
<p dir="auto">Examples:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="node_binary(
    name = 'mybin',
    srcs = [
        'mybin.js',
    ],
    main = 'mybin.js',
    deps = [
        '//npm/loose-envify',
        '//npm/minimist',
        '//npm/mkdirp',
    ],
)"><pre><span class="pl-en">node_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">'mybin'</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [
        <span class="pl-s">'mybin.js'</span>,
    ],
    <span class="pl-s1">main</span> <span class="pl-c1">=</span> <span class="pl-s">'mybin.js'</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-s">'//npm/loose-envify'</span>,
        <span class="pl-s">'//npm/minimist'</span>,
        <span class="pl-s">'//npm/mkdirp'</span>,
    ],
)</pre></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="node_library(
    name = 'lib',
    srcs = ['lib.js'],
    deps = [
        '//npm/mkdirp',
    ],
)

node_binary(
    name = 'bin',
    srcs = ['bin.js'],
    deps = [
        ':lib',
    ],
)"><pre><span class="pl-en">node_library</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">'lib'</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">'lib.js'</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-s">'//npm/mkdirp'</span>,
    ],
)

<span class="pl-en">node_binary</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">'bin'</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> [<span class="pl-s">'bin.js'</span>],
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-s">':lib'</span>,
    ],
)</pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments" class="anchor" aria-label="Permalink: Arguments" href="#arguments"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>main:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; required) The name of the source file that is the main entry point of the
application.</p>
</li>
<li>
<p dir="auto"><strong>srcs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of source files that are processed to create the target.</p>
</li>
<li>
<p dir="auto"><strong>deps:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of other libraries included in the binary target.</p>
</li>
<li>
<p dir="auto"><strong>data:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of files needed by this binary at runtime.</p>
</li>
<li>
<p dir="auto"><strong>extra_args:</strong> (List of strings; optional) Command line arguments that bazel will pass to the target when it
is executed either by the <code>run</code> command or as a test. These arguments
are passed before the ones that are specified on the <code>bazel run</code> or
<code>bazel test</code> command line.</p>
</li>
<li>
<p dir="auto"><strong>node:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; defaults to <code>@nodejs//:node</code>) The node binary used to run the binary. Must be greater than 6.2.0.</p>
</li>
<li>
<p dir="auto"><strong>max_old_memory:</strong> (Integer; optional) Node, by default, doesn't run its garbage collector on old space
until a maximum old space size limit is reached. This overrides the default (of around 1.4gb)
with the provided value in MB.</p>
</li>
<li>
<p dir="auto"><strong>expose_gc:</strong> (Boolean; optional) Expose <code>global.gc()</code> in the node process to allow manual requests for
garbage collection.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>node_library</code></h2><a id="user-content-node_library" class="anchor" aria-label="Permalink: node_library" href="#node_library"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_library&quot;)
node_library(name, srcs, deps, data)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_library"</span>)
<span class="pl-en">node_library</span>(<span class="pl-s1">name</span>, <span class="pl-s1">srcs</span>, <span class="pl-s1">deps</span>, <span class="pl-s1">data</span>)</pre></div>
<p dir="auto">Groups node.js sources and deps together. Similar to <a href="https://docs.bazel.build/versions/master/be/python.html#py_library" rel="nofollow">py_library</a> rules.</p>
<p dir="auto"><strong>NOTE:</strong> This does not create an internal module that you can then <code>require</code>. For that, you need to use <a href="#node_internal_module">node_internal_module</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-1" class="anchor" aria-label="Permalink: Arguments" href="#arguments-1"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>srcs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of source files that are processed to create the target.</p>
</li>
<li>
<p dir="auto"><strong>deps:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of other libraries or node modules needed to be linked into
the target library.</p>
</li>
<li>
<p dir="auto"><strong>data:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of files needed by this library at runtime.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>npm_library</code></h2><a id="user-content-npm_library" class="anchor" aria-label="Permalink: npm_library" href="#npm_library"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;npm_library&quot;)
npm_library(name, npm_req, no_import_main_test, shrinkwrap, contents,
            npm_installer, npm_installer_args)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"npm_library"</span>)
<span class="pl-en">npm_library</span>(<span class="pl-s1">name</span>, <span class="pl-s1">npm_req</span>, <span class="pl-s1">no_import_main_test</span>, <span class="pl-s1">shrinkwrap</span>, <span class="pl-s1">contents</span>,
            <span class="pl-s1">npm_installer</span>, <span class="pl-s1">npm_installer_args</span>)</pre></div>
<p dir="auto">Defines an external npm module.</p>
<p dir="auto">This rule should usually be generated using <code>//node/tools/npm:gen_build_npm</code>, like this:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel run @org_dropbox_rules_node//node/tools/npm:gen_build_npm -- my-module@1.2.3 ~/myrepo/npm/my-module"><pre>bazel run @org_dropbox_rules_node//node/tools/npm:gen_build_npm -- my-module@1.2.3 <span class="pl-k">~</span>/myrepo/npm/my-module</pre></div>
<p dir="auto">The module and its dependencies are downloaded using <code>npm_installer</code>.</p>
<p dir="auto">All of the module's dependencies are declared in the shrinkwrap but
aren't known by Bazel. This is to work around Bazel's restrictions on
circular dependencies, which are commonplace in the node ecosystem. By
doing things this way, Bazel will know about your direct <code>npm</code>
dependencies, but not your indirect dependencies.</p>
<p dir="auto">One restriction that this rule places on it's output is that all
the files output must either be in the module's directory or in
'.bin'. E.g. if the module is named <code>module-name</code>, then this list
of contents is legal:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="contents = [
    'module-name/src/something.js',
    '.bin/some-binary',
]"><pre class="notranslate"><code>contents = [
    'module-name/src/something.js',
    '.bin/some-binary',
]
</code></pre></div>
<p dir="auto">But this list of contents is not:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="contents = [
    'module-name/src/something.js',
    'another-modules/something-else.js',
]"><pre class="notranslate"><code>contents = [
    'module-name/src/something.js',
    'another-modules/something-else.js',
]
</code></pre></div>
<p dir="auto">This allows us to be reasonably sure that any two modules can be
used together (except when '.bin' has conflicts, which should be
rare).</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-2" class="anchor" aria-label="Permalink: Arguments" href="#arguments-2"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>npm_req:</strong> (String; required) The npm string used to download this module. Must be in the form <code>module-name@1.2.3</code>.</p>
</li>
<li>
<p dir="auto"><strong>no_import_main_test:</strong> (Boolean; defaults to <code>False</code>) Don't test that the npm library can be required as if it has a main file.</p>
<p dir="auto">We test that all imports can be imported like: <code>require('module')</code>. For some imports that don't
have a <code>main</code> js file to execute, this import will fail. For example, <code>@types/</code> npm modules will
fail. Set this to True to disable that check.</p>
<p dir="auto">NOTE: This rule will still generate a test to make sure that module version is correct.</p>
</li>
<li>
<p dir="auto"><strong>shrinkwrap:</strong> (String; required) The shrinkwrap file that lists out all the node modules to install. Should usually be <code>npm-shrinkwrap.json</code>.</p>
</li>
<li>
<p dir="auto"><strong>contents:</strong> (List of strings; required) All of the files included in the module.</p>
<p dir="auto">This should usually be autogenerated.</p>
<p dir="auto"><code>contents</code> is a string list instead of a label list to get around Bazel's restrictions on
label names, which are violated by npm packages pretty often. Some restrictions still exist,
like the restriction that file names cannot contain whitespace.</p>
</li>
<li>
<p dir="auto"><strong>npm_installer:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; defaults to `@org_dropbox_rules_node//node/tools/npm:install) The binary to use to install the npm modules.</p>
<p dir="auto">The default npm_installer downloads them from the public npm registry, but ideally you
should replace it with a binary that downloads from your private mirror.</p>
</li>
<li>
<p dir="auto"><strong>npm_installer_args:</strong> (List of strings; optional) Extra arguments to pass to <code>npm_installer</code>.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>node_internal_module</code></h2><a id="user-content-node_internal_module" class="anchor" aria-label="Permalink: node_internal_module" href="#node_internal_module"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_internal_module&quot;)
node_internal_module(name, srcs, deps, data, require_name, package_json, main)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_internal_module"</span>)
<span class="pl-en">node_internal_module</span>(<span class="pl-s1">name</span>, <span class="pl-s1">srcs</span>, <span class="pl-s1">deps</span>, <span class="pl-s1">data</span>, <span class="pl-s1">require_name</span>, <span class="pl-s1">package_json</span>, <span class="pl-s1">main</span>)</pre></div>
<p dir="auto">Create an internal node module that can be included in the <code>deps</code> for
other rules and that can be required as <code>require('module_name')</code>.</p>
<p dir="auto">The module name used to require the module (i.e.
<code>require('module_name')</code>) defaults to the name of the target.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-3" class="anchor" aria-label="Permalink: Arguments" href="#arguments-3"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>srcs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of source files that are processed to create the target.</p>
</li>
<li>
<p dir="auto"><strong>deps:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of other libraries included in the target.</p>
</li>
<li>
<p dir="auto"><strong>data:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of files needed by this target at runtime.</p>
</li>
<li>
<p dir="auto"><strong>require_name:</strong> (String; optional) The name for the internal node module. E.g.
if <code>require_name = "my-module"</code>, it should be used like
<code>require('my-module')</code>. The default is the target name.</p>
</li>
<li>
<p dir="auto"><strong>package_json:</strong> (String; optional) The package.json for the project. Cannot be
specified along with <code>main</code>.</p>
</li>
<li>
<p dir="auto"><strong>main:</strong> (String; optional) Defaults to the <code>main</code> field in the package.json or
<code>index.js</code> if that doesn't exist. Cannot be specified along with
<code>package_json</code>.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>webpack_build</code></h2><a id="user-content-webpack_build" class="anchor" aria-label="Permalink: webpack_build" href="#webpack_build"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;webpack_build&quot;)
webpack_build(name, srcs, deps, data, outs, extra_args, env, config,
               webpack_target)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"webpack_build"</span>)
<span class="pl-en">webpack_build</span>(<span class="pl-s1">name</span>, <span class="pl-s1">srcs</span>, <span class="pl-s1">deps</span>, <span class="pl-s1">data</span>, <span class="pl-s1">outs</span>, <span class="pl-s1">extra_args</span>, <span class="pl-s1">env</span>, <span class="pl-s1">config</span>,
               <span class="pl-s1">webpack_target</span>)</pre></div>
<p dir="auto">Build JS/CSS/etc with webpack.</p>
<p dir="auto">It's recommend that you use the internal node module <code>dbx-bazel-utils</code>
(<code>@org_dropbox_rules_node//node/dbx-bazel-utils</code>). If you use it like
this:</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="var dbxBazelUtils = require('dbx-bazel-utils');
var env = dbxBazelUtils.initBazelEnv(__dirname);"><pre><span class="pl-k">var</span> <span class="pl-s1">dbxBazelUtils</span> <span class="pl-c1">=</span> <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s">'dbx-bazel-utils'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-k">var</span> <span class="pl-s1">env</span> <span class="pl-c1">=</span> <span class="pl-s1">dbxBazelUtils</span><span class="pl-kos">.</span><span class="pl-en">initBazelEnv</span><span class="pl-kos">(</span><span class="pl-s1">__dirname</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">Then it will set the working directory to the directory that contains
webpack.config.js, which is usually what you want, and you should
output to the directory in <code>env.outputRoot</code>.</p>
<p dir="auto">If the webpack build is run outside of Bazel, then <code>env.outputRoot</code>
will be <code>__dirname</code>.</p>
<p dir="auto">Defaults to using webpack@3.4.1. You can specify your own webpack
target with <code>webpack_target</code>.</p>
<p dir="auto">Examples:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="# webpack_build/BUILD
load('@org_dropbox_rules_node//node:defs.bzl', 'webpack_build')

webpack_build(
    name = 'webpack_build',
    srcs = glob([
        'src/*.js',
    ]),
    outs = ['bundle.js'],
    config = 'webpack.config.js',
    deps = [
        '@org_dropbox_rules_node//node/dbx-bazel-utils',
    ],
)"><pre><span class="pl-c"># webpack_build/BUILD</span>
<span class="pl-en">load</span>(<span class="pl-s">'@org_dropbox_rules_node//node:defs.bzl'</span>, <span class="pl-s">'webpack_build'</span>)

<span class="pl-en">webpack_build</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">'webpack_build'</span>,
    <span class="pl-s1">srcs</span> <span class="pl-c1">=</span> <span class="pl-en">glob</span>([
        <span class="pl-s">'src/*.js'</span>,
    ]),
    <span class="pl-s1">outs</span> <span class="pl-c1">=</span> [<span class="pl-s">'bundle.js'</span>],
    <span class="pl-s1">config</span> <span class="pl-c1">=</span> <span class="pl-s">'webpack.config.js'</span>,
    <span class="pl-s1">deps</span> <span class="pl-c1">=</span> [
        <span class="pl-s">'@org_dropbox_rules_node//node/dbx-bazel-utils'</span>,
    ],
)</pre></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="// webpack_build/webpack.config.js
var path = require('path');
var dbxBazelUtils = require('dbx-bazel-utils');
var env = dbxBazelUtils.initBazelEnv(__dirname);

module.exports = {
  entry: ['entry.ts'],
  output: {
    filename: 'bundle.js',
    path: env.outputRoot,
  },
}"><pre><span class="pl-c">// webpack_build/webpack.config.js</span>
<span class="pl-k">var</span> <span class="pl-s1">path</span> <span class="pl-c1">=</span> <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s">'path'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-k">var</span> <span class="pl-s1">dbxBazelUtils</span> <span class="pl-c1">=</span> <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s">'dbx-bazel-utils'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-k">var</span> <span class="pl-s1">env</span> <span class="pl-c1">=</span> <span class="pl-s1">dbxBazelUtils</span><span class="pl-kos">.</span><span class="pl-en">initBazelEnv</span><span class="pl-kos">(</span><span class="pl-s1">__dirname</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-smi">module</span><span class="pl-kos">.</span><span class="pl-c1">exports</span> <span class="pl-c1">=</span> <span class="pl-kos">{</span>
  <span class="pl-c1">entry</span>: <span class="pl-kos">[</span><span class="pl-s">'entry.ts'</span><span class="pl-kos">]</span><span class="pl-kos">,</span>
  <span class="pl-c1">output</span>: <span class="pl-kos">{</span>
    <span class="pl-c1">filename</span>: <span class="pl-s">'bundle.js'</span><span class="pl-kos">,</span>
    <span class="pl-c1">path</span>: <span class="pl-s1">env</span><span class="pl-kos">.</span><span class="pl-c1">outputRoot</span><span class="pl-kos">,</span>
  <span class="pl-kos">}</span><span class="pl-kos">,</span>
<span class="pl-kos">}</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-4" class="anchor" aria-label="Permalink: Arguments" href="#arguments-4"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>srcs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of source files that are processed to create the target.</p>
</li>
<li>
<p dir="auto"><strong>deps:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of other libraries included in the target.</p>
</li>
<li>
<p dir="auto"><strong>data:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of files needed by this target at runtime.</p>
</li>
<li>
<p dir="auto"><strong>outs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; required) The list of files output by this rule.</p>
</li>
<li>
<p dir="auto"><strong>extra_args:</strong> (List of strings; optional) The list of additional args for this build.</p>
</li>
<li>
<p dir="auto"><strong>env:</strong> (Dict of strings; optional) Additional environmental variables to set for the build.</p>
</li>
<li>
<p dir="auto"><strong>config:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; required) The webpack.config.js file.</p>
</li>
<li>
<p dir="auto"><strong>webpack_target:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; defaults to <code>@org_dropbox_rules_node//npm/webpack</code>) The webpack target to use.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>node_build</code></h2><a id="user-content-node_build" class="anchor" aria-label="Permalink: node_build" href="#node_build"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_build&quot;)
node_build(name, outs, data, builder, extra_args, env, optimize_flag)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_build"</span>)
<span class="pl-en">node_build</span>(<span class="pl-s1">name</span>, <span class="pl-s1">outs</span>, <span class="pl-s1">data</span>, <span class="pl-s1">builder</span>, <span class="pl-s1">extra_args</span>, <span class="pl-s1">env</span>, <span class="pl-s1">optimize_flag</span>)</pre></div>
<p dir="auto">Build JS/CSS/etc with a node binary.</p>
<p dir="auto">This is a low-level rule, and is only recommended for completely
custom node builds. If you're using webpack, you should use the
<a href="#webpack_build">webpack_build</a> rule. If you're using another standard JS build system
(rollup, gulp, grunt, ...), you should write a macro that follows the
conventions of <a href="#webpack_build">webpack_build</a>.</p>
<p dir="auto">This rule does not have a <code>srcs</code> attribute because it expects all the
srcs needed for the build to be included in the <code>builder</code> binary.</p>
<p dir="auto">The environmental variable <code>BAZEL_OUTPUT_DIR</code> is set for all builds.
The <code>builder</code> binary should output to that directory.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-5" class="anchor" aria-label="Permalink: Arguments" href="#arguments-5"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>
<p dir="auto"><strong>name:</strong> (<a href="http://bazel.io/docs/build-ref.html#name" rel="nofollow">Name</a>; required) A unique name for this rule.</p>
</li>
<li>
<p dir="auto"><strong>data:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; optional) The list of files needed by this target at runtime.</p>
</li>
<li>
<p dir="auto"><strong>outs:</strong> (List of <a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">labels</a>; required) The list of files output by this rule.</p>
</li>
<li>
<p dir="auto"><strong>builder:</strong> (<a href="http://bazel.io/docs/build-ref.html#labels" rel="nofollow">Label</a>; required) The node binary used to build.</p>
</li>
<li>
<p dir="auto"><strong>env:</strong> (Dict of strings; optional) Additional environmental variables to set for the build.</p>
</li>
<li>
<p dir="auto"><strong>extra_args:</strong> (List of strings; optional) The list of additional args for this build.</p>
</li>
<li>
<p dir="auto"><strong>optimize_flag:</strong> (String; optional) The flag to pass to the build when it's run in "opt" mode.
If this flag is not defined, then no flag is passed in "opt" mode.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>mocha_test</code></h2><a id="user-content-mocha_test" class="anchor" aria-label="Permalink: mocha_test" href="#mocha_test"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;mocha_test&quot;)
mocha_test(name, srcs, deps, extra_args, mocha_target, chai_target, **kwargs)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"mocha_test"</span>)
<span class="pl-en">mocha_test</span>(<span class="pl-s1">name</span>, <span class="pl-s1">srcs</span>, <span class="pl-s1">deps</span>, <span class="pl-s1">extra_args</span>, <span class="pl-s1">mocha_target</span>, <span class="pl-s1">chai_target</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>)</pre></div>
<p dir="auto">Defines a node test that uses mocha. Takes the same args as
<code>node_binary</code>, except that you can't pass a <code>main</code> arg,
because mocha is run as the main js file.</p>
<p dir="auto">Includes dependencies on mocha@3.4.2 and chai@4.1.0 by default. You
can change those dependencies by setting <code>mocha_target</code> and
<code>chai_target</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-6" class="anchor" aria-label="Permalink: Arguments" href="#arguments-6"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Takes the same arguments as node_binary, except for the following:</p>
<ul dir="auto">
<li>
<p dir="auto"><strong>mocha_target:</strong> The target to use for including 'mocha'.</p>
</li>
<li>
<p dir="auto"><strong>chai_target:</strong> The target to use for including 'chai'.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto"><code>node_test</code></h2><a id="user-content-node_test" class="anchor" aria-label="Permalink: node_test" href="#node_test"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_test&quot;)
node_test(**kwargs)"><pre><span class="pl-en">load</span>(<span class="pl-s">"@org_dropbox_rules_node//node:defs.bzl"</span>, <span class="pl-s">"node_test"</span>)
<span class="pl-en">node_test</span>(<span class="pl-c1">**</span><span class="pl-s1">kwargs</span>)</pre></div>
<p dir="auto">Defines a basic node test. Succeeds if the program has a return code of
0, otherwise it fails.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Arguments</h3><a id="user-content-arguments-7" class="anchor" aria-label="Permalink: Arguments" href="#arguments-7"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Has the same arguments as <a href="#node_binary">node_binary</a>.</p>
</article></div>