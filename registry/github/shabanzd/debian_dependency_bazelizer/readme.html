<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><p dir="auto"><a href="https://github.com/shabanzd/debian_dependency_bazelizer/actions"><img src="https://camo.githubusercontent.com/26bd1cc64ba0b7b375bfa1ed739c13320ee5b0a652bc39f52485cf8f212a6d5b/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f616374696f6e732f776f726b666c6f772f7374617475732f73686162616e7a642f64656269616e5f646570656e64656e63795f62617a656c697a65722f63692e796d6c3f6272616e63683d6d61696e" alt="CI status" data-canonical-src="https://img.shields.io/github/actions/workflow/status/shabanzd/debian_dependency_bazelizer/ci.yml?branch=main" style="max-width: 100%;"></a>
<a href="https://github.com/shabanzd/debian_dependency_bazelizer/blob/main/LICENSE"><img src="https://camo.githubusercontent.com/0721bc19546cb4b5b6d9bdb9080da2db51ed01112a79642b3211f3b19537f99f/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6963656e73652f73686162616e7a642f64656269616e5f646570656e64656e63795f62617a656c697a6572" alt="MIT License" data-canonical-src="https://img.shields.io/github/license/shabanzd/debian_dependency_bazelizer" style="max-width: 100%;"></a></p>
<div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">debian_dependency_bazelizer</h1><a id="user-content-debian_dependency_bazelizer" class="anchor" aria-label="Permalink: debian_dependency_bazelizer" href="#debian_dependency_bazelizer"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>debian_dependency_bazelizer</code> takes an input list of debian packages, and turns them and their entire transitive dependency subgraphs into ready-to-use, fully bazelized modules (bzlmods). It also automatically references the bazelized modules in the internal registry of the repo. The <code>debian_dependency_bazelizer</code> in its current form is intended to be used in the root module, where a local private bazel registry makes sense.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Getting started</h2><a id="user-content-getting-started" class="anchor" aria-label="Permalink: Getting started" href="#getting-started"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Requirements</h3><a id="user-content-requirements" class="anchor" aria-label="Permalink: Requirements" href="#requirements"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In order to try the <code>debian_dependency_bazelizer</code>, you need a linux distribution running <code>apt</code> and <code>dpkg</code>. These are needed to manage and unpack the debian packages. In addition, <code>patchelf</code> needs to be installed (preferably version 0.10). You are recommended to have <a href="https://github.com/bazelbuild/bazelisk">bazelisk</a> installed as well.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Using the debian_dependency_bazelizer</h3><a id="user-content-using-the-debian_dependency_bazelizer" class="anchor" aria-label="Permalink: Using the debian_dependency_bazelizer" href="#using-the-debian_dependency_bazelizer"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In order to use the <code>debian_dependency_bazelizer</code>, please apply the following steps:</p>
<ul dir="auto">
<li>In the <code>MODULE.bazel</code>, add:</li>
</ul>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# since the debian dependency bazelizer is not in the BCR yet, downloading it
# and referencing it in your repository's bazel registry is assumed to be your task :D
# This should be nicer once the debian dependency bazelizer is uploaded to the BCR.
bazel_dep(name = &quot;debian_dependency_bazelizer&quot;, version = &quot;0.0.1&quot;)"><pre class="notranslate"><code># since the debian dependency bazelizer is not in the BCR yet, downloading it
# and referencing it in your repository's bazel registry is assumed to be your task :D
# This should be nicer once the debian dependency bazelizer is uploaded to the BCR.
bazel_dep(name = "debian_dependency_bazelizer", version = "0.0.1")
</code></pre></div>
<ul dir="auto">
<li>Add the following to the <code>BUILD</code> file:</li>
</ul>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="load(&quot;@debian_dependency_bazelizer//:run_bazelizer.bzl&quot;, &quot;run_bazelizer&quot;)
run_bazelizer()"><pre class="notranslate"><code>load("@debian_dependency_bazelizer//:run_bazelizer.bzl", "run_bazelizer")
run_bazelizer()
</code></pre></div>
<ul dir="auto">
<li>call <code>bazel run //:debian_dependency_bazelizer</code></li>
</ul>
<p dir="auto">The <code>debian_dependency_bazelizer</code> takes the following arguments:</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Registry path:</h3><a id="user-content-registry-path" class="anchor" aria-label="Permalink: Registry path:" href="#registry-path"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The registry path is the path to the local bazel registry. Don't forget to add this path to your .bazelrc as a fallback registry.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Input file</h3><a id="user-content-input-file" class="anchor" aria-label="Permalink: Input file" href="#input-file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The input file is the file containing the debian packages to be turned into bzlmods. Similar to:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# The input deb package needs to follow the template: 
# name:arch=version. Where name and arch are mandatory, and version is optional.
deb_package1:amd64=1.2.3
deb_package2:amd64=1.2.3"><pre class="notranslate"><code># The input deb package needs to follow the template: 
# name:arch=version. Where name and arch are mandatory, and version is optional.
deb_package1:amd64=1.2.3
deb_package2:amd64=1.2.3
</code></pre></div>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Config file</h3><a id="user-content-config-file" class="anchor" aria-label="Permalink: Config file" href="#config-file"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The storage config file must be written in compliance with one of the following schemas:</p>
<ul dir="auto">
<li>For the <code>AWS S3</code> storage:</li>
</ul>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
        &quot;download_url&quot;: &quot;https://mydownloadurl.com&quot;, // mandatory
        &quot;storage&quot;: {
            &quot;aws_s3&quot;: {
                &quot;bucket&quot;: &quot;mybucket&quot;, // mandatory
                &quot;credentials_profile&quot;: &quot;other-profile&quot;, // optional
                &quot;upload_url&quot;: &quot;https://pub-57066c0fbbb14beb942f046a28ab836b.r2.dev&quot; // mandatory
            }
        }
}"><pre><span class="pl-kos">{</span>
        <span class="pl-s">"download_url"</span>: <span class="pl-s">"https://mydownloadurl.com"</span><span class="pl-kos">,</span> <span class="pl-c">// mandatory</span>
        <span class="pl-s">"storage"</span>: <span class="pl-kos">{</span>
            <span class="pl-s">"aws_s3"</span>: <span class="pl-kos">{</span>
                <span class="pl-s">"bucket"</span>: <span class="pl-s">"mybucket"</span><span class="pl-kos">,</span> <span class="pl-c">// mandatory</span>
                <span class="pl-s">"credentials_profile"</span>: <span class="pl-s">"other-profile"</span><span class="pl-kos">,</span> <span class="pl-c">// optional</span>
                <span class="pl-s">"upload_url"</span>: <span class="pl-s">"https://pub-57066c0fbbb14beb942f046a28ab836b.r2.dev"</span> <span class="pl-c">// mandatory</span>
            <span class="pl-kos">}</span>
        <span class="pl-kos">}</span>
<span class="pl-kos">}</span></pre></div>
<ul dir="auto">
<li>For the <code>unknown</code> storage, which means that the files tars are dumped somewhere and the user will take care of uploading them to the storage of their choice:</li>
</ul>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
        &quot;download_url&quot;: &quot;https://mydownloadurl.com&quot;, // mandatory
        &quot;storage&quot;: {
            &quot;unknown&quot;: {
                &quot;path&quot;: &quot;mydir&quot; // mandatory
            }
        }
}"><pre><span class="pl-kos">{</span>
        <span class="pl-s">"download_url"</span>: <span class="pl-s">"https://mydownloadurl.com"</span><span class="pl-kos">,</span> <span class="pl-c">// mandatory</span>
        <span class="pl-s">"storage"</span>: <span class="pl-kos">{</span>
            <span class="pl-s">"unknown"</span>: <span class="pl-kos">{</span>
                <span class="pl-s">"path"</span>: <span class="pl-s">"mydir"</span> <span class="pl-c">// mandatory</span>
            <span class="pl-kos">}</span>
        <span class="pl-kos">}</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">An example usage can be found at: <a href="https://github.com/shabanzd/debian_dependency_bazelizer/tree/main/example">https://github.com/shabanzd/debian_dependency_bazelizer/tree/main/example</a></p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Summary</h2><a id="user-content-summary" class="anchor" aria-label="Permalink: Summary" href="#summary"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Up until <code>Bazel 5</code>, Bazel had not been able to resolve dependency graphs. As a result, Bazel needed a dependency manager to run during every build to build the transitive dependency graph of each dependency. Since this process needed to run early in the build, repository rules for package managers were developed and became the norm.</p>
<p dir="auto">Since <code>Bazel 6</code> and the introduction of <code>bzlmod</code>s, the approach described above is no longer the only option.</p>
<p dir="auto">The <code>debian_dependency_bazelizer</code> is a tool that takes input packages of different types, then turns those packages, in addition to their entire dependency graphs, into <code>bzlmod</code>s and references them in an internal <code>registry</code>. The freshly generated <code>bzlmod</code>s are ready to be resolved and consumed directly by <code>Bazel</code>. This eliminates the need to have package managers running in repository rules in order to resolve dependency graphs for <code>Bazel</code>. Another benefit the <code>debian_dependency_bazelizer</code> provides, is that the modules created by the tool access their transitive runtime dependencies directly from the runfiles; not from sysroot or a custom sysroot.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">What if every dependency was a bzlmod?</h3><a id="user-content-what-if-every-dependency-was-a-bzlmod" class="anchor" aria-label="Permalink: What if every dependency was a bzlmod?" href="#what-if-every-dependency-was-a-bzlmod"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Imagine every debian dependency, every python dependency ... etc has suddenly become a bazel module. What would happen?</p>
<ul dir="auto">
<li>
<p dir="auto">Package managers running as repository rules would no longer be needed. Meaning that dependencies wouldn't need to be installed over and over again in the early stages of each uncached build =&gt; more efficient builds.</p>
</li>
<li>
<p dir="auto">Bazel will be aware of all the versions being resolved =&gt; a more reliable and resilient bazel cache.</p>
</li>
<li>
<p dir="auto">Bazel would build a strict dependency subgraph for each dependency, and even provide a lock file representing these subgraphs =&gt; Easier and more reliable Software Bill Of Material (SBOM) for the modules.</p>
</li>
<li>
<p dir="auto">The input to actions are now <code>bzlmod</code>s representing individual dependencies, and not a third-party-package-manager lock file representing the entire dependency graph as one input. This allows for a more granual builds.</p>
</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">How can we make that happen?</h3><a id="user-content-how-can-we-make-that-happen" class="anchor" aria-label="Permalink: How can we make that happen?" href="#how-can-we-make-that-happen"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>Bzlmod</code> act cool, but in reality, they are anything with a <code>MODULE.bazel</code> file on top, and a few accessory files like an empty <code>WORKSPACE</code> and a <code>BUILD.bazel</code> file exposing the files and targets to be used by other modules.</p>
<p dir="auto">So in order to turn a debian package, say <code>deb_a</code>, into a module, all we need to do is: unpackage it, put a <code>MODULE.bazel</code>, empty <code>WORKSPACE</code> and a <code>BUILD.bazel</code> file on top, and store the folder containing everything somewhere in the repo (or archive it and upload it somewhere).</p>
<p dir="auto">Great, so now <code>deb_a</code> is a module. Problem is, it is likely that <code>deb_a</code> has transitive dependencies. In order for the <code>deb_a</code> module to fetch those dependencies, they also need to be modules. In other words, the entire subgraph needs to be built up of bazel modules. This means that the modularization process mentioned above should be done for the entire dependency subgraph.</p>
<p dir="auto">The <code>debian_dependency_bazelizer</code> tries to do exactly that; it processes the entire dependency graph and repackages it into modules. It also adds references to these modules in a local registry inside the repo. One can visualize the process as in the graph below</p>
<section class="js-render-needs-enrichment render-needs-enrichment position-relative" data-identity="ad9945c1-4e2f-4d57-a830-eff62e509e2a" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div class="js-render-enrichment-target" data-json="{&quot;data&quot;:&quot;graph LR;\n    A[Unpackage Dependency]--&amp;gt;B[Modularize Dependency];\n    B--&amp;gt;C[Reference Dependency in The Local Registry];\n    D[Next Dependency]--&amp;gt;A;\n    C --&amp;gt; D;\n&quot;}" data-plain="graph LR;
    A[Unpackage Dependency]--&gt;B[Modularize Dependency];
    B--&gt;C[Reference Dependency in The Local Registry];
    D[Next Dependency]--&gt;A;
    C --&gt; D;
" dir="auto">
    <div class="render-plaintext-hidden" dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">graph LR;
    A[Unpackage Dependency]--&gt;B[Modularize Dependency];
    B--&gt;C[Reference Dependency in The Local Registry];
    D[Next Dependency]--&gt;A;
    C --&gt; D;
</pre>
    </div>
  </div>
  <span class="js-render-enrichment-loader d-flex flex-justify-center flex-items-center width-full" style="min-height:100px" role="presentation">
    <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" data-view-component="true" class="octospinner mx-auto anim-rotate">
  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
  <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>
  </span>
</section>

<p dir="auto">Since it is not necessary for this tool to be implemented as a repository rule, I decided to do it entirely in python. This could make the code base easier to test and collaborate on.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Nerdy details / Contributor zone</h2><a id="user-content-nerdy-details--contributor-zone" class="anchor" aria-label="Permalink: Nerdy details / Contributor zone" href="#nerdy-details--contributor-zone"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The work is not done by adding a <code>MODULE.bazel</code> to a package and making sure that this module fetches the needed transitive dependencies. The pre-compiled C/C++ files in a package don't only expect their transitive runtime dependencies to exist on the system, but also to exist in a specific predefined location (<code>/bin/</code> for example). However, we don't want the transitive dependencies to be accessed directly from the system, we want the transitive deps in the runfiles to be the ones used ! This makes the problem way more exciting ðŸ˜‰</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">RPath patching</h3><a id="user-content-rpath-patching" class="anchor" aria-label="Permalink: RPath patching" href="#rpath-patching"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The problem above has a solution: RPaths! Rpaths are both searched before <code>LD_LIBRARY_PATH</code> (they take priority over <code>LD_LIBRARY_PATH</code>s) and they can be patched after the library has already been compiled. The RPath patching can be acheived using tools like patchelf, which is the tool we are using here. For more info: <a href="https://www.qt.io/blog/2011/10/28/rpath-and-runpath" rel="nofollow">https://www.qt.io/blog/2011/10/28/rpath-and-runpath</a></p>
<p dir="auto">But how does a dependency know the <code>rpath</code> of its transitive runtime deps ?</p>
<p dir="auto">I will answer this with an art work ðŸŽ¨ :</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8200878/235696979-3784c0a4-a2c8-42b4-a8d3-605a18f55652.png"><img width="1612" alt="Screenshot 2023-05-02 at 16 27 38" src="https://user-images.githubusercontent.com/8200878/235696979-3784c0a4-a2c8-42b4-a8d3-605a18f55652.png" style="max-width: 100%;"></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8200878/235697542-3f043ecf-8e0d-48b2-8824-08847f2a7489.png"><img width="1563" alt="Screenshot 2023-05-02 at 16 28 17" src="https://user-images.githubusercontent.com/8200878/235697542-3f043ecf-8e0d-48b2-8824-08847f2a7489.png" style="max-width: 100%;"></a></p>
<p dir="auto">So basically dependency B needs to be processed ahead of dependency A. It also needs to self-declare all the parent directories of all the ELF files in it. In other words, the dependency graph needs to be processed in a <strong>topological order</strong>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Code Workflow - Debian Only</h3><a id="user-content-code-workflow---debian-only" class="anchor" aria-label="Permalink: Code Workflow - Debian Only" href="#code-workflow---debian-only"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Now in the case of debian packages, the implementation details mentioned above can be translated into the following workflow:</p>
<section class="js-render-needs-enrichment render-needs-enrichment position-relative" data-identity="b072261c-9ebf-4d65-b7fa-d32737bac37f" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div class="js-render-enrichment-target" data-json="{&quot;data&quot;:&quot;graph TB;\n    A[Queue of deb dependencies, deb_q]--&amp;gt;|deb_dep|B{Visited?};\n    %% if visited, pop and process next\n    B--&amp;gt;|yes|C[Pop deb_q]--&amp;gt;A;\n    %% if not in visited, continue\n    B--&amp;gt;|no|D[Find transitive dependencies of deb_dep]--&amp;gt;E{Are all transitive dependencies processed? Meaning: did all transitive dependencies declare their rpaths?}--&amp;gt;|yes|F[Modularize and rpath patch deb_dep]--&amp;gt;C;\n    %% if not all transitive dep processed already, add them to queue\n    E--&amp;gt;|no|G[add unprocessed transitive deps to deb_q]--&amp;gt;A\n&quot;}" data-plain="graph TB;
    A[Queue of deb dependencies, deb_q]--&gt;|deb_dep|B{Visited?};
    %% if visited, pop and process next
    B--&gt;|yes|C[Pop deb_q]--&gt;A;
    %% if not in visited, continue
    B--&gt;|no|D[Find transitive dependencies of deb_dep]--&gt;E{Are all transitive dependencies processed? Meaning: did all transitive dependencies declare their rpaths?}--&gt;|yes|F[Modularize and rpath patch deb_dep]--&gt;C;
    %% if not all transitive dep processed already, add them to queue
    E--&gt;|no|G[add unprocessed transitive deps to deb_q]--&gt;A
" dir="auto">
    <div class="render-plaintext-hidden" dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">graph TB;
    A[Queue of deb dependencies, deb_q]--&gt;|deb_dep|B{Visited?};
    %% if visited, pop and process next
    B--&gt;|yes|C[Pop deb_q]--&gt;A;
    %% if not in visited, continue
    B--&gt;|no|D[Find transitive dependencies of deb_dep]--&gt;E{Are all transitive dependencies processed? Meaning: did all transitive dependencies declare their rpaths?}--&gt;|yes|F[Modularize and rpath patch deb_dep]--&gt;C;
    %% if not all transitive dep processed already, add them to queue
    E--&gt;|no|G[add unprocessed transitive deps to deb_q]--&gt;A
</pre>
    </div>
  </div>
  <span class="js-render-enrichment-loader d-flex flex-justify-center flex-items-center width-full" style="min-height:100px" role="presentation">
    <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" data-view-component="true" class="octospinner mx-auto anim-rotate">
  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
  <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>
  </span>
</section>

<p dir="auto">A more detailed view would look like:</p>
<section class="js-render-needs-enrichment render-needs-enrichment position-relative" data-identity="48242b61-6994-4f0e-95f8-1aa701f58c36" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div class="js-render-enrichment-target" data-json="{&quot;data&quot;:&quot;graph TB;\n    A[Queue of deb dependencies, deb_q]--&amp;gt;|deb_dep|B{Visited?};\n    %% if visited, pop and process next\n    B--&amp;gt;|yes|C[Pop deb_q]--&amp;gt;A;\n    %% if not in visited, check registry\n    B--&amp;gt;|no|D{In Registry?};\n    %% if in registry, retrieve and mark visited\n    D--&amp;gt;|yes|E[Retrieve info from egistry]--&amp;gt;F[Mark as Visited]--&amp;gt;C;\n    %% if not in registry, \n    D--&amp;gt;|no|G[apt-get download deb_dep_pinned_name] --&amp;gt;|get transitive deps|H[dpkg-deb -I deb_archive_path]--&amp;gt;|list files|I[dpkg -X deb_archive_path pkg_dir] --&amp;gt; J[get rpath directories]--&amp;gt;K{are all transitive dependency visited?};\n    %% if all transitive deps are visited =&amp;gt; edge =&amp;gt; rpath patch and modularize\n    K--&amp;gt;|yes|L[rpath patch ELF files in the package]--&amp;gt;M[Turn package into a module]--&amp;gt;N[Upload as an archive, or add to repo]--&amp;gt;O[reference the module in the registry]--&amp;gt;C;\n    %% if all transitive deps are visited =&amp;gt; process next\n    K--&amp;gt;|no|P[add all non-processed transitive deps to deb_q]--&amp;gt;A;\n&quot;}" data-plain="graph TB;
    A[Queue of deb dependencies, deb_q]--&gt;|deb_dep|B{Visited?};
    %% if visited, pop and process next
    B--&gt;|yes|C[Pop deb_q]--&gt;A;
    %% if not in visited, check registry
    B--&gt;|no|D{In Registry?};
    %% if in registry, retrieve and mark visited
    D--&gt;|yes|E[Retrieve info from egistry]--&gt;F[Mark as Visited]--&gt;C;
    %% if not in registry, 
    D--&gt;|no|G[apt-get download deb_dep_pinned_name] --&gt;|get transitive deps|H[dpkg-deb -I deb_archive_path]--&gt;|list files|I[dpkg -X deb_archive_path pkg_dir] --&gt; J[get rpath directories]--&gt;K{are all transitive dependency visited?};
    %% if all transitive deps are visited =&gt; edge =&gt; rpath patch and modularize
    K--&gt;|yes|L[rpath patch ELF files in the package]--&gt;M[Turn package into a module]--&gt;N[Upload as an archive, or add to repo]--&gt;O[reference the module in the registry]--&gt;C;
    %% if all transitive deps are visited =&gt; process next
    K--&gt;|no|P[add all non-processed transitive deps to deb_q]--&gt;A;
" dir="auto">
    <div class="render-plaintext-hidden" dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">graph TB;
    A[Queue of deb dependencies, deb_q]--&gt;|deb_dep|B{Visited?};
    %% if visited, pop and process next
    B--&gt;|yes|C[Pop deb_q]--&gt;A;
    %% if not in visited, check registry
    B--&gt;|no|D{In Registry?};
    %% if in registry, retrieve and mark visited
    D--&gt;|yes|E[Retrieve info from egistry]--&gt;F[Mark as Visited]--&gt;C;
    %% if not in registry, 
    D--&gt;|no|G[apt-get download deb_dep_pinned_name] --&gt;|get transitive deps|H[dpkg-deb -I deb_archive_path]--&gt;|list files|I[dpkg -X deb_archive_path pkg_dir] --&gt; J[get rpath directories]--&gt;K{are all transitive dependency visited?};
    %% if all transitive deps are visited =&gt; edge =&gt; rpath patch and modularize
    K--&gt;|yes|L[rpath patch ELF files in the package]--&gt;M[Turn package into a module]--&gt;N[Upload as an archive, or add to repo]--&gt;O[reference the module in the registry]--&gt;C;
    %% if all transitive deps are visited =&gt; process next
    K--&gt;|no|P[add all non-processed transitive deps to deb_q]--&gt;A;
</pre>
    </div>
  </div>
  <span class="js-render-enrichment-loader d-flex flex-justify-center flex-items-center width-full" style="min-height:100px" role="presentation">
    <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" data-view-component="true" class="octospinner mx-auto anim-rotate">
  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
  <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>
  </span>
</section>

</article></div>