<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">Bazel tar rule</h1><a id="user-content-bazel-tar-rule" class="anchor" aria-label="Permalink: Bazel tar rule" href="#bazel-tar-rule"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">General-purpose rule to create tar archives.</p>
<p dir="auto">Unlike <a href="https://github.com/bazelbuild/rules_pkg/blob/main/docs/latest.md#pkg_tar">pkg_tar from rules_pkg</a>:</p>
<ul dir="auto">
<li>It does not depend on any Python interpreter setup</li>
<li>The "manifest" specification is a mature public API and uses a compact tabular format, fixing
<a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="709081858" data-permission-text="Title is private" data-url="https://github.com/bazelbuild/rules_pkg/issues/238" data-hovercard-type="pull_request" data-hovercard-url="/bazelbuild/rules_pkg/pull/238/hovercard" href="https://github.com/bazelbuild/rules_pkg/pull/238">bazelbuild/rules_pkg#238</a></li>
<li>It doesn't rely custom program to produce the output, instead
we rely on the well-known C++ program <code>tar(1)</code>.
Specifically, we use the BSD variant of tar since it provides a means
of controlling mtimes, uid, symlinks, etc.</li>
</ul>
<p dir="auto">We also provide full control for tar'ring binaries including their runfiles.</p>
<p dir="auto">The <code>tar</code> binary is hermetic and fully statically-linked. See Design Notes below.</p>
<p dir="auto">This rule was originally developed within bazel-lib.
Thanks to all the contributors who made it possible!</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Remote cache and RBE</h2><a id="user-content-remote-cache-and-rbe" class="anchor" aria-label="Permalink: Remote cache and RBE" href="#remote-cache-and-rbe"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <code>Tar</code> mnemonic is used for actions that produce the tar file outputs.
Depending on the inputs provided, these can be very large.</p>
<p dir="auto">If you use Remote Build Execution, the tar files should generally be written to the remote cache,
and never downloaded to the host machine running Bazel (sometimes called "Build without the Bytes").
Subsequent actions or tests which use them as inputs will have to stage the files on an executor.
Be careful to tune the size of the remote cache to handle the artifacts you store.</p>
<p dir="auto">If you do NOT use Remote Build Execution, then you should avoid uploading the tar outputs to the remote cache.
It is commonly faster to re-run the <code>Tar</code> actions locally on the input files than to download a remote cache hit, especially if compression is not used.
Large tar files consume storage and network bandwidth of the cache, and can lead to overload.
Use a snippet like the following in <code>.bazelrc</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="# Avoid overloading the remote cache with tar outputs.
# See https://github.com/bazel-contrib/tar.bzl/blob/main/README.md#remote-cache-and-rbe
common --execution_requirements=Tar=+no-remote-cache"><pre class="notranslate"><code># Avoid overloading the remote cache with tar outputs.
# See https://github.com/bazel-contrib/tar.bzl/blob/main/README.md#remote-cache-and-rbe
common --execution_requirements=Tar=+no-remote-cache
</code></pre></div>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Examples</h2><a id="user-content-examples" class="anchor" aria-label="Permalink: Examples" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Migrate from <code>pkg_tar</code>: <a href="https://github.com/bazel-contrib/tar.bzl/blob/main/examples/migrate-rules_pkg/BUILD">https://github.com/bazel-contrib/tar.bzl/blob/main/examples/migrate-rules_pkg/BUILD</a></li>
<li>Look through our test suite: <a href="https://github.com/bazel-contrib/tar.bzl/blob/main/tar/tests/BUILD">https://github.com/bazel-contrib/tar.bzl/blob/main/tar/tests/BUILD</a></li>
</ul>
<p dir="auto">Note; this repository doesn't yet allow modes other than <code>create</code>, such as "append", "list", "update", "extract".
See <a href="https://registry.bazel.build/modules/rules_tar" rel="nofollow">https://registry.bazel.build/modules/rules_tar</a> for this.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">API docs</h2><a id="user-content-api-docs" class="anchor" aria-label="Permalink: API docs" href="#api-docs"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="https://registry.bazel.build/docs/tar.bzl#tar-tar-bzl" rel="nofollow">tar</a> Run BSD <code>tar(1)</code> to produce archives</li>
<li><a href="https://registry.bazel.build/docs/tar.bzl#tar-mtree-bzl" rel="nofollow">mtree</a> The intermediate manifest format <code>mtree(8)</code> describing a tar operation</li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Design notes</h2><a id="user-content-design-notes" class="anchor" aria-label="Permalink: Design notes" href="#design-notes"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>We start from libarchive, which is on the BCR: <a href="https://registry.bazel.build/modules/libarchive" rel="nofollow">https://registry.bazel.build/modules/libarchive</a></li>
<li>You could choose to register a toolchain that builds from source, but most users want a pre-built tar binary: <a href="https://github.com/aspect-build/bsdtar-prebuilt">https://github.com/aspect-build/bsdtar-prebuilt</a></li>
<li>This repo defines toolchain types</li>
</ol>
<ul dir="auto">
<li><code>@tar.bzl//tar/toolchain:type</code> for exec platform to use in build actions</li>
<li><code>@tar.bzl//tar/toolchain:target_type</code> for including a <code>tar</code> binary in the output tree</li>
</ul>
<ol dir="auto">
<li>We register a sensible default toolchain using the pre-built binary: <a href="https://github.com/bazel-contrib/tar.bzl/blob/main/tar/private/toolchain/toolchain.bzl">https://github.com/bazel-contrib/tar.bzl/blob/main/tar/private/toolchain/toolchain.bzl</a></li>
<li>Finally we provide a thin layer of starlark rule code for invoking <code>tar</code> within Bazel actions (aka. build steps)</li>
</ol>
</article></div>